  <!DOCTYPE html>
  <html lang="es">
  <head>
      <meta charset="UTF-8">
      <link rel="icon" href="prueba.png" type="image/png">
    
    <title>Registro - Pepsico Funza</title>
      <title>Registro - Pepsico Funza</title>
      <style>
          body {
            font-family: Arial, sans-serif;
            /* ‚úÖ FONDO DE IMAGEN */
            background-image: url('fondo.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            padding: 40px;
            min-height: 100vh;
          }
          
          .logo-container {
              position: absolute;
              top: 50px;
              left: 30px;
          }
          
          .logo-container img {
              width: 200px;
              height: auto;
          }
          
          form {
              background: white;
              padding: 20px;
              border-radius: 15px;
              box-shadow: 0 0 10px rgba(0,0,0,0.2);
              width: 550px;
              margin: auto;
          }
          
          .registro-vehiculo {
              border: 2px solid #C76E00;
              padding: 15px;
              margin-top: 20px;
              border-radius: 10px;
              position: relative;
          }
          
          .parada-group {
              border: 1px dashed #ced4da;
              padding: 10px;
              margin-top: 15px;
              border-radius: 5px;
          }
          
          .form-group-custom {
              margin-top: 15px;
              display: flex;
              flex-direction: column;
          }
          
          .btn-agregar-registro,
          .btn-agregar-parada-op {
              background-color: #cec000;
              color: rgb(12, 8, 8);
              border: none;
              cursor: pointer;
              margin-top: 15px;
              width: 100%;
              padding: 12px;
              border-radius: 8px;
              font-weight: bold;
          }
          
          .btn-agregar-registro:hover,
          .btn-agregar-parada-op:hover {
              background-color: #0056b3;
          }
          
          label {
              font-weight: bold;
              display: block;
              margin-top: 15px;
          }
          
          select, input, button {
              width: 100%;
              padding: 8px;
              margin-top: 8px;
              border-radius: 8px;
              border: 1px solid #170303;
          }
          
          .time-row {
              display: flex;
              gap: 10px;
              align-items: flex-start;
          }
          
          .time-row > div {
              flex-grow: 1;
              position: relative;
          }
          
          .time-display {
              display: block;
              margin-top: 5px;
              font-size: 0.85em;
              color: #155724;
              font-weight: bold;
          }
          
          .time-label {
              font-weight: bold;
              display: block;
              margin-top: 5px;
              color: #007bff;
          }
          
          button[type="submit"] {
              background-color: #001855;
              color: white;
              border: none;
              cursor: pointer;
              margin-top: 20px;
          }
          
          button[type="submit"]:hover {
              background-color: #0056b3;
          }
          
          .time-input-masked {
              text-align: center;
              font-size: 1.1em;
              letter-spacing: 2px;
          }
          
          .btn-eliminar {
              background-color: #8B0000 !important;
              width: auto !important;
              padding: 5px 10px !important;
              margin-top: 10px !important;
              border: none !important;
              color: white !important;
          }
          
          .btn-eliminar-registro {
              position: absolute;
              top: 10px;
              right: 10px;
              background-color: #8B0000 !important;
              color: white !important;
              border: none !important;
              padding: 5px 10px !important;
              cursor: pointer;
              font-size: 0.8em;
              width: auto;
          }
          
          .btn-detalles {
              /* position: absolute; */
              /* top: 10px; */
              /* right: 120px; */
              background-color: #856115 !important;
              color: white !important;
              border: none !important;
              padding: 5px 10px !important;
              cursor: pointer;
              font-size: 0.8em;
              width: auto;
              border-radius: 5px;
          }
          
          .btn-eliminar:hover {
              background-color: #c82333 !important;
          }
          
          .btn-detalles:hover {
              background-color: #0055aa !important;
          }
          
          .otro-input {
              margin-top: 5px;
              display: none;
          }
          
          .preview-foto img {
              max-width: 100%;
              max-height: 200px;
              border: 1px solid #ddd;
              border-radius: 8px;
              margin-top: 8px;
          }
          
          .btn-borrar-todo {
              background-color: #8B0000;
              color: white;
              margin-top: 20px;
              border: none;
              cursor: pointer;
              font-weight: bold;
          }
          /* ‚úÖ ESTILOS PARA RESUMEN DE PRODUCTOS ESCANEADOS */
  .resumen-productos-container {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    margin-top: 15px;
    border: 1px solid #dee2e6;
  }

  .resumen-productos-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 2px solid #001855;
  }

  .resumen-productos-title {
    color: #C76E00;
    font-weight: bold;
    font-size: 1.1em;
  }

  .total-cajas-badge {
    background: #001855;
    color: white;
    padding: 4px 12px;
    border-radius: 15px;
    font-weight: bold;
    font-size: 1.2em;
  }

  .productos-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    max-height: 250px;
    overflow-y: auto;
    display: block;
  }

  .productos-table th {
    background: #001855;
    color: white;
    padding: 10px 8px;
    text-align: left;
    font-size: 0.85em;
    position: sticky;
    top: 0;
  }

  .productos-table td {
    padding: 8px;
    border-bottom: 1px solid #e9ecef;
    font-size: 0.9em;
  }

  .productos-table tr:hover {
    background-color: #f1f3f5;
  }

  .producto-referencia {
    font-family: 'Courier New', monospace;
    font-size: 0.85em;
    color: #495057;
  }

  .producto-cantidad {
    font-weight: bold;
    color: #C76E00;
    text-align: center;
  }

  .no-productos {
    text-align: center;
    color: #6c757d;
    padding: 20px;
    font-style: italic;
  }

  .btn-limpiar-escaneo {
    background: #dc3545;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 5px;
    font-size: 0.85em;
    cursor: pointer;
    margin-top: 10px;
    display: block;
    width: 100%;
  }

  .btn-limpiar-escaneo:hover {
    background: #c82333;
    transform: scale(1.02);
    transition: all 0.2s;
  }

  @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
  }
      </style>

  </head>
  <body>
    <script>
    // ‚úÖ Reemplaza 'TU_API_KEY_REAL_AQUI' con tu clave real de ImgBB
    window.imgbbApiKey = 'e1d938a9ff4815f178c880552cd33a34';
  </script>
      <div class="logo-container">
          <img src="prueba.png" alt="Logo de la Empresa">
      </div>
      
      <h2 style="text-align:center;">FORMULARIO - PEPSICO</h2>
      
      <form name="formulario-pepsico">
          <input type="hidden" name="form-name" value="formulario-pepsico" />
          
          <label for="lugar">Lugar de operaci√≥n:</label>
          <select name="lugar" id="lugar" required onchange="actualizarCampos(); filtrarCoordinadores(); actualizarMuellesPorLugar();">
              <option value="">Seleccione una opci√≥n</option>
              <option value="Funza">Pepsico Funza</option>
              <option value="SantoDomingo">Santo Domingo</option> 
          </select>
          
          <!-- ‚úÖ CAMPO RESPONSABLE DE DILIGENCIAR -->
          <label for="responsable" style="margin-top: 15px;">Responsable de Diligenciar:</label>
          <input type="text" name="respo_diligen" id="responsable" placeholder="C√©dula"
                oninput="formatearCedula(this)"
                maxlength="14">

          <label for="lider">L√≠der Asignado:</label>
          <input type="text" name="lider_asignado" id="lider" placeholder="Primer Nombre y Primer Apellido">
          
          <!-- ‚úÖ COORDINADOR Y L√çDER PEPSICO EN LA MISMA L√çNEA -->
          <div style="display: flex; gap: 20px; align-items: flex-start; margin-bottom: 15px;">
            <!-- Coordinador Asignado -->
            <div style="flex: 1;">
              <label for="coordinador" style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Coordinador Asignado:</label>
              <select name="coordinador" id="coordinador" required onchange="manejarOtroCoordinador()"
                      style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; font-size: 1em; box-sizing: border-box;">
                <option value="">Seleccione coordinador</option>
                <!-- Opciones para Funza -->
                <option value="Jeison Aranda" data-lugar="Funza">Jeison Aranda</option>
                <option value="Julian Espitia" data-lugar="Funza">Julian Espitia</option>
                <!-- Opciones para Santo Domingo -->
                <option value="Olga Valdez" data-lugar="SantoDomingo">Olga Valdez</option>
                <option value="Arnold Ospina" data-lugar="SantoDomingo">Arnold Ospina</option>
                <option value="Jeison Aranda" data-lugar="SantoDomingo">Jeison Aranda</option>
                <option value="Leonor Nari√±o" data-lugar="SantoDomingo">Leonor Nari√±o</option>
                <option value="Javier Torres" data-lugar="SantoDomingo">Javier Torres</option>
                <option value="Ingrid Lisarazo" data-lugar="SantoDomingo">Ingrid Lisarazo</option>
                <option value="otro">Otro</option>
              </select>
              <input type="text" name="coordinador_otro" id="coordinador_otro" class="otro-input" placeholder="Especifique el coordinador"
                    style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; font-size: 1em; box-sizing: border-box; margin-top: 10px; display: none;">
            </div>
            
            <!-- L√≠der De Pepsico -->
            <div style="flex: 1;">
              <label for="lider_pepsico" style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">L√≠der De Pepsico:</label>
              <select name="lider_pepsico" id="lider_pepsico" required onchange="manejarOtroLiderPepsico()"
                      style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; font-size: 1em; box-sizing: border-box;">
                <option value="">Seleccione un l√≠der</option>
                <option value="Alejandro Ariza">Alejandro Ariza</option>
                <option value="Alejandro Monroy">Alejandro Monroy</option>
                <option value="Carlos Ruiz">Carlos Ruiz</option>
                <option value="Carlos Valencia">Carlos Valencia</option>
                <option value="otro">Otro</option>
              </select>
              <input type="text" name="lider_pepsico_otro" id="lider_pepsico_otro" class="otro-input" placeholder="Especifique el l√≠der de Pepsico"
                    style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; font-size: 1em; box-sizing: border-box; margin-top: 10px; display: none;">
            </div>
          </div>
          <!-- ‚úÖ FECHA Y TURNO EN LA MISMA L√çNEA -->
          <div style="display: flex; gap: 20px; align-items: flex-start; margin-bottom: 15px;">
            <div style="flex: 1;">
              <label for="fecha" style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Fecha:</label>
              <input type="date" name="fecha" id="fecha" required
                    style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; font-size: 1em; box-sizing: border-box;">
            </div>
            
            <div style="flex: 1;">
              <label for="turno" style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Turno Asignado:</label>
              <select name="turno" id="turno" required
                      style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; font-size: 1em; box-sizing: border-box;">
                <option value="">Seleccione un turno</option>
                <option value="Manana">Ma√±ana</option>
                <option value="Tarde">Tarde</option>
                <option value="Noche">Noche</option>
              </select>
            </div>
          </div>
          
          <hr style="margin-top: 25px; border-style: dotted;">
          
          <!-- SECCI√ìN: REGISTRO DE VEH√çCULOS -->
          <h3 style="text-align:center; font-size:1.3em; color:#74153b;">REGISTRO DE VEH√çCULOS</h3>
          <div id="vehiculos-contenedor"></div>
          <button type="button" class="btn-agregar-registro" onclick="agregarRegistroVehiculo()">
              ------------------------ + Registrar Nuevo Veh√≠culo ------------------------
          </button>
          
        
          <hr style="margin-top: 25px; border-style: dotted;">
          <h3 style="font-family: Arial, sans-serif; color: #983f03; text-align: center; text-transform: uppercase; margin: 20px 0;">Paradas De Operativas</h3>

  <button type="button" onclick="abrirParadasOperacion()"
          style="background: linear-gradient(135deg, #626e8e 0%, #68143a 100%); color: white; border: none; padding: 12px 20px; border-radius: 5px; font-weight: bold; cursor: pointer; margin: 15px 0; width: 100%; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
      üõë Paradas de Operaci√≥n
  </button>

  <!-- ‚úÖ CONTENEDOR OCULTO PARA PARADAS (se sincroniza con el overlay) -->
  <div id="operacion-contenedor" style="display: none;"></div>

  <!-- ‚úÖ OVERLAY/MODAL DE PARADAS DE OPERACI√ìN -->
  <div id="overlay-paradas-operacion" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 1000; justify-content: center; align-items: center; padding: 20px;">
    <div style="background: white; padding: 25px; border-radius: 10px; width: 95%; max-width: 800px; max-height: 90vh; overflow-y: auto;">
      <h4 style="text-align: center; color: #C76E00; margin-top: 0;">PARADAS DE OPERACI√ìN</h4>
      <hr style="margin: 15px 0; border-style: dashed;">
      
      <div id="paradas-operacion-contenedor" style="margin-bottom: 20px;"></div>
      
      <div style="display: flex; gap: 15px; justify-content: center; margin-top: 15px; padding-top: 15px; border-top: 2px solid #001855;">
        <button type="button" onclick="agregarParadaOperacionOverlay()"
                style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; border: none; padding: 10px 25px; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 1em; flex: 1;">
          ‚ûï Agregar Parada
        </button>
        
        <button type="button" onclick="cerrarParadasOperacion()"
                style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; padding: 10px 25px; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 1em; flex: 1;">
          ‚úÖ Aceptar
        </button>
      </div>
    </div>
  </div>
          
          <hr style="margin-top: 25px; border-style: dotted;">
          
          <!-- SECCI√ìN: TOTALES DE TURNO -->
          <h3 style="text-align:center; font-size:1.1em; color:#296097;">TOTALES DE TURNO</h3>
          
          <!-- ‚úÖ TOTAL PERSONAS Y TOTAL CAJAS EN LA MISMA L√çNEA -->
          <div style="display: flex; gap: 20px; align-items: flex-start; margin-bottom: 15px;">
            <!-- Total Personas En El Turno -->
            <div style="flex: 1;">
              <label for="total_personas" style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Total Personas En El Turno:</label>
              <input type="number" name="total_personas" id="total_personas" min="1" required
                    placeholder="Total de empleados en el turno"
                    style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; font-size: 1em; box-sizing: border-box;">
              <div id="nombres-contenedor" style="margin-top: 15px;"></div>
            </div>
            
            <!-- Total Cajas Movidas -->
            <div style="flex: 1;">
              <label for="cajas_totales" style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Total Cajas Movidas:</label>
              <input type="number" name="cajas_totales" id="cajas_totales" min="0" required
                    placeholder="Cantidad total de cajas movidas"
                    oninput="actualizarTotalCajas()"
                    style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; font-size: 1em; box-sizing: border-box;">
            </div>
          </div>

          <!-- ‚úÖ CAMPOS HIDDEN (sin cambios) -->
          <input type="hidden" name="datos_vehiculos" id="datos_vehiculos" value="">
          <input type="hidden" name="datos_paradas_operacion" id="datos_paradas_operacion" value="">

          <!-- ‚úÖ BOTONES ENVIAR Y BORRAR TODO (sin cambios) -->
          <div style="display: flex; gap: 10px;">
              <button type="submit" style="flex: 3; padding: 12px; background: #205d35; color: white; border: none;
              border-radius: 5px; font-weight: bold; font-size: 1.1em; cursor: pointer;">Enviar</button>
              <button type="button" class="btn-borrar-todo" style="flex: 1; padding: 12px; background: #852d36; color: white; border: none; border-radius: 5px; font-weight: bold; font-size: 1em; cursor: pointer;" onclick="limpiarTodo()">üóëÔ∏è Borrar Todo</button>
          </div>
          
      </form>

      <script>
          let vehiculosData = [];
          function obtenerMuellesPorLugar(lugar) {
    if (lugar === 'SantoDomingo') {
      // Muelles del 1 al 10 para Santo Domingo
      return [
        { value: '1', label: '1' },
        { value: '2', label: '2' },
        { value: '3', label: '3' },
        { value: '4', label: '4' },
        { value: '5', label: '5' },
        { value: '6', label: '6' },
        { value: '7', label: '7' },
        { value: 'otro', label: 'Otro' }
      ];
    } else {
      // Muelles actuales para Pepsico Funza
      return [
        { value: '3', label: '3' },
        { value: '11', label: '11' },
        { value: '12', label: '12' },
        { value: '13', label: '13' },
        { value: '14', label: '14' },
        { value: '17', label: '17' },
        { value: '18', label: '18' },
        { value: '19', label: '19' },
        { value: '20', label: '20' },
        { value: 'otro', label: 'Otro' }
      ];
    }
  }

  // ‚úÖ ESTADO DE TIEMPO POR PARADA
  const estadoTiempoParada = {};

  // ‚úÖ FUNCI√ìN UNIFICADA: Generar time-row con botones inteligentes
  // ‚úÖ FUNCI√ìN UNIFICADA: Generar time-row con botones inteligentes (CORREGIDO)
  function generarTimeRowConBotonesParada(index, sufijo = '', valorInicio = '', valorFin = '') {
    const dInicio = `operacion-inicio-${index}${sufijo ? '-' + sufijo : ''}`;
    const dFin = `operacion-fin-${index}${sufijo ? '-' + sufijo : ''}`;
    const nombreInicio = `parada_inicio_operacion_${index}${sufijo ? '_' + sufijo : ''}`;
    const nombreFin = `parada_fin_operacion_${index}${sufijo ? '_' + sufijo : ''}`;
    const btnId = `btn-control-tiempo-${index}${sufijo ? '-' + sufijo : ''}`;
    const btnEditarId = `btn-editar-tiempo-${index}${sufijo ? '-' + sufijo : ''}`;
    const btnEliminarId = `btn-eliminar-tiempo-${index}${sufijo ? '-' + sufijo : ''}`;
    const btnCancelarId = `btn-cancelar-tiempo-${index}${sufijo ? '-' + sufijo : ''}`;
    
    // Determinar estado inicial del bot√≥n
    let btnTexto = '‚ñ∂Ô∏è Iniciar';
    let btnStyle = '';
    let btnDisabled = '';
    let inputsReadOnly = 'readonly';
    
    if (valorInicio && !valorFin) {
      btnTexto = '‚èπÔ∏è Finalizar';
      btnStyle = 'background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white;';
      btnDisabled = '';
      inputsReadOnly = 'readonly';
    } else if (valorInicio && valorFin) {
      btnTexto = '‚úÖ Finalizado';
      btnStyle = 'background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white;';
      btnDisabled = 'disabled';
      inputsReadOnly = 'readonly';
    }
    
    // ‚úÖ Verificar si est√° en modo edici√≥n
    const estadoKey = `${index}-${sufijo}`;
    if (estadoTiempoParada[estadoKey] === 'editando') {
      inputsReadOnly = '';
      btnTexto = 'üíæ Guardar';
      btnStyle = 'background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white;';
    }
    
    return `
  <div class="time-row" style="display: flex; gap: 10px; align-items: flex-start; margin-bottom: 10px;">
    <div style="flex: 1;">
      <label class="time-label">Hora Inicio (HH:MM):</label>
      <input type="tel" name="${nombreInicio}" class="time-input-masked"
          placeholder="HH:MM" maxlength="5" value="${valorInicio}"
          onblur="applyTimeMask(this, '${dInicio}')"
          ${inputsReadOnly}
          style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 6px; font-size: 1em; text-align: center;">
      <span id="${dInicio}" class="time-display"></span>
    </div>
    <div style="flex: 1;">
      <label class="time-label">Hora Final (HH:MM):</label>
      <input type="tel" name="${nombreFin}" class="time-input-masked"
          placeholder="HH:MM" maxlength="5" value="${valorFin}"
          onblur="applyTimeMask(this, '${dFin}')"
          ${inputsReadOnly}
          style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 6px; font-size: 1em; text-align: center;">
      <span id="${dFin}" class="time-display"></span>
    </div>
  </div>
  <!-- ‚úÖ BOTONES INTELIGENTES (una sola l√≠nea) -->
  <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px;">
    <button type="button" id="${btnId}" onclick="controlarTiempoParada(${index}, '${sufijo}')"
        style="flex: 1; min-width: 100px; padding: 10px 15px; border: none; border-radius: 6px; font-weight: bold; font-size: 0.85em; cursor: pointer; transition: all 0.2s; ${btnStyle}"
        ${btnDisabled}>
      ${btnTexto}
    </button>
    <button type="button" id="${btnEditarId}" onclick="editarTiempoParada(${index}, '${sufijo}')"
        style="flex: 1; min-width: 90px; padding: 10px 15px; background: linear-gradient(135deg, #6c757d 0%, #495054 100%); color: white; border: none; border-radius: 6px; font-weight: bold; font-size: 0.85em; cursor: pointer;">
      ‚úèÔ∏è Editar
    </button>
    <button type="button" id="${btnCancelarId}" onclick="cancelarEdicionParada(${index}, '${sufijo}')"
        style="flex: 1; min-width: 90px; padding: 10px 15px; background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; border: none; border-radius: 6px; font-weight: bold; font-size: 0.85em; cursor: pointer; display: ${estadoTiempoParada[estadoKey] === 'editando' ? 'block' : 'none'};">
      ‚ùå Cancelar
    </button>
    <button type="button" id="${btnEliminarId}" onclick="eliminarTiempoParada(${index}, '${sufijo}')"
        style="flex: 1; min-width: 90px; padding: 10px 15px; background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; border: none; border-radius: 6px; font-weight: bold; font-size: 0.85em; cursor: pointer;">
      üóëÔ∏è Eliminar
    </button>
  </div>
  `;
  }

  // ‚úÖ CONTROLAR TIEMPO PARADA (Iniciar/Finalizar) - SIN ALERTA AL INICIAR
  function controlarTiempoParada(index, sufijo) {
    const sufijoName = sufijo ? `_${sufijo}` : '';
    const estadoKey = `${index}-${sufijo}`;
    
    // ‚ùå Si est√° en modo edici√≥n, no permitir iniciar/finalizar
    if (estadoTiempoParada[estadoKey] === 'editando') {
      alert('‚ö†Ô∏è Primero guarda la edici√≥n antes de iniciar/finalizar.');
      return;
    }
    
    const inicioInput = document.querySelector(`input[name="parada_inicio_operacion_${index}${sufijoName}"]`);
    const finInput = document.querySelector(`input[name="parada_fin_operacion_${index}${sufijoName}"]`);
    const btnControl = document.getElementById(`btn-control-tiempo-${index}${sufijo ? '-' + sufijo : ''}`);
    const btnEditar = document.getElementById(`btn-editar-tiempo-${index}${sufijo ? '-' + sufijo : ''}`);
    
    if (!inicioInput || !finInput || !btnControl) return;
    
    if (!inicioInput.value) {
      // ‚úÖ INICIAR TIEMPO - SIN ALERTA
      const ahora = new Date();
      const hora = String(ahora.getHours()).padStart(2, '0');
      const minuto = String(ahora.getMinutes()).padStart(2, '0');
      const horaActual = `${hora}:${minuto}`;
      
      inicioInput.value = horaActual;
      applyTimeMask(inicioInput, `operacion-inicio-${index}${sufijo ? '-' + sufijo : ''}`);
      
      // Actualizar bot√≥n
      btnControl.innerHTML = '‚èπÔ∏è Finalizar';
      btnControl.style.background = 'linear-gradient(135deg, #dc3545 0%, #c82333 100%)';
      btnControl.style.color = 'white';
      btnControl.disabled = false;
      
      // Bloquear edici√≥n mientras est√° activo
      if (btnEditar) {
        btnEditar.disabled = true;
        btnEditar.style.opacity = '0.7';
      }
      
      // Guardar estado
      estadoTiempoParada[estadoKey] = 'iniciado';
      guardarProgreso();
      console.log(`‚ñ∂Ô∏è Tiempo iniciado para Parada ${index + 1} a las ${inicioInput.value}`);
      
    } else if (!finInput.value) {
      // ‚úÖ FINALIZAR TIEMPO - CON ALERTA (m√°s cr√≠tico)
      if (!confirm(`‚ö†Ô∏è ¬øEst√°s seguro de FINALIZAR la parada con la hora actual?\n\nEsta acci√≥n registrar√° la hora actual como hora de finalizaci√≥n.`)) {
        return;
      }
      
      const ahora = new Date();
      const hora = String(ahora.getHours()).padStart(2, '0');
      const minuto = String(ahora.getMinutes()).padStart(2, '0');
      const horaActual = `${hora}:${minuto}`;
      
      finInput.value = horaActual;
      applyTimeMask(finInput, `operacion-fin-${index}${sufijo ? '-' + sufijo : ''}`);
      
      // Validar que fin no sea menor que inicio
      const inicioMin = horaAMinutos(inicioInput.value);
      const finMin = horaAMinutos(finInput.value);
      if (finMin < inicioMin) {
        alert('‚ùå Error: La hora final no puede ser menor que la hora de inicio.');
        finInput.value = '';
        return;
      }
      
      // Actualizar bot√≥n
      btnControl.innerHTML = '‚úÖ Finalizado';
      btnControl.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
      btnControl.style.color = 'white';
      btnControl.disabled = true;
      
      // Habilitar edici√≥n nuevamente
      if (btnEditar) {
        btnEditar.disabled = false;
        btnEditar.style.opacity = '1';
      }
      
      // Guardar estado
      estadoTiempoParada[estadoKey] = 'finalizado';
      guardarProgreso();
      console.log(`‚èπÔ∏è Tiempo finalizado para Parada ${index + 1} a las ${finInput.value}`);
      
    } else {
      // ‚úÖ YA FINALIZADO
      alert('‚úÖ El tiempo ya ha sido finalizado para esta parada.');
    }
  }

  // ‚úÖ EDITAR TIEMPO PARADA MANUALMENTE - SIN ALERTA
  function editarTiempoParada(index, sufijo) {
    const sufijoName = sufijo ? `_${sufijo}` : '';
    const estadoKey = `${index}-${sufijo}`;
    const inicioInput = document.querySelector(`input[name="parada_inicio_operacion_${index}${sufijoName}"]`);
    const finInput = document.querySelector(`input[name="parada_fin_operacion_${index}${sufijoName}"]`);
    const btnControl = document.getElementById(`btn-control-tiempo-${index}${sufijo ? '-' + sufijo : ''}`);
    const btnEditar = document.getElementById(`btn-editar-tiempo-${index}${sufijo ? '-' + sufijo : ''}`);
    const btnEliminar = document.getElementById(`btn-eliminar-tiempo-${index}${sufijo ? '-' + sufijo : ''}`);
    const btnCancelar = document.getElementById(`btn-cancelar-tiempo-${index}${sufijo ? '-' + sufijo : ''}`);
    
    if (!inicioInput || !finInput || !btnEditar) return;
    
    // ‚úÖ SI EST√Å EN MODO EDICI√ìN ‚Üí GUARDAR
    if (estadoTiempoParada[estadoKey] === 'editando') {
      // ‚úÖ Validar formato (permitir campos vac√≠os)
      if (inicioInput.value && !/^\d{2}:\d{2}$/.test(inicioInput.value)) {
        alert('‚ùå Formato de hora de inicio inv√°lido. Usa HH:MM o deja vac√≠o.');
        inicioInput.focus();
        return;
      }
      if (finInput.value && !/^\d{2}:\d{2}$/.test(finInput.value)) {
        alert('‚ùå Formato de hora de finalizaci√≥n inv√°lido. Usa HH:MM o deja vac√≠o.');
        finInput.focus();
        return;
      }
      
      // ‚úÖ Validar que final ‚â• inicio (solo si ambos tienen valor)
      if (inicioInput.value && finInput.value) {
        const inicioMin = horaAMinutos(inicioInput.value);
        const finMin = horaAMinutos(finInput.value);
        if (finMin < inicioMin) {
          alert('‚ùå La hora final no puede ser menor que la hora de inicio.');
          finInput.focus();
          return;
        }
      }
      
      // ‚úÖ Guardar cambios
      btnEditar.innerHTML = '‚úèÔ∏è Editar';
      btnEditar.style.background = 'linear-gradient(135deg, #6c757d 0%, #495054 100%)';
      inicioInput.readOnly = true;
      finInput.readOnly = true;
      
      // ‚úÖ Restaurar otros botones
      if (btnControl) btnControl.disabled = false;
      if (btnEliminar) btnEliminar.disabled = false;
      if (btnCancelar) btnCancelar.style.display = 'none';
      
      // ‚úÖ Guardar estado
      estadoTiempoParada[estadoKey] = 'editado';
      guardarProgreso();
      mostrarNotificacion(`‚úÖ Edici√≥n guardada`, 'success');
      return;
    }
    
    // ‚úÖ ACTIVAR MODO EDICI√ìN - SIN ALERTA
    inicioInput.readOnly = false;
    finInput.readOnly = false;
    inicioInput.focus();
    
    // ‚úÖ Cambiar bot√≥n a "Guardar"
    btnEditar.innerHTML = 'üíæ Guardar';
    btnEditar.style.background = 'linear-gradient(135deg, #007bff 0%, #0056b3 100%)';
    
    // ‚úÖ Bloquear otros botones mientras edita
    if (btnControl) btnControl.disabled = true;
    if (btnEliminar) btnEliminar.disabled = true;
    
    // ‚úÖ Mostrar bot√≥n Cancelar
    if (btnCancelar) btnCancelar.style.display = 'block';
    
    // ‚úÖ Guardar estado
    estadoTiempoParada[estadoKey] = 'editando';
    mostrarNotificacion(`üìù Edici√≥n activada. Cambia las horas o haz clic en "Cancelar".`, 'warning');
  }

  // ‚úÖ CANCELAR EDICI√ìN PARADA (NUEVA FUNCI√ìN)
  function cancelarEdicionParada(index, sufijo) {
    const sufijoName = sufijo ? `_${sufijo}` : '';
    const estadoKey = `${index}-${sufijo}`;
    const inicioInput = document.querySelector(`input[name="parada_inicio_operacion_${index}${sufijoName}"]`);
    const finInput = document.querySelector(`input[name="parada_fin_operacion_${index}${sufijoName}"]`);
    const btnControl = document.getElementById(`btn-control-tiempo-${index}${sufijo ? '-' + sufijo : ''}`);
    const btnEditar = document.getElementById(`btn-editar-tiempo-${index}${sufijo ? '-' + sufijo : ''}`);
    const btnEliminar = document.getElementById(`btn-eliminar-tiempo-${index}${sufijo ? '-' + sufijo : ''}`);
    const btnCancelar = document.getElementById(`btn-cancelar-tiempo-${index}${sufijo ? '-' + sufijo : ''}`);
    
    if (!inicioInput || !finInput || !btnEditar) return;
    
    // ‚úÖ Bloquear campos nuevamente
    inicioInput.readOnly = true;
    finInput.readOnly = true;
    
    // ‚úÖ Restaurar bot√≥n editar
    btnEditar.innerHTML = '‚úèÔ∏è Editar';
    btnEditar.style.background = 'linear-gradient(135deg, #6c757d 0%, #495054 100%)';
    btnEditar.disabled = false;
    
    // ‚úÖ Restaurar otros botones
    if (btnControl) btnControl.disabled = false;
    if (btnEliminar) btnEliminar.disabled = false;
    
    // ‚úÖ Ocultar bot√≥n cancelar
    if (btnCancelar) btnCancelar.style.display = 'none';
    
    // ‚úÖ Limpiar estado
    delete estadoTiempoParada[estadoKey];
    
    guardarProgreso();
    mostrarNotificacion(`‚ùå Edici√≥n cancelada`, 'warning');
  }

  // ‚úÖ ELIMINAR TIEMPO PARADA - FUNCIONA DURANTE EDICI√ìN
  function eliminarTiempoParada(index, sufijo) {
    const sufijoName = sufijo ? `_${sufijo}` : '';
    const estadoKey = `${index}-${sufijo}`;
    const inicioInput = document.querySelector(`input[name="parada_inicio_operacion_${index}${sufijoName}"]`);
    const finInput = document.querySelector(`input[name="parada_fin_operacion_${index}${sufijoName}"]`);
    const btnControl = document.getElementById(`btn-control-tiempo-${index}${sufijo ? '-' + sufijo : ''}`);
    const btnEditar = document.getElementById(`btn-editar-tiempo-${index}${sufijo ? '-' + sufijo : ''}`);
    const btnEliminar = document.getElementById(`btn-eliminar-tiempo-${index}${sufijo ? '-' + sufijo : ''}`);
    const btnCancelar = document.getElementById(`btn-cancelar-tiempo-${index}${sufijo ? '-' + sufijo : ''}`);
    
    if (!inicioInput || !finInput || !btnControl) return;
    
    // ‚úÖ Permitir eliminar incluso en modo edici√≥n
    // if (estadoTiempoParada[estadoKey] === 'editando') {
    //   alert('‚ö†Ô∏è Primero guarda o cancela la edici√≥n antes de eliminar.');
    //   return;
    // }
    
    if (!inicioInput.value && !finInput.value) {
      alert('‚ÑπÔ∏è No hay tiempo registrado para eliminar.');
      return;
    }
    
    if (!confirm('‚ö†Ô∏è ¬øEst√°s seguro de ELIMINAR las horas de inicio y fin?\n\nEsta acci√≥n no se puede deshacer.')) {
      return;
    }
    
    // Limpiar campos
    inicioInput.value = '';
    finInput.value = '';
    
    // Limpiar displays
    const dInicio = document.getElementById(`operacion-inicio-${index}${sufijo ? '-' + sufijo : ''}`);
    const dFin = document.getElementById(`operacion-fin-${index}${sufijo ? '-' + sufijo : ''}`);
    if (dInicio) dInicio.innerHTML = '';
    if (dFin) dFin.innerHTML = '';
    
    // Restaurar bot√≥n
    btnControl.innerHTML = '‚ñ∂Ô∏è Iniciar';
    btnControl.style.background = '';
    btnControl.style.color = '';
    btnControl.disabled = false;
    
    // Restaurar bot√≥n de editar
    if (btnEditar) {
      btnEditar.innerHTML = '‚úèÔ∏è Editar';
      btnEditar.style.background = 'linear-gradient(135deg, #6c757d 0%, #495054 100%)';
      btnEditar.style.color = 'white';
      btnEditar.disabled = false;
    }
    
    // Restaurar bot√≥n de eliminar
    if (btnEliminar) btnEliminar.disabled = false;
    
    // Ocultar bot√≥n cancelar
    if (btnCancelar) btnCancelar.style.display = 'none';
    
    // Limpiar estado
    delete estadoTiempoParada[estadoKey];
    
    guardarProgreso();
    mostrarNotificacion(`üóëÔ∏è Tiempo eliminado`, 'warning');
  }

  // ‚úÖ ABRIR OVERLAY DE PARADAS DE OPERACI√ìN
  function abrirParadasOperacion() {
    const overlay = document.getElementById('overlay-paradas-operacion');
    const contenedorOverlay = document.getElementById('paradas-operacion-contenedor');
    const contenedorOculto = document.getElementById('operacion-contenedor');
    
    if (!overlay || !contenedorOverlay || !contenedorOculto) {
      console.error('Error: Elementos del overlay no encontrados');
      return;
    }
    
    // Limpiar contenedor del overlay
    contenedorOverlay.innerHTML = '';
    
    // Copiar paradas del contenedor oculto al overlay
    const paradasOcultas = contenedorOculto.querySelectorAll('.parada-group');
    paradasOcultas.forEach((paradaOculta, index) => {
      // ‚úÖ Crear nueva parada manualmente (no clonar) para mantener eventos
      const div = document.createElement('div');
      div.className = 'parada-group';
      div.dataset.index = index;
      
      const botonEliminar = document.createElement('button');
      botonEliminar.type = 'button';
      botonEliminar.className = 'btn-eliminar';
      botonEliminar.textContent = 'Eliminar';
      botonEliminar.style.marginTop = '10px';
      botonEliminar.style.background = '#dc3545';
      botonEliminar.style.color = 'white';
      botonEliminar.style.border = 'none';
      botonEliminar.style.padding = '5px 10px';
      botonEliminar.style.borderRadius = '3px';
      botonEliminar.style.cursor = 'pointer';
      botonEliminar.onclick = function() {
        div.remove();
        actualizarNumerosParadasOverlay();
        guardarProgreso();
      };
      
      const dInicio = `operacion-inicio-${index}-overlay`;
      const dFin = `operacion-fin-${index}-overlay`;
      
      // ‚úÖ Obtener valores del contenedor oculto
      const inicio = paradaOculta.querySelector(`input[name="parada_inicio_operacion_${index}"]`)?.value || '';
      const fin = paradaOculta.querySelector(`input[name="parada_fin_operacion_${index}"]`)?.value || '';
      const motivo = paradaOculta.querySelector(`select[name="parada_motivo_operacion_${index}"]`)?.value || '';
      const otro_motivo = paradaOculta.querySelector(`input[name="parada_otro_motivo_operacion_${index}"]`)?.value || '';
      
      div.innerHTML = `
        <p style="font-weight:bold; margin-top:0; color:#555;">üõë Parada #<span class="numero-parada">${index + 1}</span> (Operaci√≥n)</p>
        
          
    ${generarTimeRowConBotonesParada(index, 'overlay', inicio, fin)}
        
        <label style="margin-top:5px;">Motivo:</label>
        <select name="parada_motivo_operacion_${index}_overlay" id="motivo-overlay-${index}">
          <option value="">Seleccione</option>
          <option value="pausas_activas" ${motivo === 'pausas_activas' ? 'selected' : ''}>Pausas Activas y/o Charla</option>
          <option value="liberacion_calidad" ${motivo === 'liberacion_calidad' ? 'selected' : ''}>Liberacion De Calidad</option>
          <option value="desayuno_almuerzo_cena" ${motivo === 'desayuno_almuerzo_cena' ? 'selected' : ''}>Desayuno/Almuerzo/Cena</option>
          <option value="aseo" ${motivo === 'aseo' ? 'selected' : ''}>Aseo</option>
          <option value="faltante_insumos" ${motivo === 'faltante_insumos' ? 'selected' : ''}>Faltante (Canastillas, vinipel, estibas, etc)</option>
          <option value="danos_equipo" ${motivo === 'danos_equipo' ? 'selected' : ''}>Da√±os (Electricos, montacargas, etc)</option>
          <option value="otro" ${motivo === 'otro' ? 'selected' : ''}>Otro</option>
        </select>
        <input type="text" name="parada_otro_motivo_operacion_${index}_overlay" id="otro-motivo-overlay-${index}" placeholder="Especifique" class="otro-input" value="${otro_motivo}" style="${motivo === 'otro' ? 'display: block;' : 'display: none;'}">
      `;
      
      div.appendChild(botonEliminar);
      contenedorOverlay.appendChild(div);
      
      // ‚úÖ Configurar evento onchange para mostrar/ocultar "otro motivo"
      const motivoSelect = div.querySelector(`#motivo-overlay-${index}`);
      const otroMotivoInput = div.querySelector(`#otro-motivo-overlay-${index}`);
      
      if (motivoSelect && otroMotivoInput) {
        motivoSelect.addEventListener('change', function() {
          if (this.value === 'otro') {
            otroMotivoInput.style.display = 'block';
            otroMotivoInput.required = true;
          } else {
            otroMotivoInput.style.display = 'none';
            otroMotivoInput.required = false;
            otroMotivoInput.value = '';
          }
          guardarProgreso();
        });
      }
      
      // ‚úÖ Configurar eventos de tiempo
      const inputsTiempo = div.querySelectorAll('.time-input-masked');
      inputsTiempo.forEach(input => {
        input.addEventListener('input', function() {
          this.value = this.value.replace(/[^0-9]/g, '').substring(0, 5);
        });
      });
    });
    
    // Si no hay paradas, agregar la primera vac√≠a
    if (contenedorOverlay.children.length === 0) {
      agregarParadaOperacionOverlay();
    }
    
    // Mostrar overlay
    overlay.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }

  // ‚úÖ CERRAR OVERLAY DE PARADAS DE OPERACI√ìN
  function cerrarParadasOperacion() {
    const contenedorOculto = document.getElementById('operacion-contenedor');
    const contenedorOverlay = document.getElementById('paradas-operacion-contenedor');
    const overlay = document.getElementById('overlay-paradas-operacion');
    
    if (!contenedorOculto || !contenedorOverlay || !overlay) return;
    
    // Limpiar contenedor oculto
    contenedorOculto.innerHTML = '';
    
    // Copiar paradas del overlay al contenedor oculto
    const paradasOverlay = contenedorOverlay.querySelectorAll('.parada-group');
    paradasOverlay.forEach((paradaOverlay, index) => {
      // ‚úÖ Crear nueva parada manualmente
      const div = document.createElement('div');
      div.className = 'parada-group';
      div.dataset.index = index;
      
      const botonEliminar = document.createElement('button');
      botonEliminar.type = 'button';
      botonEliminar.className = 'btn-eliminar';
      botonEliminar.textContent = 'Eliminar';
      botonEliminar.onclick = function() {
        div.remove();
        const paradas = contenedorOculto.querySelectorAll('.parada-group');
        paradas.forEach((p, i) => {
          const span = p.querySelector('.numero-parada');
          if (span) span.textContent = i + 1;
        });
        guardarProgreso();
      };
      
      const dInicio = `operacion-inicio-${index}`;
      const dFin = `operacion-fin-${index}`;
      
      // ‚úÖ Obtener valores del overlay
      const inicio = paradaOverlay.querySelector(`input[name="parada_inicio_operacion_${index}_overlay"]`)?.value || '';
      const fin = paradaOverlay.querySelector(`input[name="parada_fin_operacion_${index}_overlay"]`)?.value || '';
      const motivo = paradaOverlay.querySelector(`select[name="parada_motivo_operacion_${index}_overlay"]`)?.value || '';
      const otro_motivo = paradaOverlay.querySelector(`input[name="parada_otro_motivo_operacion_${index}_overlay"]`)?.value || '';
      
      div.innerHTML = `
        <p style="font-weight:bold; margin-top:0; color:#555;">üõë Parada #<span class="numero-parada">${index + 1}</span> (Operaci√≥n)</p>
        
          ${generarTimeRowConBotonesParada(index, '', inicio, fin)}
        
        <label style="margin-top:5px;">Motivo:</label>
        <select name="parada_motivo_operacion_${index}" id="motivo-${index}">
          <option value="">Seleccione</option>
          <option value="pausas_activas" ${motivo === 'pausas_activas' ? 'selected' : ''}>Pausas Activas y/o Charla</option>
          <option value="liberacion_calidad" ${motivo === 'liberacion_calidad' ? 'selected' : ''}>Liberacion De Calidad</option>
          <option value="desayuno_almuerzo_cena" ${motivo === 'desayuno_almuerzo_cena' ? 'selected' : ''}>Desayuno/Almuerzo/Cena</option>
          <option value="aseo" ${motivo === 'aseo' ? 'selected' : ''}>Aseo</option>
          <option value="faltante_insumos" ${motivo === 'faltante_insumos' ? 'selected' : ''}>Faltante (Canastillas, vinipel, estibas, etc)</option>
          <option value="danos_equipo" ${motivo === 'danos_equipo' ? 'selected' : ''}>Da√±os (Electricos, montacargas, etc)</option>
          <option value="otro" ${motivo === 'otro' ? 'selected' : ''}>Otro</option>
        </select>
        <input type="text" name="parada_otro_motivo_operacion_${index}" id="otro-motivo-${index}" placeholder="Especifique" class="otro-input" value="${otro_motivo}" style="${motivo === 'otro' ? 'display: block;' : 'display: none;'}">
      `;
      
      div.appendChild(botonEliminar);
      contenedorOculto.appendChild(div);
      
      // ‚úÖ Configurar evento onchange para el contenedor oculto
      const motivoSelect = div.querySelector(`#motivo-${index}`);
      const otroMotivoInput = div.querySelector(`#otro-motivo-${index}`);
      
      if (motivoSelect && otroMotivoInput) {
        motivoSelect.addEventListener('change', function() {
          if (this.value === 'otro') {
            otroMotivoInput.style.display = 'block';
            otroMotivoInput.required = true;
          } else {
            otroMotivoInput.style.display = 'none';
            otroMotivoInput.required = false;
            otroMotivoInput.value = '';
          }
          guardarProgreso();
        });
      }
      
      // ‚úÖ Configurar eventos de tiempo
      const inputsTiempo = div.querySelectorAll('.time-input-masked');
      inputsTiempo.forEach(input => {
        input.addEventListener('input', function() {
          this.value = this.value.replace(/[^0-9]/g, '').substring(0, 5);
        });
      });
    });
    
    // Ocultar overlay
    overlay.style.display = 'none';
    document.body.style.overflow = 'auto';
    
    guardarProgreso();
  }

  // ‚úÖ ACTUALIZAR N√öMEROS DE PARADAS EN EL OVERLAY
  function actualizarNumerosParadasOverlay() {
    const contenedor = document.getElementById('paradas-operacion-contenedor');
    if (!contenedor) return;
    
    const paradas = contenedor.querySelectorAll('.parada-group');
    paradas.forEach((parada, index) => {
      const span = parada.querySelector('.numero-parada');
      if (span) span.textContent = index + 1;
    });
  }

  // ‚úÖ AGREGAR PARADA EN EL OVERLAY
  function agregarParadaOperacionOverlay() {
    const index = document.getElementById('paradas-operacion-contenedor')?.children.length || 0;
    const contenedor = document.getElementById('paradas-operacion-contenedor');
    if (!contenedor) return;
    
    const div = document.createElement('div');
    div.className = 'parada-group';
    div.dataset.index = index;
    
    const botonEliminar = document.createElement('button');
    botonEliminar.type = 'button';
    botonEliminar.className = 'btn-eliminar';
    botonEliminar.textContent = 'Eliminar';
    botonEliminar.style.marginTop = '10px';
    botonEliminar.style.background = '#dc3545';
    botonEliminar.style.color = 'white';
    botonEliminar.style.border = 'none';
    botonEliminar.style.padding = '5px 10px';
    botonEliminar.style.borderRadius = '3px';
    botonEliminar.style.cursor = 'pointer';
    botonEliminar.onclick = function() {
      div.remove();
      actualizarNumerosParadasOverlay();
      guardarProgreso();
    };
    
    const dInicio = `operacion-inicio-${index}-overlay`;
    const dFin = `operacion-fin-${index}-overlay`;
    
    div.innerHTML = `
      <p style="font-weight:bold; margin-top:0; color:#555;">üõë Parada #<span class="numero-parada">${index + 1}</span> (Operaci√≥n)</p>
      
      ${generarTimeRowConBotonesParada(index, 'overlay', '', '')}
      
      <label style="margin-top:5px;">Motivo:</label>
      <select name="parada_motivo_operacion_${index}_overlay" id="motivo-overlay-${index}">
        <option value="">Seleccione</option>
        <option value="pausas_activas">Pausas Activas y/o Charla</option>
        <option value="liberacion_calidad">Liberacion De Calidad</option>
        <option value="desayuno_almuerzo_cena">Desayuno/Almuerzo/Cena</option>
        <option value="aseo">Aseo</option>
        <option value="faltante_insumos">Faltante (Canastillas, vinipel, estibas, etc)</option>
        <option value="danos_equipo">Da√±os (Electricos, montacargas, etc)</option>
        <option value="otro">Otro</option>
      </select>
      <input type="text" name="parada_otro_motivo_operacion_${index}_overlay" id="otro-motivo-overlay-${index}" placeholder="Especifique" class="otro-input" style="display: none;">
    `;
    
    div.appendChild(botonEliminar);
    contenedor.appendChild(div);
    
    // ‚úÖ Configurar evento onchange para mostrar/ocultar "otro motivo"
    const motivoSelect = div.querySelector(`#motivo-overlay-${index}`);
    const otroMotivoInput = div.querySelector(`#otro-motivo-overlay-${index}`);
    
    if (motivoSelect && otroMotivoInput) {
      motivoSelect.addEventListener('change', function() {
        if (this.value === 'otro') {
          otroMotivoInput.style.display = 'block';
          otroMotivoInput.required = true;
        } else {
          otroMotivoInput.style.display = 'none';
          otroMotivoInput.required = false;
          otroMotivoInput.value = '';
        }
        guardarProgreso();
      });
    }
    
    // ‚úÖ Configurar eventos de tiempo
    const inputsTiempo = div.querySelectorAll('.time-input-masked');
    inputsTiempo.forEach(input => {
      input.addEventListener('input', function() {
        this.value = this.value.replace(/[^0-9]/g, '').substring(0, 5);
      });
    });
    
    actualizarNumerosParadasOverlay();
  }

  // ‚úÖ AGREGAR CAMPO DE PARADA EN EL OVERLAY
  function agregarCampoParadaOverlay(tipo, index) {
    const contenedor = document.getElementById('paradas-operacion-contenedor');
    if (!contenedor) return;
    
    const div = document.createElement('div');
    div.className = 'parada-group';
    div.dataset.index = index;
    
    const botonEliminar = document.createElement('button');
    botonEliminar.type = 'button';
    botonEliminar.className = 'btn-eliminar';
    botonEliminar.textContent = 'Eliminar';
    botonEliminar.style.marginTop = '10px';
    botonEliminar.style.background = '#dc3545';
    botonEliminar.style.color = 'white';
    botonEliminar.style.border = 'none';
    botonEliminar.style.padding = '5px 10px';
    botonEliminar.style.borderRadius = '3px';
    botonEliminar.style.cursor = 'pointer';
    botonEliminar.onclick = function() {
      div.remove();
      actualizarNumerosParadasOverlay();
      guardarProgreso();
    };
    
    const dInicio = `operacion-inicio-${index}-overlay`;
    const dFin = `operacion-fin-${index}-overlay`;
    
    div.innerHTML = `
      <p style="font-weight:bold; margin-top:0; color:#555;">üõë Parada #<span class="numero-parada">${index + 1}</span> (Operaci√≥n)</p>
      
      ${generarTimeRowConBotonesParada(index, 'overlay', '', '')}
      
      <label style="margin-top:5px;">Motivo:</label>
      <select name="parada_motivo_operacion_${index}_overlay">
        <option value="">Seleccione</option>
        <option value="pausas_activas">Pausas Activas y/o Charla</option>
        <option value="liberacion_calidad">Liberacion De Calidad</option>
        <option value="desayuno_almuerzo_cena">Desayuno/Almuerzo/Cena</option>
        <option value="aseo">Aseo</option>
        <option value="faltante_insumos">Faltante (Canastillas, vinipel, estibas, etc)</option>
        <option value="danos_equipo">Da√±os (Electricos, montacargas, etc)</option>
        <option value="otro">Otro</option>
      </select>
      <input type="text" name="parada_otro_motivo_operacion_${index}_overlay" placeholder="Especifique" class="otro-input">
    `;
    
    div.appendChild(botonEliminar);
    contenedor.appendChild(div);
    
    // Configurar eventos
    const motivoSelect = div.querySelector(`select[name="parada_motivo_operacion_${index}_overlay"]`);
    if (motivoSelect) {
      motivoSelect.addEventListener('change', function() {
        const otroInput = div.querySelector('.otro-input');
        if (otroInput) {
          if (this.value === 'otro') {
            otroInput.style.display = 'block';
          } else {
            otroInput.style.display = 'none';
            otroInput.value = '';
          }
        }
      });
    }
    
    // Configurar eventos de tiempo
    const inputsTiempo = div.querySelectorAll('.time-input-masked');
    inputsTiempo.forEach(input => {
      input.addEventListener('input', function() {
        this.value = this.value.replace(/[^0-9]/g, '').substring(0, 5);
      });
    });
  }

  // ‚úÖ CERRAR OVERLAY AL HACER CLIC FUERA
  document.addEventListener('click', function(event) {
    const overlay = document.getElementById('overlay-paradas-operacion');
    if (overlay && overlay.style.display === 'flex') {
      const contenido = overlay.querySelector('div');
      if (contenido && !contenido.contains(event.target) && event.target === overlay) {
        cerrarParadasOperacion();
      }
    }
  });

  // ‚úÖ FORMATEAR C√âDULA COLOMBIANA (XXX.XXX.XXX o X.XXX.XXX.XXX)
  function formatearCedula(input) {
    // Eliminar todo excepto n√∫meros
    let valor = input.value.replace(/\D/g, '');
    
    // Limitar a 10 d√≠gitos
    if (valor.length > 10) {
      valor = valor.substring(0, 10);
    }
    
    // Formatear con puntos cada 3 d√≠gitos desde la derecha
    let partes = [];
    while (valor.length > 0) {
      partes.unshift(valor.substring(Math.max(0, valor.length - 3), valor.length));
      valor = valor.substring(0, Math.max(0, valor.length - 3));
    }
    
    input.value = partes.join('.');
  }

  // ‚úÖ NUEVA FUNCI√ìN: Actualizar muelles de todos los veh√≠culos
  function actualizarMuellesPorLugar() {
    const lugar = document.getElementById('lugar').value;
    const muelles = obtenerMuellesPorLugar(lugar);
    const contenedor = document.getElementById('vehiculos-contenedor');
    const registros = contenedor.querySelectorAll('.registro-vehiculo');
    
    registros.forEach((registro, index) => {
      // ‚úÖ BUSCAR POR ID EXACTO
      const muelleSelect = document.getElementById(`muelle-select-${index}`);
      const otroMuelleInput = document.getElementById(`otro_muelle_${index}`);
      
      if (muelleSelect) {
        const valorActual = muelleSelect.value;
        muelleSelect.innerHTML = '<option value="">Seleccione</option>';
        
        muelles.forEach(muelle => {
          const option = document.createElement('option');
          option.value = muelle.value;
          option.textContent = muelle.label;
          if (muelle.value === valorActual) {
            option.selected = true;
          }
          muelleSelect.appendChild(option);
        });
        
        manejarOtroMuelle(index);
      }
    });
    
    // ‚úÖ ACTUALIZAR TIPO DE OPERACI√ìN CUANDO CAMBIE EL LUGAR
    actualizarTipoOperacionPorLugar();
    guardarProgreso();
  }

  // ‚úÖ NUEVA FUNCI√ìN: Manejar campo "otro" para muelles
  function manejarOtroMuelle(vIndex) {
    const muelleSelect = document.querySelector(`#muelle-select-${vIndex}`);
    const otroInput = document.querySelector(`#otro_muelle_${vIndex}`);
    
    if (!muelleSelect || !otroInput) return;
    
    if (muelleSelect.value === 'otro') {
      otroInput.style.display = 'block';
      otroInput.required = true;
    } else {
      otroInput.style.display = 'none';
      otroInput.required = false;
      otroInput.value = '';
    }
    
    guardarProgreso();
  }

          

          // ============================================
          // FUNCIONES PARA NOMBRES DEL PERSONAL
          // ============================================

          // ‚úÖ FUNCI√ìN PARA GENERAR CAMPOS DE NOMBRES POR VEH√çCULO (NUEVO)
          function generarCamposNombresVehiculo(vIndex) {
              const totalInput = document.querySelector(`input[name="vehiculo_${vIndex}_personas"]`);
              if (!totalInput) return;
              
              const total = parseInt(totalInput.value) || 0;
              const container = document.getElementById(`nombres-personal-${vIndex}`);
              if (!container) return;
              
              container.innerHTML = '';
              
              if (total > 0) {
                  const label = document.createElement('label');
                  label.textContent = 'Nombres del Colaborador:';
                  label.style.display = 'block';
                  label.style.fontWeight = 'bold';
                  label.style.marginTop = '15px';
                  container.appendChild(label);
              }
              
              for (let i = 1; i <= total; i++) {
      const div = document.createElement('div');
      div.style.marginBottom = '10px';
      
      const label = document.createElement('label');
      label.textContent = `Nombre persona ${i}:`;
      label.style.display = 'block';
      label.style.fontWeight = 'bold';
      label.style.marginBottom = '5px';
      label.style.fontSize = '0.9em';
      label.htmlFor = `vehiculo_${vIndex}_nombre_persona_${i}`;
      
      const input = document.createElement('input');
      input.type = 'text';  // ‚úÖ Usar 'text' para mejor control
      input.inputmode = 'numeric';  // ‚úÖ Teclado num√©rico en m√≥viles
      input.id = `vehiculo_${vIndex}_nombre_persona_${i}`;
      input.name = `vehiculo_${vIndex}_nombre_persona_${i}`;
      input.placeholder = `N√∫mero de C√©dula ${i}`;
      input.required = true;
      input.maxLength = 10;  // ‚úÖ Limitar a m√°ximo 10 caracteres
      input.style.width = '100%';
      input.style.padding = '8px';
      input.style.border = '1px solid #170303';
      input.style.borderRadius = '8px';
      input.style.boxSizing = 'border-box';
      
      // ‚úÖ Limitar a solo n√∫meros y m√°ximo 10 d√≠gitos
      input.oninput = function() {
          // Eliminar todo excepto n√∫meros
          this.value = this.value.replace(/\D/g, '');
          
          // Limitar a m√°ximo 10 d√≠gitos
          if (this.value.length > 10) {
              this.value = this.value.substring(0, 10);
          }
          
          guardarProgreso();
      };
      
      div.appendChild(label);
      div.appendChild(input);
      container.appendChild(div);
  }
              
              guardarProgreso();
          }

          // ============================================
          // FUNCIONES DE VALIDACI√ìN DE HORAS
          // ============================================

          function horaAMinutos(horaStr) {
              if (!horaStr || !horaStr.includes(':')) return null;
              const [h, m] = horaStr.split(':').map(Number);
              if (isNaN(h) || isNaN(m) || h < 0 || h > 23 || m < 0 || m > 59) return null;
              return h * 60 + m;
          }

          function rangosSeSolapan(inicio1, fin1, inicio2, fin2) {
              const i1 = horaAMinutos(inicio1);
              const f1 = horaAMinutos(fin1);
              const i2 = horaAMinutos(inicio2);
              const f2 = horaAMinutos(fin2);
              
              if (i1 === null || f1 === null || i2 === null || f2 === null) return false;
              return i1 < f2 && i2 < f1;
          }

          // ============================================
          // VALIDACI√ìN DE SOLAPAMIENTOS
          // ============================================

          function validarSolapamientoVehiculos() {
              const agrupados = {};
              
              for (let idx = 0; idx < vehiculosData.length; idx++) {
                  const data = vehiculosData[idx];
                  if (!data.muelle && data.muelle !== 'otro') continue;
                  
                  const muelle = data.muelle === 'otro' ? (data.otro_muelle_num || '') : data.muelle;
                  if (!muelle || !data.inicio || !data.fin) continue;
                  
                  if (!agrupados[muelle]) agrupados[muelle] = [];
                  agrupados[muelle].push({ inicio: data.inicio, fin: data.fin, idx });
              }
              
              for (const muelle in agrupados) {
                  const regs = agrupados[muelle];
                  for (let i = 0; i < regs.length; i++) {
                      for (let j = i + 1; j < regs.length; j++) {
                          if (rangosSeSolapan(regs[i].inicio, regs[i].fin, regs[j].inicio, regs[j].fin)) {
                              alert(`¬°Conflicto en muelle ${muelle}! Veh√≠culos #${regs[i].idx + 1} y #${regs[j].idx + 1} se superponen en el mismo horario.`);
                              return false;
                          }
                      }
                  }
              }
              return true;
          }

          function validarSolapamientoParadas() {
              const paradas = [];
              const cont = document.getElementById('operacion-contenedor');
              const grupos = cont.querySelectorAll('.parada-group');
              
              grupos.forEach((grupo, idx) => {
                  const inicioInput = grupo.querySelector(`input[name^="parada_inicio_operacion_"]`);
                  const finInput = grupo.querySelector(`input[name^="parada_fin_operacion_"]`);
                  if (inicioInput && finInput && inicioInput.value && finInput.value) {
                      paradas.push({ inicio: inicioInput.value, fin: finInput.value, idx });
                  }
              });
              
              for (let i = 0; i < paradas.length; i++) {
                  for (let j = i + 1; j < paradas.length; j++) {
                      if (rangosSeSolapan(paradas[i].inicio, paradas[i].fin, paradas[j].inicio, paradas[j].fin)) {
                          alert(`¬°Las paradas de operaci√≥n #${i + 1} y #${j + 1} se superponen!`);
                          return false;
                      }
                  }
              }
              return true;
          }

          // ============================================
          // GESTI√ìN DE VEH√çCULOS
          // ============================================

          function eliminarRegistroVehiculo(index) {
              if (vehiculosData.length <= 1) {
                  alert("Debe haber al menos un veh√≠culo.");
                  return;
              }
              
              sincronizarVehiculosDesdeDOM();
              vehiculosData.splice(index, 1);
              reindexarVehiculos();
              actualizarTotalCajas();
              guardarProgreso();
          }

          function reindexarVehiculos() {
              const contenedor = document.getElementById('vehiculos-contenedor');
              contenedor.innerHTML = '';
              
              for (let i = 0; i < vehiculosData.length; i++) {
                  crearVehiculoHTML(contenedor, i, vehiculosData[i]);
              }
          }

  function agregarRegistroVehiculo() {
    const vIndex = vehiculosData.length;
    vehiculosData.push({});
    const contenedor = document.getElementById('vehiculos-contenedor');
    crearVehiculoHTML(contenedor, vIndex, {});
    actualizarTotalCajas();
    guardarProgreso();
    
    // ‚úÖ NUEVO: Actualizar muelles para el nuevo veh√≠culo
    actualizarMuellesPorLugar();
  }
          

          function sincronizarVehiculosDesdeDOM() {
    const contenedor = document.getElementById('vehiculos-contenedor');
    const registros = contenedor.querySelectorAll('.registro-vehiculo');
    
    for (let i = 0; i < registros.length; i++) {
      const reg = registros[i];
      if (vehiculosData[i] === undefined) vehiculosData[i] = {};
      
      // ‚úÖ FUNCI√ìN getValue CORREGIDA: Ignora campos ocultos
      const getValue = name => {
        const elementos = reg.querySelectorAll(`[name="${name}"]`);
        // Buscar el primer elemento VISIBLE
        for (let el of elementos) {
          if (el.offsetParent !== null) { // ‚úÖ Verifica si es visible
            return el.value || '';
          }
        }
        // Fallback: si ninguno es visible, tomar el primero
        return elementos[0] ? elementos[0].value || '' : '';
      };
      
      // ‚úÖ Obtener datos de nombres del personal
      const nombresPersonal = [];
      const nombresContainer = reg.querySelector(`#nombres-personal-${i}`);
      if (nombresContainer) {
        const inputsNombres = nombresContainer.querySelectorAll('input[type="text"]');
        inputsNombres.forEach((input, idx) => {
          nombresPersonal.push(input.value || '');
        });
      }
      
      // ‚úÖ CAPTURAR DATOS DEL OVERLAY DE INSPECCI√ìN
      const interiorCamion = document.getElementById(`interior_camion_${i}`)?.value || '';
      const estadoCarpa = document.getElementById(`estado_carpa_${i}`)?.value || '';
      const oloresExtranos = document.getElementById(`olores_extranos_${i}`)?.value || '';
      const objetosExtranos = document.getElementById(`objetos_extranos_${i}`)?.value || '';
      const evidenciasPlagas = document.getElementById(`evidencias_plagas_${i}`)?.value || '';
      const estadoSuelo = document.getElementById(`estado_suelo_${i}`)?.value || '';
      const aprobado = document.getElementById(`aprobado_${i}`)?.value || '';


      
      // ‚úÖ CAPTURAR JUSTIFICACIONES DEL VEH√çCULO
      const justificacionesContenedor = document.getElementById(`justificaciones-contenedor-${i}`);
      const justificacionesData = [];
      
      if (justificacionesContenedor) {
        const justificaciones = justificacionesContenedor.querySelectorAll('.justificacion-group');
        justificaciones.forEach((justificacion, jIndex) => {
          const motivo = justificacion.querySelector(`select[name="vehiculo_${i}_justificacion_${jIndex}"]`)?.value || '';
          const otro_motivo = justificacion.querySelector(`input[name="vehiculo_${i}_otro_justificacion_${jIndex}"]`)?.value || '';
          const tiempo_inicio = justificacion.querySelector(`input[name="vehiculo_${i}_tiempo_muerto_inicio_${jIndex}"]`)?.value || '';
          const tiempo_fin = justificacion.querySelector(`input[name="vehiculo_${i}_tiempo_muerto_final_${jIndex}"]`)?.value || '';
          
          justificacionesData.push({
            justificacion: motivo,
            otro_justificacion: otro_motivo,
            tiempo_muerto_inicio: tiempo_inicio,
            tiempo_muerto_final: tiempo_fin
          });
        });
      }
      
      // ‚úÖ CAPTURAR NOVEDADES DEL VEH√çCULO
      const novedadesContenedor = document.getElementById(`novedades-contenedor-${i}`);
      const novedadesData = [];
      
      if (novedadesContenedor) {
        const novedades = novedadesContenedor.querySelectorAll('.novedad-group');
        novedades.forEach((novedad, nIndex) => {
          const tipo = novedad.querySelector(`select[name="vehiculo_${i}_tipo_novedad_${nIndex}"]`)?.value || '';
          const descripcion = novedad.querySelector(`textarea[name="vehiculo_${i}_descripcion_novedad_${nIndex}"]`)?.value || '';
          const foto_url = novedad.querySelector(`input[name="vehiculo_${i}_foto_novedad_${nIndex}_url"]`)?.value || '';
          
          novedadesData.push({
            tipo: tipo,
            descripcion: descripcion,
            foto_url: foto_url
          });
        });
      }
      
      // ‚úÖ ASIGNAR TODOS LOS DATOS AL VEH√çCULO
      vehiculosData[i] = {
        inicio: getValue(`vehiculo_${i}_inicio`),
        fin: getValue(`vehiculo_${i}_fin`),
        motivo: getValue(`vehiculo_${i}_motivo`),  // ‚úÖ AHORA CAPTURA DEL VISIBLE
        otro_motivo: getValue(`vehiculo_${i}_otro_motivo`),
        tipo_carga: getValue(`vehiculo_${i}_tipo_carga`),
        muelle: getValue(`vehiculo_${i}_muelle`),
        otro_muelle_num: getValue(`vehiculo_${i}_otro_muelle_num`),
        placa: getValue(`vehiculo_${i}_placa`),
        tipo_vehi: getValue(`vehiculo_${i}_tipo_vehi`),
        otro_tipo: getValue(`vehiculo_${i}_otro_tipo`),
        destino: getValue(`vehiculo_${i}_destino`),
        otro_destino: getValue(`vehiculo_${i}_otro_destino`),
        origen: getValue(`vehiculo_${i}_origen`),
        otro_origen: getValue(`vehiculo_${i}_otro_origen`),
        personas: getValue(`vehiculo_${i}_personas`),
        nombres_personal: nombresPersonal,
        cajas: getValue(`vehiculo_${i}_cajas`),
        foto_url: getValue(`vehiculo_${i}_foto_url`),
        tipo_operacion: getValue(`vehiculo_${i}_tipo_operacion`) || '',
        interior_camion: interiorCamion,
        estado_carpa: estadoCarpa,
        olores_extranos: oloresExtranos,
        objetos_extranos: objetosExtranos,
        evidencias_plagas: evidenciasPlagas,
        estado_suelo: estadoSuelo,
        aprobado: aprobado,
        justificaciones: justificacionesData,
        novedades: novedadesData
      };
    }
    
    // ‚úÖ Depuraci√≥n
    console.log('üìä Datos de veh√≠culos sincronizados:');
    vehiculosData.forEach((v, i) => {
      console.log(`Veh√≠culo ${i}:`, {
        placa: v.placa,
        motivo: v.motivo,  // ‚úÖ Verifica que tenga valor
        tipo_carga: v.tipo_carga,
        tipo_operacion: v.tipo_operacion
      });
    });
  }
          // ============================================
          // MANEJO DE CAMPOS "OTRO"
          // ============================================

          function manejarOtroLiderPepsico() {
              const otroInput = document.getElementById('lider_pepsico_otro');
              if (document.getElementById('lider_pepsico').value === 'otro') {
                  otroInput.style.display = 'block';
                  otroInput.required = true;
              } else {
                  otroInput.style.display = 'none';
                  otroInput.required = false;
                  otroInput.value = '';
              }
              guardarProgreso();
          }

          function manejarOtroCampo(select) {
              const otro = select.nextElementSibling;
              if (!otro || !otro.classList.contains('otro-input')) return;
              
              if (select.value === 'otro') {
                  otro.style.display = 'block';
                  otro.required = true;
              } else {
                  otro.style.display = 'none';
                  otro.required = false;
                  otro.value = '';
              }
              guardarProgreso();
          }

          function manejarOtroCoordinador() {
              const otroInput = document.getElementById('coordinador_otro');
              if (document.getElementById('coordinador').value === 'otro') {
                  otroInput.style.display = 'block';
                  otroInput.required = true;
              } else {
                  otroInput.style.display = 'none';
                  otroInput.required = false;
                  otroInput.value = '';
              }
              guardarProgreso();
          }

          // ============================================
          // FUNCIONES DE VISUALIZACI√ìN CONDICIONAL
          // ============================================

          function alternarDestinoRemitente(selectMotivo, vIndex) {
    const motivo = selectMotivo.value;
    const destinoGroup = document.getElementById(`destino-group-${vIndex}`);
    const remitenteGroup = document.getElementById(`remitente-group-${vIndex}`);
    
    // ‚úÖ Mostrar/ocultar Destino y Origen seg√∫n el motivo
    if (destinoGroup) destinoGroup.style.display = motivo === 'cargue' ? 'block' : 'none';
    if (remitenteGroup) remitenteGroup.style.display = motivo === 'descargue' ? 'block' : 'none';
    
    // ‚úÖ Mostrar/ocultar el contenedor completo de Destino/Origen
    const container = document.getElementById(`conditional-destino-origen-${vIndex}`);
    if (container) {
      container.style.display = (motivo === 'cargue' || motivo === 'descargue') ? 'block' : 'none';
    }
    
    // ‚úÖ Manejar campos "otro" si existen
    const destinoSelect = document.getElementById(`destino-select-${vIndex}`);
    const remitenteSelect = document.getElementById(`remitente-select-${vIndex}`);
    
    if (destinoSelect) {
      const otroDestinoInput = document.getElementById(`otro_destino_${vIndex}`);
      if (otroDestinoInput) {
        if (destinoSelect.value === 'otro') {
          otroDestinoInput.style.display = 'block';
        } else {
          otroDestinoInput.style.display = 'none';
          otroDestinoInput.value = '';
        }
      }
    }
    
    if (remitenteSelect) {
      const otroOrigenInput = document.getElementById(`otro_origen_${vIndex}`);
      if (otroOrigenInput) {
        if (remitenteSelect.value === 'otro') {
          otroOrigenInput.style.display = 'block';
        } else {
          otroOrigenInput.style.display = 'none';
          otroOrigenInput.value = '';
        }
      }
    }
    
    guardarProgreso();
  }

          function mostrarTiempoMuerto(select, vIndex) {
              const div = document.getElementById(`tiempo-muerto-${vIndex}`);
              if (select.value !== "") {
                  div.style.display = 'flex';
              } else {
                  div.style.display = 'none';
                  const inicio = document.querySelector(`input[name="vehiculo_${vIndex}_tiempo_muerto_inicio"]`);
                  const fin = document.querySelector(`input[name="vehiculo_${vIndex}_tiempo_muerto_final"]`);
                  if (inicio) inicio.value = '';
                  if (fin) fin.value = '';
              }
              guardarProgreso();
          }

          // ‚úÖ NUEVA FUNCI√ìN: Mostrar/Ocultar Tipo de Operaci√≥n basado en lugar
  function actualizarTipoOperacionPorLugar() {
    const lugar = document.getElementById('lugar').value;
    const contenedor = document.getElementById('vehiculos-contenedor');
    const registros = contenedor.querySelectorAll('.registro-vehiculo');
    
    registros.forEach((registro, index) => {
      const containerMotivoTipo = document.getElementById(`motivo-tipo-operacion-container-${index}`);
      const lineaMotivoTipo = document.getElementById(`motivo-tipo-linea-${index}`);
      const motivoSolo = document.getElementById(`motivo-solo-${index}`);
      const tipoOperacionGroup = document.getElementById(`tipo-operacion-group-${index}`);
      
      if (containerMotivoTipo && lineaMotivoTipo && motivoSolo) {
        if (lugar === 'SantoDomingo') {
          // ‚úÖ Mostrar en una sola l√≠nea para Santo Domingo
          lineaMotivoTipo.style.display = 'flex';
          motivoSolo.style.display = 'none';
          
          // Limpiar valor si se oculta
          if (tipoOperacionGroup) {
            const tipoOperacionSelect = document.getElementById(`tipo-operacion-${index}`);
            if (tipoOperacionSelect) {
              // No limpiar, mantener el valor
            }
          }
        } else {
          // ‚úÖ Mostrar dise√±o original para otros lugares
          lineaMotivoTipo.style.display = 'none';
          motivoSolo.style.display = 'block';
          
          // Limpiar valor de tipo de operaci√≥n
          if (tipoOperacionGroup) {
            const tipoOperacionSelect = document.getElementById(`tipo-operacion-${index}`);
            if (tipoOperacionSelect) {
              tipoOperacionSelect.value = '';
            }
          }
        }
      }
    });
    
    guardarProgreso();
  }
          // ============================================
          // CREACI√ìN DE HTML PARA VEH√çCULOS
          // ============================================

          function crearVehiculoHTML(contenedor, vIndex, datos = {}) {
              const inicioId = `cargue-inicio-${vIndex}`;
              const finId = `cargue-fin-${vIndex}`;
              const fotoInputId = `foto_vehiculo_${vIndex}`;
              const previewFotoId = `preview_foto_${vIndex}`;
              const motivoSelectId = `motivo-cargue-descargue-${vIndex}`;
              
              const registro = document.createElement('div');
              registro.className = 'registro-vehiculo';
              registro.dataset.index = vIndex;
              
              
              const html = `
                  <button type="button" class="btn-eliminar-registro" onclick="eliminarRegistroVehiculo(${vIndex})">
                      Eliminar Veh√≠culo #${vIndex + 1}
                  </button>
                  
                  <hr style="margin-top:25px; border-style:dashed;">
                  
                  <h3 style="text-align:center; color:#292929;">VEH√çCULO #${vIndex + 1}</h3>
                  <h4 style="font-family: Arial, sans-serif; color: #983f03; text-align: center; text-transform: uppercase; margin: 20px 0;">Cargue/Descargue</h4>
                  <button type="button" onclick="abrirInspeccionVehiculo(${vIndex})"
                          style="background: linear-gradient(135deg, #001855 0%, #0039 100%); color: white; border: none; padding: 15px 20px; border-radius: 10px; font-weight: bold; cursor: pointer; margin: 10px 0; width: 100%; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                      üîç Inspecci√≥n de Veh√≠culo
                  </button>
                  <!-- ‚úÖ SECCI√ìN DE FOTOS PROFESIONAL CON CONTADOR -->
  <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 20px; border-radius: 10px; border: 2px solid #001855; margin-top: 15px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #001855;">
          <h5 style="margin: 0; color: #001855; font-size: 1.1em;">üì∏ Registro Fotogr√°fico</h5>
          <div style="background: #001855; color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 0.9em;">
              <span id="foto-contador-${vIndex}">0</span> / 3 fotos
          </div>
      </div>
      
      <!-- ‚úÖ BOTONES DE FOTOS -->
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px;">
          <!-- Foto Inicio -->
          <div style="text-align: center;">
              <button type="button" onclick="tomarFotoVehiculo(${vIndex}, 'inicio')"
                      id="btn-foto-inicio-${vIndex}"
                      style="width: 100%; padding: 10px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 0.85em; transition: all 0.2s;">
                  üü¢ Inicio
              </button>
              <input type="file" id="foto-inicio-${vIndex}" accept="image/*" capture="environment" style="display: none;" onchange="procesarFotoVehiculo(${vIndex}, 'inicio', this)">
              <div id="preview-inicio-${vIndex}" style="margin-top: 8px; min-height: 80px; background: white; border-radius: 5px; border: 2px dashed #ced4da; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                  <span style="color: #6c757d; font-size: 0.8em;">Sin foto</span>
              </div>
              <input type="hidden" id="url-inicio-${vIndex}" value="">
          </div>
          
          <!-- Foto Durante -->
          <div style="text-align: center;">
              <button type="button" onclick="tomarFotoVehiculo(${vIndex}, 'durante')"
                      id="btn-foto-durante-${vIndex}"
                      style="width: 100%; padding: 10px; background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); color: #000; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 0.85em; transition: all 0.2s;">
                  üü° Durante
              </button>
              <input type="file" id="foto-durante-${vIndex}" accept="image/*" capture="environment" style="display: none;" onchange="procesarFotoVehiculo(${vIndex}, 'durante', this)">
              <div id="preview-durante-${vIndex}" style="margin-top: 8px; min-height: 80px; background: white; border-radius: 5px; border: 2px dashed #ced4da; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                  <span style="color: #6c757d; font-size: 0.8em;">Sin foto</span>
              </div>
              <input type="hidden" id="url-durante-${vIndex}" value="">
          </div>
          
          <!-- Foto Fin -->
          <div style="text-align: center;">
              <button type="button" onclick="tomarFotoVehiculo(${vIndex}, 'fin')"
                      id="btn-foto-fin-${vIndex}"
                      style="width: 100%; padding: 10px; background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 0.85em; transition: all 0.2s;">
                  üî¥ Fin
              </button>
              <input type="file" id="foto-fin-${vIndex}" accept="image/*" capture="environment" style="display: none;" onchange="procesarFotoVehiculo(${vIndex}, 'fin', this)">
              <div id="preview-fin-${vIndex}" style="margin-top: 8px; min-height: 80px; background: white; border-radius: 5px; border: 2px dashed #ced4da; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                  <span style="color: #6c757d; font-size: 0.8em;">Sin foto</span>
              </div>
              <input type="hidden" id="url-fin-${vIndex}" value="">
          </div>
      </div>
      
      <!-- ‚úÖ ESTADO DE FOTOS -->
      <div id="estado-fotos-${vIndex}" style="background: #d1ecf1; color: #0c5460; padding: 10px; border-radius: 5px; font-size: 0.85em; border-left: 4px solid #17a2b8;">
          üí° <strong>Consejo:</strong> Toma fotos en cada etapa para un mejor registro.
      </div>
      
      <!-- ‚úÖ INPUT OCULTO LEGACY (para compatibilidad) -->
      <input type="hidden" name="vehiculo_${vIndex}_foto_url" id="foto_url_${vIndex}" value="${datos.foto_url || ''}">
  </div>

                  <div class="parada-group">
                      <p style="font-weight:bold; margin-top:0; color:#555;">üõë Parada #1 (Cargue/Descargue)</p>
                      
                      <!-- ‚úÖ SISTEMA INTELIGENTE DE CONTROL DE TIEMPO -->
  <div style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
    <div class="time-row" style="margin-bottom: 12px;">
      <div>
        <label class="time-label">Hora Inicio (HH:MM):</label>
        <input type="tel" name="vehiculo_${vIndex}_inicio" id="inicio-input-${vIndex}" class="time-input-masked" required
            placeholder="HH:MM" maxlength="5" value="${datos.inicio || ''}"
            onblur="applyTimeMask(this, '${inicioId}');"
            readonly  <!-- ‚úÖ BLOQUEADO POR DEFECTO -->
            <style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 1em; box-sizing: border-box;">
        <span id="${inicioId}" class="time-display"></span>
      </div>
      <div>
        <label class="time-label">Hora Final (HH:MM):</label>
        <input type="tel" name="vehiculo_${vIndex}_fin" id="fin-input-${vIndex}" class="time-input-masked" required
            placeholder="HH:MM" maxlength="5" value="${datos.fin || ''}"
            onblur="applyTimeMask(this, '${finId}');"
            readonly  <!-- ‚úÖ BLOQUEADO POR DEFECTO -->
            <style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 1em; box-sizing: border-box;">
        <span id="${finId}" class="time-display"></span>
      </div>
    </div>

    <!-- ‚úÖ BOTONES DE CONTROL EN UNA SOLA L√çNEA -->
    <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">
      <!-- Bot√≥n Iniciar/Finalizar -->
      <button type="button" id="btn-control-tiempo-${vIndex}" 
              onclick="controlarTiempoVehiculo(${vIndex})"
              style="flex: 1; min-width: 120px; padding: 10px 15px; border: none; border-radius: 6px; font-weight: bold; font-size: 0.95em; cursor: pointer; transition: all 0.2s;">
        ${datos.inicio ? '‚èπÔ∏è Finalizar' : '‚ñ∂Ô∏è Iniciar'}
      </button>

      <!-- Bot√≥n Editar / Guardar -->
      <button type="button" id="btn-editar-tiempo-${vIndex}"
              onclick="editarTiempoVehiculo(${vIndex})"
              style="flex: 1; min-width: 120px; padding: 10px 15px; background: linear-gradient(135deg, #6c757d 0%, #495054 100%); color: white; border: none; border-radius: 6px; font-weight: bold; font-size: 0.95em; cursor: pointer; transition: all 0.2s;">
        ‚úèÔ∏è Editar Tiempo
      </button>

      <!-- Bot√≥n Eliminar -->
      <button type="button" id="btn-eliminar-tiempo-${vIndex}"
              onclick="eliminarTiempoVehiculo(${vIndex})"
              style="flex: 1; min-width: 120px; padding: 10px 15px; background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; border: none; border-radius: 6px; font-weight: bold; font-size: 0.95em; cursor: pointer; transition: all 0.2s;">
        üóëÔ∏è Eliminar
      </button>
    </div>
  </div>
                      
                      <!-- ‚úÖ MOTIVO Y TIPO DE OPERACI√ìN EN UNA SOLA L√çNEA (solo para Santo Domingo) -->
  <div id="motivo-tipo-operacion-container-${vIndex}" style="margin-bottom: 15px;">
    <!-- Para Santo Domingo: en una sola l√≠nea -->
    <div id="motivo-tipo-linea-${vIndex}" style="display: none; display: flex; gap: 20px; align-items: flex-start;">
      <!-- Motivo -->
      <div style="flex: 1;">
        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Motivo:</label>
        <select id="${motivoSelectId}" name="vehiculo_${vIndex}_motivo"
                style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; font-size: 1em; box-sizing: border-box;"
                onchange="alternarDestinoRemitente(this, ${vIndex}); manejarOtroCampo(this);">
          <option value="">Seleccione</option>
          <option value="cargue" ${datos.motivo === 'cargue' ? 'selected' : ''}>Cargue</option>
          <option value="descargue" ${datos.motivo === 'descargue' ? 'selected' : ''}>Descargue</option>
          <option value="otro" ${datos.motivo === 'otro' ? 'selected' : ''}>Otro</option>
        </select>
        <input type="text" name="vehiculo_${vIndex}_otro_motivo" placeholder="Especifique otro motivo" class="otro-input" 
              value="${datos.otro_motivo || ''}"
              style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; font-size: 1em; box-sizing: border-box; margin-top: 10px; display: none;">
      </div>
      
      <!-- Tipo de Operaci√≥n -->
      <div style="flex: 1;">
        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Tipo de Operaci√≥n:</label>
        <select id="tipo-operacion-${vIndex}" name="vehiculo_${vIndex}_tipo_operacion"
                style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; font-size: 1em; box-sizing: border-box;">
          <option value="">Seleccione tipo</option>
          <option value="3PD" ${datos.tipo_operacion === '3PD' ? 'selected' : ''}>3PD</option>
          <option value="MQ" ${datos.tipo_operacion === 'MQ' ? 'selected' : ''}>MQ</option>
        </select>
      </div>
    </div>
    
    <!-- Para otros lugares: dise√±o original -->
    <div id="motivo-solo-${vIndex}" style="display: block;">
      <label style="margin-top:5px; display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Motivo:</label>
      <select id="${motivoSelectId}" name="vehiculo_${vIndex}_motivo" required
              onchange="alternarDestinoRemitente(this, ${vIndex}); manejarOtroCampo(this);">
        <option value="">Seleccione</option>
        <option value="cargue" ${datos.motivo === 'cargue' ? 'selected' : ''}>Cargue</option>
        <option value="descargue" ${datos.motivo === 'descargue' ? 'selected' : ''}>Descargue</option>
        <option value="otro" ${datos.motivo === 'otro' ? 'selected' : ''}>Otro</option>
      </select>
      <input type="text" name="vehiculo_${vIndex}_otro_motivo" placeholder="Especifique otro motivo" class="otro-input" value="${datos.otro_motivo || ''}">
    </div>
  </div>

  <div style="margin-bottom: 15px;">
    <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Tipo de Carga:</label>
    <select name="vehiculo_${vIndex}_tipo_carga" id="tipo-carga-${vIndex}"
      style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; font-size: 1em; box-sizing: border-box;">
      <option value="">Seleccione tipo de carga</option>
      <option value="Paletizado" ${datos.tipo_carga === 'Paletizado' ? 'selected' : ''}>Paletizado</option>
      <option value="Arrume" ${datos.tipo_carga === 'Arrume' ? 'selected' : ''}>Arrume</option>
    </select>
  </div>
                  </div>
                  
                  <hr style="margin-top:25px; border-style:dashed;">

                  <div style="display: flex; gap: 20px; align-items: flex-start; margin-bottom: 15px;">
                    <!-- Muelle -->
                    <div style="flex: 1;">
                      <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Muelle:</label>
                      <!-- ‚úÖ DEBE TENER ESTE ID EXACTO -->
                      <select name="vehiculo_${vIndex}_muelle" id="muelle-select-${vIndex}" required onchange="manejarOtroMuelle(${vIndex})"
                          style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; font-size: 1em; box-sizing: border-box;">
                        <option value="">Seleccione</option>
                        <!-- Los muelles se generar√°n din√°micamente -->
                      </select>
                      <input type="number" name="vehiculo_${vIndex}_otro_muelle_num" id="otro_muelle_${vIndex}" class="otro-input" 
                            placeholder="N¬∞ muelle" min="1" max="999" value="${datos.otro_muelle_num || ''}"
                            style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; font-size: 1em; box-sizing: border-box; margin-top: 10px; display: none;">
                    </div>
                    
                    <!-- Placa -->
                    <div style="flex: 1;">
                      <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Placa:</label>
                      <input type="text" name="vehiculo_${vIndex}_placa" required 
                            placeholder="ABC123, 123ABC o A12345" maxlength="6"
                            value="${datos.placa || ''}"
                            oninput="this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '').substring(0,6); guardarProgreso();"
                            style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; font-size: 1em; box-sizing: border-box;">
                    </div>
                  </div>
                  <!-- ‚úÖ TIPO DE VEH√çCULO Y DESTINO/ORIGEN EN UNA SOLA L√çNEA -->
  <div style="display: flex; gap: 20px; margin-bottom: 15px;">
    <!-- TIPO DE VEH√çCULO (siempre visible) -->
    <div style="flex: 1;">
      <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Tipo De Veh√≠culo:</label>
      <select name="vehiculo_${vIndex}_tipo_vehi" required id="tipo_vehi_${vIndex}"
              style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; font-size: 1em; box-sizing: border-box;">
        <option value="">Seleccione</option>
        <option value="Van extralargo" ${datos.tipo_vehi === 'Van extralargo' ? 'selected' : ''}>Van extralargo</option>
        <option value="Camion sencillo furgonado" ${datos.tipo_vehi === 'Camion sencillo furgonado' ? 'selected' : ''}>Cami√≥n sencillo furgonado</option>
        <option value="Camabaja furgonado" ${datos.tipo_vehi === 'Camabaja furgonado' ? 'selected' : ''}>Camabaja furgonado</option>
        <option value="Tractomula furgonado" ${datos.tipo_vehi === 'Tractomula furgonado' ? 'selected' : ''}>Tractomula furgonado</option>
        <option value="Exportacion 35" ${datos.tipo_vehi === 'Exportacion 35' ? 'selected' : ''}>Exportacion 35</option>
        <option value="Exportacion 40" ${datos.tipo_vehi === 'Exportacion 40' ? 'selected' : ''}>Exportacion 40</option>
        <option value="Cama baja con topes" ${datos.tipo_vehi === 'Cama baja con topes' ? 'selected' : ''}>Cama baja con topes</option>
        <option value="Camion sencillo carpado" ${datos.tipo_vehi === 'Camion sencillo carpado' ? 'selected' : ''}>Cami√≥n Sencillo Carpado</option>
        <option value="Camabaja estandar" ${datos.tipo_vehi === 'Camabaja estandar' ? 'selected' : ''}>Camabaja estandar</option>
        <option value="otro" ${datos.tipo_vehi === 'otro' ? 'selected' : ''}>Otro</option>
      </select>
      <input type="text" name="vehiculo_${vIndex}_otro_tipo" id="otro_tipo_${vIndex}" class="otro-input" 
            placeholder="Especifique tipo" value="${datos.otro_tipo || ''}"
            style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; font-size: 1em; box-sizing: border-box; margin-top: 10px; display: none;">
    </div>
    
    <!-- DESTINO/ORIGEN (condicional seg√∫n motivo) -->
    <div style="flex: 1;" id="conditional-destino-origen-${vIndex}">
      <!-- DESTINO (visible solo si motivo = cargue) -->
      <div class="form-group-custom" id="destino-group-${vIndex}" style="${(datos.motivo === 'cargue') ? 'display:block;' : 'display:none;'}">
        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333; margin-top:0;">Destino:</label>
        <select id="destino-select-${vIndex}" name="vehiculo_${vIndex}_destino"
                style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; font-size: 1em; box-sizing: border-box;">
          <option value="">Seleccione Destino</option>
          <option value="BARRANQUILLA" ${datos.destino === 'BARRANQUILLA' ? 'selected' : ''}>BARRANQUILLA</option>
          <option value="CALI" ${datos.destino === 'CALI' ? 'selected' : ''}>CALI</option>
          <option value="BUCARAMANGA" ${datos.destino === 'BUCARAMANGA' ? 'selected' : ''}>BUCARAMANGA</option>
          <option value="MEDELLIN" ${datos.destino === 'MEDELLIN' ? 'selected' : ''}>MEDELLIN</option>
          <option value="MONTERIA" ${datos.destino === 'MONTERIA' ? 'selected' : ''}>MONTERIA</option>
          <option value="GUARNE" ${datos.destino === 'GUARNE' ? 'selected' : ''}>GUARNE</option>
          <option value="PEREIRA" ${datos.destino === 'PEREIRA' ? 'selected' : ''}>PEREIRA</option>
          <option value="PERU" ${datos.destino === 'PERU' ? 'selected' : ''}>PERU</option>
          <option value="ECUADOR" ${datos.destino === 'ECUADOR' ? 'selected' : ''}>ECUADOR</option>
          <option value="FUNZA" ${datos.destino === 'FUNZA' ? 'selected' : ''}>FUNZA</option>
          <option value="BOLIVIA" ${datos.destino === 'BOLIVIA' ? 'selected' : ''}>BOLIVIA</option>
          <option value="SANTO DOMINGO" ${datos.destino === 'SANTO DOMINGO' ? 'selected' : ''}>SANTO DOMINGO</option>
          <option value="LOCALES" ${datos.destino === 'LOCALES' ? 'selected' : ''}>LOCALES</option>
          <option value="INNOVA" ${datos.destino === 'INNOVA' ? 'selected' : ''}>INNOVA</option>
          <option value="CUCUTA" ${datos.destino === 'CUCUTA' ? 'selected' : ''}>CUCUTA</option>
          <option value="LA ESTANCIA" ${datos.destino === 'LA ESTANCIA' ? 'selected' : ''}>LA ESTANCIA</option>
          <option value="CIUDAD BOLIVAR" ${datos.destino === 'CIUDAD BOLIVAR' ? 'selected' : ''}>CIUDAD BOLIVAR</option>
          <option value="VILLAVICENCIO" ${datos.destino === 'VILLAVICENCIO' ? 'selected' : ''}>VILLAVICENCIO</option>
          <option value="ACACIAS" ${datos.destino === 'ACACIAS' ? 'selected' : ''}>ACACIAS</option>
          <option value="otro" ${datos.destino === 'otro' ? 'selected' : ''}>Otro</option>
        </select>
        <input type="text" name="vehiculo_${vIndex}_otro_destino" id="otro_destino_${vIndex}" class="otro-input" 
              placeholder="Especifique otro destino" value="${datos.otro_destino || ''}"
              style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; font-size: 1em; box-sizing: border-box; margin-top: 10px; display: none;">
      </div>
      
      <!-- ORIGEN (visible solo si motivo = descargue) -->
      <div class="form-group-custom" id="remitente-group-${vIndex}" style="${(datos.motivo === 'descargue') ? 'display:block;' : 'display:none;'}">
        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333; margin-top:0;">Origen / Remitente:</label>
        <select id="remitente-select-${vIndex}" name="vehiculo_${vIndex}_origen"
                style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; font-size: 1em; box-sizing: border-box;">
          <option value="">Seleccione Origen</option>
          <option value="BARRANQUILLA" ${datos.origen === 'BARRANQUILLA' ? 'selected' : ''}>BARRANQUILLA</option>
          <option value="CALI" ${datos.origen === 'CALI' ? 'selected' : ''}>CALI</option>
          <option value="BUCARAMANGA" ${datos.origen === 'BUCARAMANGA' ? 'selected' : ''}>BUCARAMANGA</option>
          <option value="MEDELLIN" ${datos.origen === 'MEDELLIN' ? 'selected' : ''}>MEDELLIN</option>
          <option value="MONTERIA" ${datos.origen === 'MONTERIA' ? 'selected' : ''}>MONTERIA</option>
          <option value="GUARNE" ${datos.origen === 'GUARNE' ? 'selected' : ''}>GUARNE</option>
          <option value="PEREIRA" ${datos.origen === 'PEREIRA' ? 'selected' : ''}>PEREIRA</option>
          <option value="PERU" ${datos.origen === 'PERU' ? 'selected' : ''}>PERU</option>
          <option value="ECUADOR" ${datos.origen === 'ECUADOR' ? 'selected' : ''}>ECUADOR</option>
          <option value="FUNZA" ${datos.origen === 'FUNZA' ? 'selected' : ''}>FUNZA</option>
          <option value="BOLIVIA" ${datos.origen === 'BOLIVIA' ? 'selected' : ''}>BOLIVIA</option>
          <option value="SANTO DOMINGO" ${datos.origen === 'SANTO DOMINGO' ? 'selected' : ''}>SANTO DOMINGO</option>
          <option value="LOCALES" ${datos.origen === 'LOCALES' ? 'selected' : ''}>LOCALES</option>
          <option value="INNOVA" ${datos.origen === 'INNOVA' ? 'selected' : ''}>INNOVA</option>
          <option value="CUCUTA" ${datos.origen === 'CUCUTA' ? 'selected' : ''}>CUCUTA</option>
          <option value="LA ESTANCIA" ${datos.origen === 'LA ESTANCIA' ? 'selected' : ''}>LA ESTANCIA</option>
          <option value="CIUDAD BOLIVAR" ${datos.origen === 'CIUDAD BOLIVAR' ? 'selected' : ''}>CIUDAD BOLIVAR</option>
          <option value="VILLAVICENCIO" ${datos.origen === 'VILLAVICENCIO' ? 'selected' : ''}>VILLAVICENCIO</option>
          <option value="ACACIAS" ${datos.origen === 'ACACIAS' ? 'selected' : ''}>ACACIAS</option>
          <option value="otro" ${datos.origen === 'otro' ? 'selected' : ''}>Otro</option>
        </select>
        <input type="text" name="vehiculo_${vIndex}_otro_origen" id="otro_origen_${vIndex}" class="otro-input" 
              placeholder="Especifique otro origen" value="${datos.otro_origen || ''}"
              style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; font-size: 1em; box-sizing: border-box; margin-top: 10px; display: none;">
      </div>
    </div>
  </div>
                  
                  <label>Numero De Personas en Actividad:</label>
                  <input type="number" name="vehiculo_${vIndex}_personas" min="1" required value="${datos.personas || ''}" oninput="generarCamposNombresVehiculo(${vIndex}); guardarProgreso()">
                  
                  <!-- ‚úÖ Contenedor para nombres del personal (NUEVO) -->
                  <div id="nombres-personal-${vIndex}" style="margin-top: 15px;"></div>
                  
                <!-- ‚úÖ CAMPO DE CAJAS MOVIDAS (SOLO LECTURA - SE ACTUALIZA AUTOM√ÅTICAMENTE) -->
  <label>Cajas Movidas:</label>
  <input type="number" name="vehiculo_${vIndex}_cajas" class="cajas-input-js" min="0" readonly
  value="${datos.cajas || '0'}"
  style="background-color: #f8f9fa; font-weight: bold; color: #C76E00;">
  <!-- ‚úÖ √ÅREA DE PICKING CON BOT√ìN -->
  <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; margin-top: 15px; border: 2px solid #001855;">
    <h5 style="margin-top: 0; color: #001855; font-size: 0.95em;">üì¶ Picking de Productos</h5>
    
    <div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 10px;">
    <div style="display: flex; gap: 10px; align-items: center;">
      <input type="text" id="codigo-picking-${vIndex}" placeholder="EAN o c√≥digo especial"
        style="flex: 3; padding: 10px 12px; border: 2px solid #001855; border-radius: 5px; font-size: 1.1em; font-family: Arial, sans-serif;"
        onkeypress="if(event.key === 'Enter') agregarProductoPicking(${vIndex})"
        oninput="validarCodigoPicking(this)">
            
      <button type="button" onclick="agregarProductoPicking(${vIndex})"
              style="flex: 1; background: linear-gradient(135deg, #001855 0%, #003380 100%); color: white; border: none; padding: 12px 100px; border-radius: 5px; font-weight: bold; cursor: pointer; white-space: nowrap; box-shadow: 0 2px 4px rgba(0,0,0,0.2); font-size: 0.95em;">
        ‚ûï Agregar
      </button>
    </div>
    
      <!-- ‚úÖ Bot√≥n de borrar debajo del campo EAN -->
      <button type="button" onclick="document.getElementById('codigo-picking-${vIndex}').value = ''; document.getElementById('codigo-picking-${vIndex}').focus();"
              style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; border: none; padding: 6px 12px; border-radius: 4px; font-weight: bold; cursor: pointer; white-space: nowrap; box-shadow: 0 2px 4px rgba(0,0,0,0.2); font-size: 0.85em; width: 100px; transform: translateX(0px);">
      üóëÔ∏è Borrar
      </button>
  </div>
    
    <div id="feedback-picking-${vIndex}" style="min-height: 30px; margin-top: 8px;"></div>
  </div>

  <!-- ‚úÖ RESUMEN DE PRODUCTOS ESCANEADOS -->
  <div id="resumen-productos-${vIndex}" style="margin-top: 20px; margin-bottom: 15px;"></div>




                  
                  <!-- ‚úÖ BOT√ìN PARA ABRIR JUSTIFICACIONES -->
  <button type="button" onclick="abrirJustificacionesVehiculo(${vIndex})"
          style="background: linear-gradient(135deg, #001855 0%, #003380 100%); color: white; border: none; padding: 12px 20px; border-radius: 5px; font-weight: bold; cursor: pointer; margin: 15px 0; width: 100%; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
      üìã Justificaciones de Retraso
  </button>

  <!-- ‚úÖ CONTENEDOR OCULTO PARA JUSTIFICACIONES (se sincroniza con el overlay) -->
  <div id="justificaciones-contenedor-${vIndex}" style="display: none;"></div>

  <!-- ‚úÖ OVERLAY/MODAL DE JUSTIFICACIONES -->
  <div id="overlay-justificaciones-${vIndex}" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 1000; justify-content: center; align-items: center; padding: 20px;">
    <div style="background: white; padding: 25px; border-radius: 10px; width: 95%; max-width: 800px; max-height: 90vh; overflow-y: auto;">
      <h4 style="text-align: center; color: #C76E00; margin-top: 0;">JUSTIFICACIONES DE RETRASO - VEH√çCULO #${vIndex + 1}</h4>
      <hr style="margin: 15px 0; border-style: dashed;">
      
      <!-- CONTENEDOR DE JUSTIFICACIONES -->
      <div id="justificaciones-overlay-contenedor-${vIndex}" style="margin-bottom: 20px;"></div>
      
      <!-- BOTONES DE ACCI√ìN -->
      <div style="display: flex; gap: 15px; justify-content: center; margin-top: 15px; padding-top: 15px; border-top: 2px solid #001855;">
        <button type="button" onclick="agregarJustificacionOverlay(${vIndex})"
                style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; border: none; padding: 10px 25px; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 1em; flex: 1;">
          ‚ûï Agregar Justificaci√≥n
        </button>
        
        <button type="button" onclick="cerrarJustificacionesVehiculo(${vIndex})"
                style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; padding: 10px 25px; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 1em; flex: 1;">
          ‚úÖ Aceptar
        </button>
      </div>
    </div>
  </div>


  <!-- ‚úÖ BOT√ìN PARA ABRIR NOVEDADES -->


  <!-- ‚úÖ CONTENEDOR OCULTO PARA NOVEDADES (se sincroniza con el overlay) -->
  <div id="novedades-contenedor-${vIndex}" style="display: none;"></div>

  <!-- ‚úÖ OVERLAY/MODAL DE NOVEDADES -->
  <div id="overlay-novedades-${vIndex}" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 1000; justify-content: center; align-items: center; padding: 20px;">
    <div style="background: white; padding: 25px; border-radius: 10px; width: 95%; max-width: 800px; max-height: 90vh; overflow-y: auto;">
      <h4 style="text-align: center; color: #C76E00; margin-top: 0;">NOVEDADES - VEH√çCULO #${vIndex + 1}</h4>
      <hr style="margin: 15px 0; border-style: dashed;">
      
      <!-- CONTENEDOR DE NOVEDADES -->
      <div id="novedades-overlay-contenedor-${vIndex}" style="margin-bottom: 20px;"></div>
      
      <!-- BOTONES DE ACCI√ìN -->
      <div style="display: flex; gap: 15px; justify-content: center; margin-top: 15px; padding-top: 15px; border-top: 2px solid #001855;">
        <button type="button" onclick="agregarNovedadOverlay(${vIndex})"
                style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; border: none; padding: 10px 25px; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 1em; flex: 1;">
          ‚ûï Agregar Novedad
        </button>
        
        <button type="button" onclick="cerrarNovedadesVehiculo(${vIndex})"
                style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; padding: 10px 25px; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 1em; flex: 1;">
          ‚úÖ Aceptar
        </button>
      </div>
    </div>
  </div>

                  
  

                  <button type="button" onclick="abrirNovedadesVehiculo(${vIndex})"
                      style="background: linear-gradient(135deg, #001855 0%, #003380 100%); color: white; border: none; padding: 12px 20px; border-radius: 5px; font-weight: bold; cursor: pointer; margin: 15px 0; width: 100%; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                  üìù Novedades del Veh√≠culo
              </button>



  <!-- ‚úÖ OVERLAY/MODAL DE INSPECCI√ìN (con validaci√≥n visual) -->
  <div id="overlay-inspeccion-${vIndex}" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background: white; padding: 30px; border-radius: 10px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
      <h4 style="text-align: center; color: #C76E00; margin-top: 0;">INSPECCI√ìN DE VEH√çCULO #${vIndex + 1}</h4>
      <hr style="margin: 15px 0; border-style: dashed;">
      
      <!-- INTERIOR CAMI√ìN -->
      <div class="form-group-custom">
          <label style="margin-top:0; font-weight: bold;">INTERIOR CAMI√ìN:</label>
          <select name="vehiculo_${vIndex}_interior_camion" id="interior_camion_${vIndex}" onchange="validarInspeccion(${vIndex})"
                  style="width: 100%; padding: 10px; border: 2px solid #ced4da; border-radius: 5px; font-size: 1em; box-sizing: border-box;">
          <option value="">Seleccione</option>
          <option value="BUENO" ${datos.interior_camion === 'BUENO' ? 'selected' : ''}>BUENO</option>
          <option value="MALO" ${datos.interior_camion === 'MALO' ? 'selected' : ''}>MALO</option>
          </select>
      </div>

      <!-- ESTADO DE LA CARPA -->
      <div class="form-group-custom">
          <label style="margin-top:0; font-weight: bold;">ESTADO DE LA CARPA:</label>
          <select name="vehiculo_${vIndex}_estado_carpa" id="estado_carpa_${vIndex}" onchange="validarInspeccion(${vIndex})"
                  style="width: 100%; padding: 10px; border: 2px solid #ced4da; border-radius: 5px; font-size: 1em; box-sizing: border-box;">
          <option value="">Seleccione</option>
          <option value="BUENO" ${datos.estado_carpa === 'BUENO' ? 'selected' : ''}>BUENO</option>
          <option value="MALO" ${datos.estado_carpa === 'MALO' ? 'selected' : ''}>MALO</option>
          <option value="N/A" ${datos.estado_carpa === 'N/A' ? 'selected' : ''}>N/A</option>
          </select>
      </div>

      <!-- OLORES EXTRA√ëOS -->
      <div class="form-group-custom">
          <label style="margin-top:0; font-weight: bold;">OLORES EXTRA√ëOS:</label>
          <select name="vehiculo_${vIndex}_olores_extranos" id="olores_extranos_${vIndex}" onchange="validarInspeccion(${vIndex})"
                  style="width: 100%; padding: 10px; border: 2px solid #ced4da; border-radius: 5px; font-size: 1em; box-sizing: border-box;">
          <option value="">Seleccione</option>
          <option value="SI" ${datos.olores_extranos === 'SI' ? 'selected' : ''}>SI</option>
          <option value="NO" ${datos.olores_extranos === 'NO' ? 'selected' : ''}>NO</option>
          </select>
      </div>

      <!-- OBJETOS EXTRA√ëOS -->
      <div class="form-group-custom">
          <label style="margin-top:0; font-weight: bold;">OBJETOS EXTRA√ëOS:</label>
          <select name="vehiculo_${vIndex}_objetos_extranos" id="objetos_extranos_${vIndex}" onchange="validarInspeccion(${vIndex})"
                  style="width: 100%; padding: 10px; border: 2px solid #ced4da; border-radius: 5px; font-size: 1em; box-sizing: border-box;">
          <option value="">Seleccione</option>
          <option value="SI" ${datos.objetos_extranos === 'SI' ? 'selected' : ''}>SI</option>
          <option value="NO" ${datos.objetos_extranos === 'NO' ? 'selected' : ''}>NO</option>
          </select>
      </div>

      <!-- EVIDENCIAS DE PLAGAS -->
      <div class="form-group-custom">
          <label style="margin-top:0; font-weight: bold;">EVIDENCIAS DE PLAGAS:</label>
          <select name="vehiculo_${vIndex}_evidencias_plagas" id="evidencias_plagas_${vIndex}" onchange="validarInspeccion(${vIndex})"
                  style="width: 100%; padding: 10px; border: 2px solid #ced4da; border-radius: 5px; font-size: 1em; box-sizing: border-box;">
          <option value="">Seleccione</option>
          <option value="SI" ${datos.evidencias_plagas === 'SI' ? 'selected' : ''}>SI</option>
          <option value="NO" ${datos.evidencias_plagas === 'NO' ? 'selected' : ''}>NO</option>
          </select>
      </div>

      <!-- ESTADO DEL SUELO -->
      <div class="form-group-custom">
          <label style="margin-top:0; font-weight: bold;">ESTADO DEL SUELO:</label>
          <select name="vehiculo_${vIndex}_estado_suelo" id="estado_suelo_${vIndex}" onchange="validarInspeccion(${vIndex})"
                  style="width: 100%; padding: 10px; border: 2px solid #ced4da; border-radius: 5px; font-size: 1em; box-sizing: border-box;">
          <option value="">Seleccione</option>
          <option value="BUENO" ${datos.estado_suelo === 'BUENO' ? 'selected' : ''}>BUENO</option>
          <option value="MALO" ${datos.estado_suelo === 'MALO' ? 'selected' : ''}>MALO</option>
          </select>
      </div>

      <!-- APROBADO -->
      <div class="form-group-custom">
          <label style="margin-top:0; font-weight: bold;">APROBADO:</label>
          <select name="vehiculo_${vIndex}_aprobado" id="aprobado_${vIndex}" onchange="validarInspeccion(${vIndex})"
                  style="width: 100%; padding: 10px; border: 2px solid #ced4da; border-radius: 5px; font-size: 1em; box-sizing: border-box;">
          <option value="">Seleccione</option>
          <option value="SI" ${datos.aprobado === 'SI' ? 'selected' : ''}>SI</option>
          <option value="NO" ${datos.aprobado === 'NO' ? 'selected' : ''}>NO</option>
          </select>
      </div>

      <!-- BOT√ìN ACEPTAR -->
      <div style="text-align: center; margin-top: 25px;">
        <button type="button" onclick="cerrarInspeccionVehiculo(${vIndex})"
                id="btn-aceptar-${vIndex}"
                style="background: linear-gradient(135deg, #001855 0%, #003380 100%); color: white; border: none; padding: 12px 40px; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 1.1em; transition: all 0.3s ease;">
          ‚úÖ Aceptar
        </button>
      </div>
    </div>
  </div>
              `;
              // ‚úÖ MOSTRAR FOTO GUARDADA SI EXISTE
  if (datos.foto_url) {
    const previewFoto = document.getElementById(previewFotoId);
    if (previewFoto) {
      previewFoto.innerHTML = `<img src="${datos.foto_url}" style="max-width: 100%; border-radius: 8px; border: 2px solid #001855;">`;
    }
  }
              
              registro.innerHTML = html;
              contenedor.appendChild(registro);

              
              
              
              // ‚úÖ MOSTRAR/OCULTAR "Tipo de Operaci√≥n" basado en lugar (Santo Domingo)
    const lugar = document.getElementById('lugar').value;
    const containerMotivoTipo = document.getElementById(`motivo-tipo-operacion-container-${vIndex}`);
    const lineaMotivoTipo = document.getElementById(`motivo-tipo-linea-${vIndex}`);
    const motivoSolo = document.getElementById(`motivo-solo-${vIndex}`);
    
    if (containerMotivoTipo && lineaMotivoTipo && motivoSolo) {
      if (lugar === 'SantoDomingo') {
        lineaMotivoTipo.style.display = 'flex';
        motivoSolo.style.display = 'none';
      } else {
        lineaMotivoTipo.style.display = 'none';
        motivoSolo.style.display = 'block';
      }
    }
              
              const origenSelect = document.getElementById(`remitente-select-${vIndex}`);
  if (origenSelect) {
    origenSelect.addEventListener('change', () => manejarOtroOrigen(vIndex));
    // Llamar inmediatamente para mostrar/ocultar "otro" si ya est√° seleccionado
    manejarOtroOrigen(vIndex);
  }
              function manejarOtroOrigen(vIndex) {
    const origenSelect = document.querySelector(`#remitente-select-${vIndex}`);
    const otroInput = document.querySelector(`#otro_origen_${vIndex}`);
    
    if (!origenSelect || !otroInput) return;
    
    if (origenSelect.value === 'otro') {
      otroInput.style.display = 'block';
      otroInput.required = true;
    } else {
      otroInput.style.display = 'none';
      otroInput.required = false;
      otroInput.value = '';
    }
    
    guardarProgreso();
  }
              
              const motivoSelect = document.getElementById(motivoSelectId);
              motivoSelect.addEventListener('change', () => {
                  alternarDestinoRemitente(motivoSelect, vIndex);
                  manejarOtroCampo(motivoSelect);
                  guardarProgreso();
              });

              // ‚úÖ Inicializar visibilidad seg√∫n el valor guardado
              alternarDestinoRemitente(motivoSelect, vIndex);
              
              const selects = registro.querySelectorAll('select');
              selects.forEach(sel => {
                  const otro = sel.nextElementSibling;
                  if (otro && otro.classList.contains('otro-input')) {
                      if (sel.value === 'otro') otro.style.display = 'block';
                      sel.addEventListener('change', () => manejarOtroCampo(sel));
                  }
              });
              
              alternarDestinoRemitente(motivoSelect, vIndex);
              
              const justificacionSelect = registro.querySelector(`select[name="vehiculo_${vIndex}_justificacion"]`);
              if (justificacionSelect) {
                  justificacionSelect.addEventListener('change', () => mostrarTiempoMuerto(justificacionSelect, vIndex));
              }
              
              // ‚úÖ Cargar nombres del personal si existen (NUEVO)
              if (datos.nombres_personal && datos.nombres_personal.length > 0) {
                  const nombresContainer = document.getElementById(`nombres-personal-${vIndex}`);
                  if (nombresContainer) {
                      datos.nombres_personal.forEach((nombre, idx) => {
                          const div = document.createElement('div');
                          div.style.marginBottom = '10px';
                          
                          const label = document.createElement('label');
                          label.textContent = `Nombre del Colaborador # ${idx + 1}:`;
                          label.style.display = 'block';
                          label.style.fontWeight = 'bold';
                          label.style.marginBottom = '5px';
                          label.style.fontSize = '0.9em';
                          label.htmlFor = `vehiculo_${vIndex}_nombre_persona_${idx + 1}`;
                          
                          const input = document.createElement('input');
  input.type = 'text';  // ‚úÖ Cambiar a 'text' para poder usar maxlength
  input.inputmode = 'numeric';  // ‚úÖ Teclado num√©rico en m√≥viles
  input.id = `vehiculo_${vIndex}_nombre_persona_${idx + 1}`;
  input.name = `vehiculo_${vIndex}_nombre_persona_${idx + 1}`;
  input.placeholder = `C√©dula del colaborador ${idx + 1}`;
  input.value = nombre;
  input.required = true;
  input.maxLength = 10;  // ‚úÖ Limitar a m√°ximo 10 caracteres
  input.style.width = '100%';
  input.style.padding = '8px';
  input.style.border = '1px solid #170303';
  input.style.borderRadius = '8px';
  input.style.boxSizing = 'border-box';

  // ‚úÖ Limitar a solo n√∫meros y m√°ximo 10 caracteres
  input.oninput = function() {
    // Eliminar todo excepto n√∫meros
    this.value = this.value.replace(/\D/g, '');
    
    // Limitar a m√°ximo 10 d√≠gitos
    if (this.value.length > 10) {
      this.value = this.value.substring(0, 10);
    }
    
    guardarProgreso();
  };
                          
                          div.appendChild(label);
                          div.appendChild(input);
                          nombresContainer.appendChild(div);
                      });
                  }
              }
              
              // ‚úÖ Generar campos si hay valor en total personas (NUEVO)
              // ‚úÖ Generar campos si hay valor en total personas (CORREGIDO)
              const totalPersonas = datos.personas;
              if (totalPersonas && parseInt(totalPersonas) > 0 && (!datos.nombres_personal || datos.nombres_personal.length === 0)) {
                  generarCamposNombresVehiculo(vIndex);
              }
              
              document.getElementById(fotoInputId).addEventListener('change', function() {
                  let fechaInput = document.getElementById('fecha').value;
                  if (!fechaInput) fechaInput = new Date().toISOString().split('T')[0];
                  
                  const [yyyy, mm, dd] = fechaInput.split('-');
                  const fechaFormateada = `${dd}.${mm}.${yyyy}`;
                  const tipoVehiculo = (datos.tipo_vehi || 'vehiculo').replace(/ /g, '_');
                  const nombrePersonalizado = `${fechaFormateada}.${tipoVehiculo}.vehiculo_${vIndex}`;
                  
                  setupFotoPreview(fotoInputId, previewFotoId, nombrePersonalizado);
              });
          }

  // ‚úÖ CONTADOR DE FOTOS POR VEH√çCULO
  const fotosPorVehiculo = {};

  // ‚úÖ TOMAR FOTO DEL VEH√çCULO
  function tomarFotoVehiculo(vIndex, tipo) {
      const input = document.getElementById(`foto-${tipo}-${vIndex}`);
      if (input) {
          input.click();
      }
  }

  // ‚úÖ PROCESAR FOTO DEL VEH√çCULO
  async function procesarFotoVehiculo(vIndex, tipo, input) {
      const file = input.files[0];
      if (!file || !file.type.match('image.*')) {
          alert('‚ùå Por favor selecciona una imagen v√°lida (JPG/PNG).');
          return;
      }
      
      if (file.size > 5 * 1024 * 1024) {
          alert('‚ö†Ô∏è La imagen es muy grande. M√°ximo 5 MB.');
          return;
      }
      
      const preview = document.getElementById(`preview-${tipo}-${vIndex}`);
      const urlInput = document.getElementById(`url-${tipo}-${vIndex}`);
      const btn = document.getElementById(`btn-foto-${tipo}-${vIndex}`);
      
      // ‚úÖ Mostrar loading
      const textoOriginal = btn.innerHTML;
      btn.innerHTML = '‚è≥ Subiendo...';
      btn.disabled = true;
      
      // ‚úÖ Mostrar preview inmediato
      const reader = new FileReader();
      reader.onload = function(e) {
          preview.innerHTML = `<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 5px;">`;
      };
      reader.readAsDataURL(file);
      
      // ‚úÖ Subir a ImgBB
      try {
          let fechaInput = document.getElementById('fecha').value;
          if (!fechaInput) fechaInput = new Date().toISOString().split('T')[0];
          const [yyyy, mm, dd] = fechaInput.split('-');
          const fechaFormateada = `${dd}.${mm}.${yyyy}`;
          
          const vehiculoData = vehiculosData[vIndex] || {};
          const placa = vehiculoData.placa || `V${vIndex + 1}`;
          
          const nombrePersonalizado = `${fechaFormateada}.${placa}.${tipo}.vehiculo_${vIndex}`;
          
          const urlSubida = await subirFotoImgBB(file, nombrePersonalizado);
          
          if (urlSubida) {
              urlInput.value = urlSubida;
              console.log(`‚úÖ Foto ${tipo} subida correctamente:`, urlSubida);
              
              // ‚úÖ Actualizar contador
              actualizarContadorFotos(vIndex);
              
              // ‚úÖ Actualizar estado
              actualizarEstadoFotos(vIndex);
              
              // ‚úÖ Guardar progreso
              guardarProgreso();
              
              // ‚úÖ Mostrar notificaci√≥n
              mostrarNotificacion(`‚úÖ Foto de ${tipo} subida exitosamente`, 'success');
              
              // ‚úÖ Cambiar estilo del bot√≥n
              btn.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
              btn.innerHTML = '‚úÖ Completado';
          } else {
              console.log('‚ÑπÔ∏è Foto guardada localmente (sin subir a ImgBB)');
              urlInput.value = reader.result;
              actualizarContadorFotos(vIndex);
              btn.innerHTML = '‚ö†Ô∏è Local';
          }
      } catch (error) {
          console.error('‚ùå Error al subir foto:', error);
          mostrarNotificacion('‚ö†Ô∏è Error al subir la foto. Se guardar√° localmente.', 'warning');
          urlInput.value = reader.result;
          btn.innerHTML = textoOriginal;
          btn.disabled = false;
      }
  }

  // ‚úÖ ACTUALIZAR CONTADOR DE FOTOS
  function actualizarContadorFotos(vIndex) {
      let contador = 0;
      ['inicio', 'durante', 'fin'].forEach(tipo => {
          const url = document.getElementById(`url-${tipo}-${vIndex}`)?.value;
          if (url) contador++;
      });
      
      const contadorElement = document.getElementById(`foto-contador-${vIndex}`);
      if (contadorElement) {
          contadorElement.textContent = contador;
          
          // ‚úÖ Animaci√≥n cuando se completa
          if (contador === 3) {
              contadorElement.parentElement.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
              contadorElement.parentElement.style.animation = 'pulse 0.5s ease-in-out';
          }
      }
  }

  // ‚úÖ ACTUALIZAR ESTADO DE FOTOS
  function actualizarEstadoFotos(vIndex) {
      const estadoDiv = document.getElementById(`estado-fotos-${vIndex}`);
      if (!estadoDiv) return;
      
      let fotosCompletadas = [];
      ['inicio', 'durante', 'fin'].forEach(tipo => {
          const url = document.getElementById(`url-${tipo}-${vIndex}`)?.value;
          if (url) fotosCompletadas.push(tipo);
      });
      
      const total = fotosCompletadas.length;
      
      if (total === 0) {
          estadoDiv.innerHTML = 'üí° <strong>Consejo:</strong> Toma fotos en cada etapa para un mejor registro.';
          estadoDiv.style.background = '#d1ecf1';
          estadoDiv.style.color = '#0c5460';
          estadoDiv.style.borderLeftColor = '#17a2b8';
      } else if (total < 3) {
          estadoDiv.innerHTML = `‚úÖ <strong>${total}/3 fotos completadas.</strong> Faltan: ${['inicio', 'durante', 'fin'].filter(t => !fotosCompletadas.includes(t)).join(', ')}`;
          estadoDiv.style.background = '#fff3cd';
          estadoDiv.style.color = '#856404';
          estadoDiv.style.borderLeftColor = '#ffc107';
      } else {
          estadoDiv.innerHTML = 'üéâ <strong>¬°Registro fotogr√°fico completo!</strong> Las 3 fotos fueron tomadas exitosamente.';
          estadoDiv.style.background = '#d4edda';
          estadoDiv.style.color = '#155724';
          estadoDiv.style.borderLeftColor = '#28a745';
      }
  }

  // ‚úÖ RESTAURAR FOTOS AL CARGAR DATOS GUARDADOS
  function restaurarFotosVehiculo(vIndex, datos) {
      ['inicio', 'durante', 'fin'].forEach(tipo => {
          const url = datos[`foto_${tipo}_url`] || '';
          if (url) {
              const preview = document.getElementById(`preview-${tipo}-${vIndex}`);
              const urlInput = document.getElementById(`url-${tipo}-${vIndex}`);
              const btn = document.getElementById(`btn-foto-${tipo}-${vIndex}`);
              
              if (preview && urlInput && btn) {
                  urlInput.value = url;
                  preview.innerHTML = `<img src="${url}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 5px;">`;
                  btn.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
                  btn.innerHTML = '‚úÖ Completado';
              }
          }
      });
      
      actualizarContadorFotos(vIndex);
      actualizarEstadoFotos(vIndex);
  }



          // ‚úÖ ESTADO DE TIEMPO POR VEH√çCULO (ahora incluye modo edici√≥n)
  const estadoTiempoVehiculo = {};

  // ‚úÖ CONTROLAR TIEMPO (Iniciar/Finalizar)
  function controlarTiempoVehiculo(vIndex) {
    const inicioInput = document.getElementById(`inicio-input-${vIndex}`);
    const finInput = document.getElementById(`fin-input-${vIndex}`);
    const btnControl = document.getElementById(`btn-control-tiempo-${vIndex}`);
    const btnEditar = document.getElementById(`btn-editar-tiempo-${vIndex}`);

    // ‚ùå Si est√° en modo edici√≥n, no permitir iniciar/finalizar
    if (estadoTiempoVehiculo[vIndex] === 'editando') {
      alert('‚ö†Ô∏è Primero guarda la edici√≥n antes de iniciar/finalizar.');
      return;
    }

    if (!inicioInput.value) {
      // ‚úÖ INICIAR TIEMPO
      const ahora = new Date();
      const hora = String(ahora.getHours()).padStart(2, '0');
      const minuto = String(ahora.getMinutes()).padStart(2, '0');
      inicioInput.value = `${hora}:${minuto}`;
      applyTimeMask(inicioInput, `cargue-inicio-${vIndex}`);
      
      // Actualizar bot√≥n
      btnControl.innerHTML = '‚èπÔ∏è Finalizar';
      btnControl.style.background = 'linear-gradient(135deg, #dc3545 0%, #c82333 100%)';
      btnControl.style.color = 'white';
      
      // Bloquear edici√≥n mientras est√° activo
      btnEditar.disabled = true;
      btnEditar.style.opacity = '0.7';
      
      // Guardar estado
      estadoTiempoVehiculo[vIndex] = 'iniciado';
      
      guardarProgreso();
      console.log(`‚ñ∂Ô∏è Tiempo iniciado para Veh√≠culo ${vIndex + 1} a las ${inicioInput.value}`);
      
    } else if (!finInput.value) {
      // ‚úÖ FINALIZAR TIEMPO
      if (!confirm(`‚ö†Ô∏è ¬øEst√°s seguro de finalizar el tiempo para el Veh√≠culo ${vIndex + 1}?\n\nEsta acci√≥n registrar√° la hora actual como hora de finalizaci√≥n.`)) {
        return;
      }
      
      const ahora = new Date();
      const hora = String(ahora.getHours()).padStart(2, '0');
      const minuto = String(ahora.getMinutes()).padStart(2, '0');
      finInput.value = `${hora}:${minuto}`;
      applyTimeMask(finInput, `cargue-fin-${vIndex}`);
      
      // Actualizar bot√≥n
      btnControl.innerHTML = '‚úÖ Finalizado';
      btnControl.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
      btnControl.style.color = 'white';
      btnControl.disabled = true;
      
      // Habilitar edici√≥n nuevamente (por si quiere corregir despu√©s)
      btnEditar.disabled = false;
      btnEditar.style.opacity = '1';
      
      // Guardar estado
      estadoTiempoVehiculo[vIndex] = 'finalizado';
      
      guardarProgreso();
      console.log(`‚èπÔ∏è Tiempo finalizado para Veh√≠culo ${vIndex + 1} a las ${finInput.value}`);
      
    } else {
      // ‚úÖ YA FINALIZADO - No hacer nada
      alert('‚úÖ El tiempo ya ha sido finalizado para este veh√≠culo.');
    }
  }

  function editarTiempoVehiculo(vIndex) {
    const inicioInput = document.getElementById(`inicio-input-${vIndex}`);
    const finInput = document.getElementById(`fin-input-${vIndex}`);
    const btnEditar = document.getElementById(`btn-editar-tiempo-${vIndex}`);
    const btnControl = document.getElementById(`btn-control-tiempo-${vIndex}`);
    const btnEliminar = document.getElementById(`btn-eliminar-tiempo-${vIndex}`);
    
    /// ‚úÖ SI EST√Å EN MODO EDICI√ìN ‚Üí GUARDAR
  if (estadoTiempoVehiculo[vIndex] === 'editando') {
    // ‚úÖ Validar formato SOLO si hay contenido
    if (inicioInput.value && !/^\d{2}:\d{2}$/.test(inicioInput.value)) {
      alert('‚ùå Formato de hora de inicio inv√°lido. Usa HH:MM');
      inicioInput.focus();
      return;
    }
    if (finInput.value && !/^\d{2}:\d{2}$/.test(finInput.value)) {
      alert('‚ùå Formato de hora de finalizaci√≥n inv√°lido. Usa HH:MM');
      finInput.focus();
      return;
    }
    // ‚úÖ Validar que final ‚â• inicio SOLO si ambos tienen valor
    if (inicioInput.value && finInput.value) {
      const inicioMin = horaAMinutos(inicioInput.value);
      const finMin = horaAMinutos(finInput.value);
      if (finMin < inicioMin) {
        alert('‚ùå La hora final no puede ser menor que la hora de inicio.');
        finInput.focus();
        return;
      }
    }
    // ‚úÖ Guardar cambios
    btnEditar.innerHTML = '‚úèÔ∏è Editar Tiempo';
    btnEditar.style.background = 'linear-gradient(135deg, #6c757d 0%, #495054 100%)';
    btnEditar.style.color = 'white';
    btnEditar.disabled = false;
    // ‚úÖ Bloquear los campos nuevamente
    inicioInput.readOnly = true;
    finInput.readOnly = true;
    // ‚úÖ Restaurar otros botones
    btnControl.disabled = false;
    btnEliminar.disabled = false;
    // ‚úÖ Ocultar bot√≥n cancelar
    const btnCancelar = document.getElementById(`btn-cancelar-tiempo-${vIndex}`);
    if (btnCancelar) btnCancelar.remove();
    // ‚úÖ Guardar estado
    estadoTiempoVehiculo[vIndex] = 'editado';
    guardarProgreso();
    console.log(`üíæ Cambios guardados para Veh√≠culo ${vIndex + 1}`);
    mostrarNotificacion(`‚úÖ Edici√≥n guardada`, 'success');
    return;
  }
    
    // ‚úÖ SI NO EST√Å EN MODO EDICI√ìN ‚Üí ACTIVAR EDICI√ìN
    if (estadoTiempoVehiculo[vIndex] === 'finalizado') {
      if (!confirm('‚ö†Ô∏è Est√°s editando un tiempo finalizado. ¬øDeseas continuar?')) return;
    }
    
    // ‚úÖ Activar modo edici√≥n
    inicioInput.readOnly = false;
    finInput.readOnly = false;
    inicioInput.focus();
    
    // ‚úÖ Cambiar bot√≥n a "Guardar Edici√≥n"
    btnEditar.innerHTML = 'üíæ Guardar Edici√≥n';
    btnEditar.style.background = 'linear-gradient(135deg, #007bff 0%, #0056b3 100%)';
    btnEditar.style.color = 'white';
    
    // ‚úÖ Bloquear otros botones mientras edita
    btnControl.disabled = true;
    btnEliminar.disabled = true;
    
    // ‚úÖ AGREGAR BOT√ìN "CANCELAR" (NUEVO)
    const btnCancelar = document.createElement('button');
    btnCancelar.id = `btn-cancelar-tiempo-${vIndex}`;
    btnCancelar.type = 'button';
    btnCancelar.innerHTML = '‚ùå Cancelar';
    btnCancelar.style.cssText = `
      flex: 1; 
      min-width: 120px; 
      padding: 10px 15px; 
      background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); 
      color: white; 
      border: none; 
      border-radius: 6px; 
      font-weight: bold; 
      font-size: 0.95em; 
      cursor: pointer; 
      transition: all 0.2s;
    `;
    btnCancelar.onclick = function() {
      cancelarEdicionTiempo(vIndex);
    };
    
    // ‚úÖ Insertar bot√≥n cancelar despu√©s del bot√≥n editar
    btnEditar.parentNode.insertBefore(btnCancelar, btnEditar.nextSibling);
    
    // ‚úÖ Guardar estado
    estadoTiempoVehiculo[vIndex] = 'editando';
    console.log(`‚úèÔ∏è Modo edici√≥n activado para Veh√≠culo ${vIndex + 1}`);
    mostrarNotificacion(`üìù Edici√≥n activada. Cambia las horas o haz clic en "Cancelar" para salir.`, 'warning');
  }

  // ‚úÖ CANCELAR EDICI√ìN DE TIEMPO (NUEVA FUNCI√ìN)
  // ‚úÖ CANCELAR EDICI√ìN DE TIEMPO (CORREGIDO)
  function cancelarEdicionTiempo(vIndex) {
    const inicioInput = document.getElementById(`inicio-input-${vIndex}`);
    const finInput = document.getElementById(`fin-input-${vIndex}`);
    const btnEditar = document.getElementById(`btn-editar-tiempo-${vIndex}`);
    const btnControl = document.getElementById(`btn-control-tiempo-${vIndex}`);
    const btnEliminar = document.getElementById(`btn-eliminar-tiempo-${vIndex}`);
    
    // ‚úÖ Formatear horas antes de cancelar (agrega ceros si es necesario)
    if (inicioInput.value) {
      applyTimeMask(inicioInput, `cargue-inicio-${vIndex}`);
    }
    if (finInput.value) {
      applyTimeMask(finInput, `cargue-fin-${vIndex}`);
    }
    
    // ‚úÖ Bloquear campos nuevamente
    inicioInput.readOnly = true;
    finInput.readOnly = true;
    
    // ‚úÖ Restaurar bot√≥n editar
    btnEditar.innerHTML = '‚úèÔ∏è Editar Tiempo';
    btnEditar.style.background = 'linear-gradient(135deg, #6c757d 0%, #495054 100%)';
    btnEditar.style.color = 'white';
    btnEditar.disabled = false;
    
    // ‚úÖ Restaurar otros botones
    btnControl.disabled = false;
    btnEliminar.disabled = false;
    
    // ‚úÖ Eliminar bot√≥n cancelar
    const btnCancelar = document.getElementById(`btn-cancelar-tiempo-${vIndex}`);
    if (btnCancelar) btnCancelar.remove();
    
    // ‚úÖ Limpiar estado
    delete estadoTiempoVehiculo[vIndex];
    
    guardarProgreso();
    console.log(`‚ùå Edici√≥n cancelada para Veh√≠culo ${vIndex + 1}`);
    mostrarNotificacion(`‚ùå Edici√≥n cancelada`, 'warning');
  }

  // ‚úÖ ELIMINAR TIEMPO (con advertencia y bloqueo durante edici√≥n)
  function eliminarTiempoVehiculo(vIndex) {
    const inicioInput = document.getElementById(`inicio-input-${vIndex}`);
    const finInput = document.getElementById(`fin-input-${vIndex}`);
    const btnControl = document.getElementById(`btn-control-tiempo-${vIndex}`);
    const btnEditar = document.getElementById(`btn-editar-tiempo-${vIndex}`);
    const btnEliminar = document.getElementById(`btn-eliminar-tiempo-${vIndex}`);

    // ‚ùå Si est√° en modo edici√≥n, no permitir eliminar
    if (estadoTiempoVehiculo[vIndex] === 'editando') {
      alert('‚ö†Ô∏è Primero guarda o cancela la edici√≥n antes de eliminar.');
      return;
    }

    if (!inicioInput.value && !finInput.value) {
      alert('‚ÑπÔ∏è No hay tiempo registrado para eliminar.');
      return;
    }

    const mensaje = `üóëÔ∏è ¬øEst√°s seguro de eliminar el registro de tiempo para el Veh√≠culo ${vIndex + 1}?\n\nSe borrar√°n las horas de inicio y finalizaci√≥n.`;

    if (!confirm(mensaje)) return;

    const btnCancelar = document.getElementById(`btn-cancelar-tiempo-${vIndex}`);
    if (btnCancelar) btnCancelar.remove();

    // Limpiar campos
    inicioInput.value = '';
    finInput.value = '';
    document.getElementById(`cargue-inicio-${vIndex}`).innerHTML = '';
    document.getElementById(`cargue-fin-${vIndex}`).innerHTML = '';

    // Restaurar bot√≥n principal
    btnControl.innerHTML = '‚ñ∂Ô∏è Iniciar';
    btnControl.style.background = '';
    btnControl.style.color = '';
    btnControl.disabled = false;

    // Restaurar bot√≥n de editar
    btnEditar.innerHTML = '‚úèÔ∏è Editar Tiempo';
    btnEditar.style.background = 'linear-gradient(135deg, #6c757d 0%, #495054 100%)';
    btnEditar.style.color = 'white';
    btnEditar.disabled = false;

    // Restaurar bot√≥n de eliminar
    btnEliminar.disabled = false;

    // Limpiar estado
    delete estadoTiempoVehiculo[vIndex];

    guardarProgreso();
    console.log(`üóëÔ∏è Tiempo eliminado para Veh√≠culo ${vIndex + 1}`);
    mostrarNotificacion(`üóëÔ∏è Tiempo eliminado`, 'warning');
  }

          // ‚úÖ ABRIR OVERLAY DE NOVEDADES
  function abrirNovedadesVehiculo(vIndex) {
    const overlay = document.getElementById(`overlay-novedades-${vIndex}`);
    const contenedorOverlay = document.getElementById(`novedades-overlay-contenedor-${vIndex}`);
    const contenedorOculto = document.getElementById(`novedades-contenedor-${vIndex}`);
    
    if (!overlay || !contenedorOverlay || !contenedorOculto) {
      console.error('Error: Elementos del overlay no encontrados');
      return;
    }
    
    // Limpiar contenedor del overlay
    contenedorOverlay.innerHTML = '';
    
    // Copiar novedades del contenedor oculto al overlay
    const novedadesOcultas = contenedorOculto.querySelectorAll('.novedad-group');
    novedadesOcultas.forEach((novedadOculta, index) => {
      crearNovedadOverlay(vIndex, index, novedadOculta);
    });
    
    // Si no hay novedades, agregar la primera vac√≠a
    if (contenedorOverlay.children.length === 0) {
      agregarNovedadOverlay(vIndex);
    }
    
    // Mostrar overlay
    overlay.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  } 

  // ‚úÖ AGREGAR NOVEDAD EN EL OVERLAY
  function agregarNovedadOverlay(vIndex) {
    const index = document.getElementById(`novedades-overlay-contenedor-${vIndex}`)?.children.length || 0;
    crearNovedadOverlay(vIndex, index);
  }

  // ‚úÖ CREAR NOVEDAD EN EL OVERLAY
  function crearNovedadOverlay(vIndex, index, datosElemento = null) {
    const contenedor = document.getElementById(`novedades-overlay-contenedor-${vIndex}`);
    if (!contenedor) return;
    
    const div = document.createElement('div');
    div.className = 'novedad-group';
    div.dataset.index = index;
    div.style.border = '2px solid #001855';
    div.style.borderRadius = '8px';
    div.style.padding = '15px';
    div.style.marginBottom = '15px';
    div.style.position = 'relative';
    
    // ‚úÖ Bot√≥n eliminar (arriba a la derecha)
    const botonEliminar = document.createElement('button');
    botonEliminar.type = 'button';
    botonEliminar.className = 'btn-eliminar';
    botonEliminar.innerHTML = 'üóëÔ∏è';
    botonEliminar.style.position = 'absolute';
    botonEliminar.style.top = '5px';
    botonEliminar.style.right = '5px';
    botonEliminar.style.background = '#dc3545';
    botonEliminar.style.color = 'white';
    botonEliminar.style.border = 'none';
    botonEliminar.style.padding = '5px 10px';
    botonEliminar.style.borderRadius = '3px';
    botonEliminar.style.cursor = 'pointer';
    botonEliminar.style.fontSize = '1em';
    botonEliminar.onclick = function() {
      div.remove();
      guardarProgreso();
    };
    
    // ‚úÖ Obtener valores si existe un elemento de datos
    let tipo_novedad = '';
    let descripcion = '';
    let foto_url = '';
    
    if (datosElemento) {
      tipo_novedad = datosElemento.querySelector(`select[name="vehiculo_${vIndex}_tipo_novedad_${index}"]`)?.value || '';
      descripcion = datosElemento.querySelector(`textarea[name="vehiculo_${vIndex}_descripcion_novedad_${index}"]`)?.value || '';
      foto_url = datosElemento.querySelector(`input[name="vehiculo_${vIndex}_foto_novedad_${index}_url"]`)?.value || '';
    }
    
    div.innerHTML = `
      <div style="margin-top: 20px;">
        <!-- Tipo de Novedad -->
        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Tipo de Novedad:</label>
        <select name="vehiculo_${vIndex}_tipo_novedad_${index}_overlay" id="tipo-novedad-overlay-${vIndex}-${index}" 
                style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; font-size: 1em; box-sizing: border-box;">
          <option value="">Seleccione tipo</option>
          <option value="cajas_rotas" ${tipo_novedad === 'cajas_rotas' ? 'selected' : ''}>Cajas rotas</option>
          <option value="faltante_producto" ${tipo_novedad === 'faltante_producto' ? 'selected' : ''}>Faltante de producto</option>
          <option value="sobrante_producto" ${tipo_novedad === 'sobrante_producto' ? 'selected' : ''}>Sobrante de producto</option>
          <option value="estibas_malas" ${tipo_novedad === 'estibas_malas' ? 'selected' : ''}>Estibas malas</option>
          <option value="otro" ${tipo_novedad === 'otro' ? 'selected' : ''}>Otro</option>
        </select>
        
        <!-- Descripci√≥n -->
        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333; margin-top: 10px;">Descripci√≥n:</label>
        <textarea name="vehiculo_${vIndex}_descripcion_novedad_${index}_overlay" id="descripcion-novedad-overlay-${vIndex}-${index}" 
                  placeholder="Describa la novedad" 
                  style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; font-size: 1em; box-sizing: border-box; min-height: 80px; resize: vertical;">${descripcion}</textarea>
        
        <!-- Foto -->
        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333; margin-top: 10px;">Foto de la Novedad:</label>
        <input type="file" name="vehiculo_${vIndex}_foto_novedad_${index}_overlay" id="foto-novedad-${vIndex}-${index}-overlay" 
              accept="image/*" capture="environment"
              style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; font-size: 1em; box-sizing: border-box;">
        <div class="preview-foto" id="preview-foto-novedad-${vIndex}-${index}" style="margin-top: 10px;"></div>
        <input type="hidden" name="vehiculo_${vIndex}_foto_novedad_${index}_url" id="foto-novedad-${vIndex}-${index}-url-overlay" value="${foto_url}">
      </div>
    `;
    
    div.appendChild(botonEliminar);
    contenedor.appendChild(div);
    
    // ‚úÖ Configurar evento de foto con subida autom√°tica
  const fotoInput = div.querySelector(`#foto-novedad-${vIndex}-${index}-overlay`);
  if (fotoInput) {
    fotoInput.addEventListener('change', async function() {
      const preview = document.getElementById(`preview-foto-novedad-${vIndex}-${index}`);
      const fotoUrlInput = document.getElementById(`foto-novedad-${vIndex}-${index}-url-overlay`);
      
      if (this.files && this.files[0]) {
        const file = this.files[0];
        
        // Mostrar preview inmediato
        const reader = new FileReader();
        reader.onload = function(e) {
          preview.innerHTML = `<img src="${e.target.result}" style="max-width: 100%; border-radius: 5px; border: 2px solid #001855;">`;
          // Guardar URL temporal mientras se sube
          fotoUrlInput.value = e.target.result;
        };
        reader.readAsDataURL(file);
        
        // ‚úÖ Subir autom√°ticamente a ImgBB
        try {
          // Generar nombre personalizado
          let fechaInput = document.getElementById('fecha').value;
          if (!fechaInput) fechaInput = new Date().toISOString().split('T')[0];
          const [yyyy, mm, dd] = fechaInput.split('-');
          const fechaFormateada = `${dd}.${mm}.${yyyy}`;
          const tipoNovedad = div.querySelector(`select[name="vehiculo_${vIndex}_tipo_novedad_${index}_overlay"]`)?.value || 'novedad';
          const nombrePersonalizado = `${fechaFormateada}.${tipoNovedad}.novedad_${vIndex}_${index}`;
          
          const urlSubida = await subirFotoImgBB(file, nombrePersonalizado);
          if (urlSubida) {
            fotoUrlInput.value = urlSubida;
            console.log('‚úÖ Foto de novedad subida correctamente:', urlSubida);
          } else {
            console.log('‚ÑπÔ∏è Foto guardada localmente (sin subir a ImgBB)');
          }
          
          // ‚úÖ Guardar progreso despu√©s de subir
          guardarProgreso();
          
        } catch (error) {
          console.error('‚ùå Error al subir foto de novedad:', error);
          alert('‚ö†Ô∏è Error al subir la foto. Se guardar√° localmente.');
        }
      }
    });
  }
  }

  // ‚úÖ CERRAR OVERLAY AL HACER CLIC FUERA
  document.addEventListener('click', function(event) {
    // Buscar todos los overlays de novedades
    const overlays = document.querySelectorAll('[id^="overlay-novedades-"]');
    overlays.forEach(overlay => {
      if (overlay.style.display === 'flex') {
        const contenido = overlay.querySelector('div');
        if (contenido && !contenido.contains(event.target) && event.target === overlay) {
          // Extraer vIndex del ID del overlay
          const vIndex = overlay.id.match(/\d+/)[0];
          cerrarNovedadesVehiculo(parseInt(vIndex));
        }
      }
    });
  });
  // ‚úÖ FUNCI√ìN PARA MOSTRAR NOTIFICACI√ìN TEMPORAL (toast-style)
  function mostrarNotificacion(mensaje, tipo = 'info') {
    // Eliminar notificaci√≥n previa si existe
    const existing = document.getElementById('notificacion-toast');
    if (existing) existing.remove();

    // Crear contenedor
    const toast = document.createElement('div');
    toast.id = 'notificacion-toast';
    toast.style.position = 'fixed';
    toast.style.bottom = '20px';
    toast.style.right = '20px';
    toast.style.zIndex = '9999';
    toast.style.padding = '12px 20px';
    toast.style.borderRadius = '8px';
    toast.style.fontSize = '1em';
    toast.style.fontWeight = '500';
    toast.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
    toast.style.cursor = 'default';
    toast.style.maxWidth = '350px';
    toast.style.textAlign = 'center';
    toast.style.transition = 'opacity 0.3s, transform 0.3s';

    // Estilos por tipo
    switch (tipo) {
      case 'success':
        toast.style.background = '#d4edda';
        toast.style.color = '#155724';
        toast.style.borderLeft = '4px solid #28a745';
        break;
      case 'error':
        toast.style.background = '#f8d7da';
        toast.style.color = '#721c24';
        toast.style.borderLeft = '4px solid #dc3545';
        break;
      case 'warning':
        toast.style.background = '#fff3cd';
        toast.style.color = '#856404';
        toast.style.borderLeft = '4px solid #ffc107';
        break;
      default:
        toast.style.background = '#cce5ff';
        toast.style.color = '#0c5460';
        toast.style.borderLeft = '4px solid #007bff';
    }

    toast.innerHTML = `
      <span>${mensaje}</span>
    `;
    
    document.body.appendChild(toast);

    // Desaparecer despu√©s de 3 segundos
    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateY(100%)';
      setTimeout(() => {
        if (toast.parentNode) toast.parentNode.removeChild(toast);
      }, 300);
    }, 3000);

    // Animaci√≥n de entrada
    setTimeout(() => {
      toast.style.opacity = '1';
      toast.style.transform = 'translateY(0)';
    }, 10);
  }

  // ‚úÖ FUNCI√ìN PARA SUBIR FOTO A IMGBB (misma que fotos de veh√≠culo)
  // ‚úÖ FUNCI√ìN CORREGIDA PARA SUBIR FOTO A IMGBB
  async function subirFotoImgBB(file, nombrePersonalizado) {
    if (!window.imgbbApiKey || window.imgbbApiKey === 'TU_API_KEY_AQUI') {
      console.warn('‚ö†Ô∏è No hay API key de ImgBB v√°lida configurada. Guardando localmente.');
      return null;
    }

    const formData = new FormData();
    formData.append('image', file);
    formData.append('name', nombrePersonalizado);

    try {
      // ‚úÖ CORREGIDO: URL SIN ESPACIOS (clave cr√≠tica)
      const response = await fetch(`https://api.imgbb.com/1/upload?key=${window.imgbbApiKey}`, {
        method: 'POST',
        body: formData
      });

      const result = await response.json();
      
      if (result.success) {
        console.log('‚úÖ Foto subida exitosamente a ImgBB:', result.data.url);
        return result.data.url;
      } else {
        console.warn('‚ùå Error ImgBB:', result.error?.message || 'Error desconocido');
        return null;
      }
    } catch (error) {
      console.error('‚ùå Error de conexi√≥n con ImgBB:', error.message);
      return null;
    }
  }



          // ‚úÖ ABRIR OVERLAY DE JUSTIFICACIONES
  function abrirJustificacionesVehiculo(vIndex) {
    const overlay = document.getElementById(`overlay-justificaciones-${vIndex}`);
    const contenedorOverlay = document.getElementById(`justificaciones-overlay-contenedor-${vIndex}`);
    const contenedorOculto = document.getElementById(`justificaciones-contenedor-${vIndex}`);
    
    if (!overlay || !contenedorOverlay || !contenedorOculto) {
      console.error('Error: Elementos del overlay no encontrados');
      return;
    }
    
    // ‚úÖ Primero guardar progreso para asegurar que los datos est√©n actualizados
    guardarProgreso();
    
    // Limpiar contenedor del overlay
    contenedorOverlay.innerHTML = '';
    
    // ‚úÖ Copiar justificaciones del contenedor oculto al overlay
    const justificacionesOcultas = contenedorOculto.querySelectorAll('.justificacion-group');
    justificacionesOcultas.forEach((justificacionOculta, index) => {
      crearJustificacionOverlay(vIndex, index, justificacionOculta);
    });
    
    // Si no hay justificaciones, agregar la primera vac√≠a
    if (contenedorOverlay.children.length === 0) {
      agregarJustificacionOverlay(vIndex);
    }
    
    // Mostrar overlay
    overlay.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }

  // ‚úÖ ABRIR OVERLAY DE NOVEDADES
  function abrirNovedadesVehiculo(vIndex) {
    const overlay = document.getElementById(`overlay-novedades-${vIndex}`);
    const contenedorOverlay = document.getElementById(`novedades-overlay-contenedor-${vIndex}`);
    const contenedorOculto = document.getElementById(`novedades-contenedor-${vIndex}`);
    
    if (!overlay || !contenedorOverlay || !contenedorOculto) {
      console.error('Error: Elementos del overlay no encontrados');
      return;
    }
    
    // ‚úÖ Primero guardar progreso para asegurar que los datos est√©n actualizados
    guardarProgreso();
    
    // Limpiar contenedor del overlay
    contenedorOverlay.innerHTML = '';
    
    // ‚úÖ Copiar novedades del contenedor oculto al overlay
    const novedadesOcultas = contenedorOculto.querySelectorAll('.novedad-group');
    novedadesOcultas.forEach((novedadOculta, index) => {
      crearNovedadOverlay(vIndex, index, novedadOculta);
    });
    
    // Si no hay novedades, agregar la primera vac√≠a
    if (contenedorOverlay.children.length === 0) {
      agregarNovedadOverlay(vIndex);
    }
    
    // Mostrar overlay
    overlay.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }

  // ‚úÖ VERSI√ìN CORRECTA para justificaciones
  function cerrarJustificacionesVehiculo(vIndex) {
    const contenedorOculto = document.getElementById(`justificaciones-contenedor-${vIndex}`);
    const contenedorOverlay = document.getElementById(`justificaciones-overlay-contenedor-${vIndex}`);
    const overlay = document.getElementById(`overlay-justificaciones-${vIndex}`);
    
    if (!contenedorOculto || !contenedorOverlay || !overlay) return;
    
    contenedorOculto.innerHTML = '';
    
    const justificacionesOverlay = contenedorOverlay.querySelectorAll('.justificacion-group');
    justificacionesOverlay.forEach((justificacionOverlay, index) => {
      const div = document.createElement('div');
      div.className = 'justificacion-group';
      div.dataset.index = index;
      
      const botonEliminar = document.createElement('button');
      botonEliminar.type = 'button';
      botonEliminar.className = 'btn-eliminar';
      botonEliminar.textContent = 'Eliminar';
      botonEliminar.onclick = function() {
        div.remove();
        guardarProgreso();
      };
      
      // ‚úÖ CAPTURAR VALORES EXPL√çCITAMENTE
      const motivoSelect = justificacionOverlay.querySelector(`select[name="vehiculo_${vIndex}_justificacion_${index}_overlay"]`);
      const otroInput = justificacionOverlay.querySelector(`input[name="vehiculo_${vIndex}_otro_justificacion_${index}_overlay"]`);
      const tiempoInicioInput = justificacionOverlay.querySelector(`input[name="vehiculo_${vIndex}_tiempo_muerto_inicio_${index}_overlay"]`);
      const tiempoFinInput = justificacionOverlay.querySelector(`input[name="vehiculo_${vIndex}_tiempo_muerto_final_${index}_overlay"]`);
      
      const motivoValor = motivoSelect?.value || '';
      const otroValor = otroInput?.value || '';
      const tiempoInicioValor = tiempoInicioInput?.value || '';
      const tiempoFinValor = tiempoFinInput?.value || '';
      
      div.innerHTML = `
        <div class="time-row">
          <div>
            <label class="time-label">Tiempo Muerto Inicio:</label>
            <input type="tel" name="vehiculo_${vIndex}_tiempo_muerto_inicio_${index}" class="time-input-masked"
                placeholder="HH:MM" maxlength="5" value="${tiempoInicioValor}"
                onblur="applyTimeMask(this, 'muerto-inicio-${vIndex}-${index}')">
            <span id="muerto-inicio-${vIndex}-${index}" class="time-display"></span>
          </div>
          <div>
            <label class="time-label">Tiempo Muerto Final:</label>
            <input type="tel" name="vehiculo_${vIndex}_tiempo_muerto_final_${index}" class="time-input-masked"
                placeholder="HH:MM" maxlength="5" value="${tiempoFinValor}"
                onblur="applyTimeMask(this, 'muerto-final-${vIndex}-${index}')">
            <span id="muerto-final-${vIndex}-${index}" class="time-display"></span>
          </div>
        </div>
        <label>Motivo:</label>
        <select name="vehiculo_${vIndex}_justificacion_${index}">
          <option value="">Seleccione motivo</option>
          <option value="faltante_producto" ${motivoValor === 'faltante_producto' ? 'selected' : ''}>Faltante de producto</option>
          <option value="liberacion_calidad" ${motivoValor === 'liberacion_calidad' ? 'selected' : ''}>Liberacion de calidad</option>
          <option value="Da√±os" ${motivoValor === 'Da√±os' ? 'selected' : ''}>Da√±os (electricos, muelle, montacargas, etc.)</option>
          <option value="otro" ${motivoValor === 'otro' ? 'selected' : ''}>Otro</option>
        </select>
        <input type="text" name="vehiculo_${vIndex}_otro_justificacion_${index}" placeholder="Especifique la incidencia" class="otro-input" 
              value="${otroValor}" style="${motivoValor === 'otro' ? 'display: block;' : 'display: none;'}">
      `;
      
      div.appendChild(botonEliminar);
      contenedorOculto.appendChild(div);
      
      // Configurar evento onchange
      const nuevoMotivoSelect = div.querySelector(`select[name="vehiculo_${vIndex}_justificacion_${index}"]`);
      const nuevoOtroInput = div.querySelector(`input[name="vehiculo_${vIndex}_otro_justificacion_${index}"]`);
      if (nuevoMotivoSelect && nuevoOtroInput) {
        nuevoMotivoSelect.addEventListener('change', function() {
          if (this.value === 'otro') {
            nuevoOtroInput.style.display = 'block';
          } else {
            nuevoOtroInput.style.display = 'none';
            nuevoOtroInput.value = '';
          }
          guardarProgreso();
        });
      }
    });
    
    overlay.style.display = 'none';
    document.body.style.overflow = 'auto';
    guardarProgreso();
  }


  // ‚úÖ CERRAR OVERLAY DE NOVEDADES (CORREGIDO - Captura valores expl√≠citamente)
  function cerrarNovedadesVehiculo(vIndex) {
    const contenedorOculto = document.getElementById(`novedades-contenedor-${vIndex}`);
    const contenedorOverlay = document.getElementById(`novedades-overlay-contenedor-${vIndex}`);
    const overlay = document.getElementById(`overlay-novedades-${vIndex}`);
    
    if (!contenedorOculto || !contenedorOverlay || !overlay) return;
    
    // Limpiar contenedor oculto
    contenedorOculto.innerHTML = '';
    
    // ‚úÖ Copiar novedades del overlay al contenedor oculto
    const novedadesOverlay = contenedorOverlay.querySelectorAll('.novedad-group');
    novedadesOverlay.forEach((novedadOverlay, index) => {
      const div = document.createElement('div');
      div.className = 'novedad-group';
      div.dataset.index = index;
      
      const botonEliminar = document.createElement('button');
      botonEliminar.type = 'button';
      botonEliminar.className = 'btn-eliminar';
      botonEliminar.textContent = 'Eliminar';
      botonEliminar.onclick = function() {
        div.remove();
        guardarProgreso();
      };
      
      // ‚úÖ CAPTURAR VALORES EXPL√çCITAMENTE (NO USAR cloneNode)
      const tipoSelect = novedadOverlay.querySelector(`select[name="vehiculo_${vIndex}_tipo_novedad_${index}_overlay"]`);
      const descripcionTextarea = novedadOverlay.querySelector(`textarea[name="vehiculo_${vIndex}_descripcion_novedad_${index}_overlay"]`);
      const fotoUrlInput = novedadOverlay.querySelector(`input[name="vehiculo_${vIndex}_foto_novedad_${index}_url_overlay"]`);
      
      const tipoValor = tipoSelect?.value || '';
      const descripcionValor = descripcionTextarea?.value || '';
      const fotoUrlValor = fotoUrlInput?.value || '';
      
      // ‚úÖ LOG DE DEPURACI√ìN
      console.log(`üíæ Guardando novedad ${index}:`, {
        tipo: tipoValor,
        descripcion: descripcionValor,
        foto_url: fotoUrlValor
      });
      
      div.innerHTML = `
        <label>Tipo de Novedad:</label>
        <select name="vehiculo_${vIndex}_tipo_novedad_${index}">
          <option value="">Seleccione tipo</option>
          <option value="cajas_rotas" ${tipoValor === 'cajas_rotas' ? 'selected' : ''}>Cajas rotas</option>
          <option value="faltante_producto" ${tipoValor === 'faltante_producto' ? 'selected' : ''}>Faltante de producto</option>
          <option value="sobrante_producto" ${tipoValor === 'sobrante_producto' ? 'selected' : ''}>Sobrante de producto</option>
          <option value="estibas_malas" ${tipoValor === 'estibas_malas' ? 'selected' : ''}>Estibas malas</option>
          <option value="otro" ${tipoValor === 'otro' ? 'selected' : ''}>Otro</option>
        </select>
        
        <label>Descripci√≥n:</label>
        <textarea name="vehiculo_${vIndex}_descripcion_novedad_${index}" placeholder="Describa la novedad">${descripcionValor}</textarea>
        
        <label>Foto de la Novedad:</label>
        <div class="preview-foto" style="margin-top: 10px;">
          ${fotoUrlValor ? `<img src="${fotoUrlValor}" style="max-width: 100%; border-radius: 5px; border: 2px solid #001855;">` : ''}
        </div>
        <input type="hidden" name="vehiculo_${vIndex}_foto_novedad_${index}_url" value="${fotoUrlValor}">
      `;
      
      div.appendChild(botonEliminar);
      contenedorOculto.appendChild(div);
    });
    
    // Ocultar overlay
    overlay.style.display = 'none';
    document.body.style.overflow = 'auto';
    
    // ‚úÖ Guardar progreso despu√©s de cerrar
    guardarProgreso();
    
    // ‚úÖ LOG DE DEPURACI√ìN
    console.log(`‚úÖ Novedades guardadas para Veh√≠culo ${vIndex + 1}`);
  }

  // ‚úÖ AGREGAR JUSTIFICACI√ìN EN EL OVERLAY
  function agregarJustificacionOverlay(vIndex) {
    const index = document.getElementById(`justificaciones-overlay-contenedor-${vIndex}`)?.children.length || 0;
    crearJustificacionOverlay(vIndex, index);
  }

  // ‚úÖ CREAR JUSTIFICACI√ìN EN EL OVERLAY
  function crearJustificacionOverlay(vIndex, index, datosElemento = null) {
    const contenedor = document.getElementById(`justificaciones-overlay-contenedor-${vIndex}`);
    if (!contenedor) return;
    
    const div = document.createElement('div');
    div.className = 'justificacion-group';
    div.dataset.index = index;
    div.style.border = '2px solid #001855';
    div.style.borderRadius = '8px';
    div.style.padding = '15px';
    div.style.marginBottom = '15px';
    div.style.position = 'relative';
    
    // ‚úÖ Bot√≥n eliminar (arriba a la derecha)
    const botonEliminar = document.createElement('button');
    botonEliminar.type = 'button';
    botonEliminar.className = 'btn-eliminar';
    botonEliminar.innerHTML = 'üóëÔ∏è';
    botonEliminar.style.position = 'absolute';
    botonEliminar.style.top = '5px';
    botonEliminar.style.right = '5px';
    botonEliminar.style.background = '#dc3545';
    botonEliminar.style.color = 'white';
    botonEliminar.style.border = 'none';
    botonEliminar.style.padding = '5px 10px';
    botonEliminar.style.borderRadius = '3px';
    botonEliminar.style.cursor = 'pointer';
    botonEliminar.style.fontSize = '1em';
    botonEliminar.onclick = function() {
      div.remove();
      guardarProgreso();
    };
    
    // ‚úÖ Obtener valores si existe un elemento de datos
    let justificacion = '';
    let otro_justificacion = '';
    let tiempo_muerto_inicio = '';
    let tiempo_muerto_final = '';
    
    if (datosElemento) {
      justificacion = datosElemento.querySelector(`select[name="vehiculo_${vIndex}_justificacion_${index}"]`)?.value || '';
      otro_justificacion = datosElemento.querySelector(`input[name="vehiculo_${vIndex}_otro_justificacion_${index}"]`)?.value || '';
      tiempo_muerto_inicio = datosElemento.querySelector(`input[name="vehiculo_${vIndex}_tiempo_muerto_inicio_${index}"]`)?.value || '';
      tiempo_muerto_final = datosElemento.querySelector(`input[name="vehiculo_${vIndex}_tiempo_muerto_final_${index}"]`)?.value || '';
    }
    
    const dInicio = `muerto-inicio-${vIndex}-${index}-overlay`;
    const dFin = `muerto-final-${vIndex}-${index}-overlay`;
    
    div.innerHTML = `
      <!-- ‚úÖ SISTEMA INTELIGENTE DE CONTROL DE TIEMPO MUERTO -->
  <div style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
    <div class="time-row" style="margin-bottom: 12px;">
      <div>
        <label class="time-label">Tiempo Muerto Inicio (HH:MM):</label>
        <input type="tel" name="vehiculo_${vIndex}_tiempo_muerto_inicio_${index}_overlay" id="tm-inicio-${vIndex}-${index}" class="time-input-masked"
            placeholder="HH:MM" maxlength="5" value="${tiempo_muerto_inicio}"
            onblur="applyTimeMask(this, '${dInicio}')"
            readonly
            style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 1em; box-sizing: border-box;">
        <span id="${dInicio}" class="time-display"></span>
      </div>
      <div>
        <label class="time-label">Tiempo Muerto Final (HH:MM):</label>
        <input type="tel" name="vehiculo_${vIndex}_tiempo_muerto_final_${index}_overlay" id="tm-fin-${vIndex}-${index}" class="time-input-masked"
            placeholder="HH:MM" maxlength="5" value="${tiempo_muerto_final}"
            onblur="applyTimeMask(this, '${dFin}')"
            readonly
            style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 1em; box-sizing: border-box;">
        <span id="${dFin}" class="time-display"></span>
      </div>
    </div>

  <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">
    <!-- Bot√≥n Iniciar/Finalizar -->
    <button type="button" id="btn-tm-control-${vIndex}-${index}"
      onclick="controlarTiempoMuerto(${vIndex}, ${index})"
      style="flex: 1; min-width: 120px; padding: 10px 15px; border: none; border-radius: 6px; font-weight: bold; font-size: 0.95em; cursor: pointer; transition: all 0.2s;">
      ${tiempo_muerto_inicio ? '‚èπÔ∏è Finalizar' : '‚ñ∂Ô∏è Iniciar'}
    </button>
    <!-- Bot√≥n Editar -->
    <button type="button" id="btn-tm-editar-${vIndex}-${index}"
      onclick="editarTiempoMuerto(${vIndex}, ${index})"
      style="flex: 1; min-width: 120px; padding: 10px 15px; background: linear-gradient(135deg, #6c757d 0%, #495054 100%); color: white; border: none; border-radius: 6px; font-weight: bold; font-size: 0.95em; cursor: pointer; transition: all 0.2s;">
      ‚úèÔ∏è Editar Tiempo
    </button>
    <!-- ‚úÖ Bot√≥n Cancelar (NUEVO - igual que cargue/descargue) -->
    <button type="button" id="btn-tm-cancelar-${vIndex}-${index}"
      onclick="cancelarEdicionTiempoMuerto(${vIndex}, ${index})"
      style="flex: 1; min-width: 120px; padding: 10px 15px; background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; border: none; border-radius: 6px; font-weight: bold; font-size: 0.95em; cursor: pointer; transition: all 0.2s; display: none;">
      ‚ùå Cancelar
    </button>
    <!-- Bot√≥n Eliminar -->
    <button type="button" id="btn-tm-eliminar-${vIndex}-${index}"
      onclick="eliminarTiempoMuerto(${vIndex}, ${index})"
      style="flex: 1; min-width: 120px; padding: 10px 15px; background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; border: none; border-radius: 6px; font-weight: bold; font-size: 0.95em; cursor: pointer; transition: all 0.2s;">
      üóëÔ∏è Eliminar
    </button>
  </div>
  </div>
        
        <!-- Motivo -->
        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333; margin-top: 10px;">Motivo:</label>
        <select name="vehiculo_${vIndex}_justificacion_${index}_overlay" id="justificacion-overlay-${vIndex}-${index}" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; font-size: 1em; box-sizing: border-box;">
          <option value="">Seleccione motivo</option>
          <option value="faltante_producto" ${justificacion === 'faltante_producto' ? 'selected' : ''}>Faltante de producto</option>
          <option value="liberacion_calidad" ${justificacion === 'liberacion_calidad' ? 'selected' : ''}>Liberacion de calidad</option>
          <option value="Da√±os" ${justificacion === 'Da√±os' ? 'selected' : ''}>Da√±os (electricos, muelle, montacargas, etc.)</option>
          <option value="otro" ${justificacion === 'otro' ? 'selected' : ''}>Otro</option>
        </select>
        
        <!-- Otro motivo -->
        <input type="text" name="vehiculo_${vIndex}_otro_justificacion_${index}_overlay" id="otro-justificacion-overlay-${vIndex}-${index}" 
              placeholder="Especifique la incidencia" class="otro-input" value="${otro_justificacion}"
              style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; font-size: 1em; box-sizing: border-box; margin-top: 10px; display: ${justificacion === 'otro' ? 'block' : 'none'};">
      </div>
    `;
    
    div.appendChild(botonEliminar);
    contenedor.appendChild(div);
    
    // ‚úÖ Configurar evento onchange para mostrar/ocultar "otro motivo"
    const justificacionSelect = div.querySelector(`#justificacion-overlay-${vIndex}-${index}`);
    const otroJustificacionInput = div.querySelector(`#otro-justificacion-overlay-${vIndex}-${index}`);
    
    if (justificacionSelect && otroJustificacionInput) {
      justificacionSelect.addEventListener('change', function() {
        if (this.value === 'otro') {
          otroJustificacionInput.style.display = 'block';
          otroJustificacionInput.required = true;
        } else {
          otroJustificacionInput.style.display = 'none';
          otroJustificacionInput.required = false;
          otroJustificacionInput.value = '';
        }
        guardarProgreso();
      });
    }
    
    // ‚úÖ Configurar eventos de tiempo
    const inputsTiempo = div.querySelectorAll('.time-input-masked');
    inputsTiempo.forEach(input => {
      input.addEventListener('input', function() {
        this.value = this.value.replace(/[^0-9]/g, '').substring(0, 5);
      });
    });
  }

  // ‚úÖ CERRAR OVERLAY AL HACER CLIC FUERA
  document.addEventListener('click', function(event) {
    // Buscar todos los overlays de justificaciones
    const overlays = document.querySelectorAll('[id^="overlay-justificaciones-"]');
    overlays.forEach(overlay => {
      if (overlay.style.display === 'flex') {
        const contenido = overlay.querySelector('div');
        if (contenido && !contenido.contains(event.target) && event.target === overlay) {
          // Extraer vIndex del ID del overlay
          const vIndex = overlay.id.match(/\d+/)[0];
          cerrarJustificacionesVehiculo(parseInt(vIndex));
        }
      }
    });
  });

  // ‚úÖ ESTADO DE TIEMPO MUERTO POR VEH√çCULO Y √çNDICE
  const estadoTiempoMuerto = {};

  // ‚úÖ CONTROLAR TIEMPO MUERTO (Iniciar/Finalizar)
  function controlarTiempoMuerto(vIndex, nIndex) {
    const inicioInput = document.getElementById(`tm-inicio-${vIndex}-${nIndex}`);
    const finInput = document.getElementById(`tm-fin-${vIndex}-${nIndex}`);
    const btnControl = document.getElementById(`btn-tm-control-${vIndex}-${nIndex}`);
    const btnEditar = document.getElementById(`btn-tm-editar-${vIndex}-${nIndex}`);

    // ‚ùå Si est√° en modo edici√≥n, no permitir iniciar/finalizar
    if (estadoTiempoMuerto[`${vIndex}-${nIndex}`] === 'editando') {
      alert('‚ö†Ô∏è Primero guarda la edici√≥n antes de iniciar/finalizar.');
      return;
    }

    if (!inicioInput.value) {
      // ‚úÖ INICIAR TIEMPO
      const ahora = new Date();
      const hora = String(ahora.getHours()).padStart(2, '0');
      const minuto = String(ahora.getMinutes()).padStart(2, '0');
      inicioInput.value = `${hora}:${minuto}`;
      applyTimeMask(inicioInput, `muerto-inicio-${vIndex}-${nIndex}`);
      
      btnControl.innerHTML = '‚èπÔ∏è Finalizar';
      btnControl.style.background = 'linear-gradient(135deg, #dc3545 0%, #c82333 100%)';
      btnControl.style.color = 'white';
      btnEditar.disabled = true;
      btnEditar.style.opacity = '0.7';
      
      estadoTiempoMuerto[`${vIndex}-${nIndex}`] = 'iniciado';
      guardarProgreso();
      console.log(`‚ñ∂Ô∏è Tiempo muerto iniciado para Veh√≠culo ${vIndex + 1} - Justificaci√≥n ${nIndex + 1}`);
      
    } else if (!finInput.value) {
      // ‚úÖ FINALIZAR TIEMPO
      if (!confirm(`‚ö†Ô∏è ¬øEst√°s seguro de finalizar el tiempo muerto para la justificaci√≥n #${nIndex + 1} del Veh√≠culo ${vIndex + 1}?`)) return;
      
      const ahora = new Date();
      const hora = String(ahora.getHours()).padStart(2, '0');
      const minuto = String(ahora.getMinutes()).padStart(2, '0');
      finInput.value = `${hora}:${minuto}`;
      applyTimeMask(finInput, `muerto-fin-${vIndex}-${nIndex}`);
      
      btnControl.innerHTML = '‚úÖ Finalizado';
      btnControl.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
      btnControl.style.color = 'white';
      btnControl.disabled = true;
      btnEditar.disabled = false;
      btnEditar.style.opacity = '1';
      
      estadoTiempoMuerto[`${vIndex}-${nIndex}`] = 'finalizado';
      guardarProgreso();
      console.log(`‚èπÔ∏è Tiempo muerto finalizado para Veh√≠culo ${vIndex + 1} - Justificaci√≥n ${nIndex + 1}`);
      
    } else {
      alert('‚úÖ El tiempo muerto ya ha sido finalizado.');
    }
  }

  // ‚úÖ EDITAR TIEMPO MUERTO
  // ‚úÖ EDITAR TIEMPO MUERTO (CORREGIDO: Agrega bot√≥n Cancelar y desbloquea campos)
  function editarTiempoMuerto(vIndex, nIndex) {
    const inicioInput = document.getElementById(`tm-inicio-${vIndex}-${nIndex}`);
    const finInput = document.getElementById(`tm-fin-${vIndex}-${nIndex}`);
    const btnEditar = document.getElementById(`btn-tm-editar-${vIndex}-${nIndex}`);
    const btnControl = document.getElementById(`btn-tm-control-${vIndex}-${nIndex}`);
    const btnEliminar = document.getElementById(`btn-tm-eliminar-${vIndex}-${nIndex}`);
    const contenedorBotones = btnEditar.parentElement; // Contenedor de los botones

    if (!inicioInput || !finInput || !btnEditar) return;

    // ‚úÖ SI EST√Å EN MODO EDICI√ìN ‚Üí GUARDAR
    if (estadoTiempoMuerto[`${vIndex}-${nIndex}`] === 'editando') {
      // Validaciones al guardar
      if (inicioInput.value && !/^\d{2}:\d{2}$/.test(inicioInput.value)) {
        alert('‚ùå Formato de hora de inicio inv√°lido. Usa HH:MM');
        return;
      }
      if (finInput.value && !/^\d{2}:\d{2}$/.test(finInput.value)) {
        alert('‚ùå Formato de hora de finalizaci√≥n inv√°lido. Usa HH:MM');
        return;
      }
      
      const inicioMin = horaAMinutos(inicioInput.value);
      const finMin = horaAMinutos(finInput.value);
      if (inicioMin && finMin && finMin < inicioMin) {
        alert('‚ùå La hora final no puede ser menor que la hora de inicio.');
        return;
      }

      // Guardar cambios
      btnEditar.innerHTML = '‚úèÔ∏è Editar Tiempo';
      btnEditar.style.background = 'linear-gradient(135deg, #6c757d 0%, #495054 100%)';
      inicioInput.readOnly = true;
      finInput.readOnly = true;
      
      // Restaurar otros botones
      if(btnControl) btnControl.disabled = false;
      if(btnEliminar) btnEliminar.disabled = false;
      
      // Eliminar bot√≥n cancelar
      const btnCancelar = document.getElementById(`btn-tm-cancelar-${vIndex}-${nIndex}`);
      if (btnCancelar) btnCancelar.remove();

      estadoTiempoMuerto[`${vIndex}-${nIndex}`] = 'editado';
      guardarProgreso();
      mostrarNotificacion(`‚úÖ Edici√≥n guardada`, 'success');
      return;
    }

    // ‚úÖ ACTIVAR MODO EDICI√ìN
    if (estadoTiempoMuerto[`${vIndex}-${nIndex}`] === 'finalizado') {
      if (!confirm('‚ö†Ô∏è Est√°s editando un tiempo muerto finalizado. ¬øDeseas continuar?')) return;
    }

    // Desbloquear campos para escribir
    inicioInput.readOnly = false;
    finInput.readOnly = false;
    inicioInput.focus();
    inicioInput.select(); // Seleccionar texto para facilitar edici√≥n

    // Cambiar bot√≥n a "Guardar"
    btnEditar.innerHTML = 'üíæ Guardar Edici√≥n';
    btnEditar.style.background = 'linear-gradient(135deg, #007bff 0%, #0056b3 100%)';

    // Bloquear otros botones temporalmente
    if(btnControl) btnControl.disabled = true;
    if(btnEliminar) btnEliminar.disabled = true;

    // ‚úÖ CREAR BOT√ìN CANCELAR SI NO EXISTE
    let btnCancelar = document.getElementById(`btn-tm-cancelar-${vIndex}-${nIndex}`);
    if (!btnCancelar) {
      btnCancelar = document.createElement('button');
      btnCancelar.id = `btn-tm-cancelar-${vIndex}-${nIndex}`;
      btnCancelar.type = 'button';
      btnCancelar.innerHTML = '‚ùå Cancelar';
      btnCancelar.style.cssText = `
        flex: 1; min-width: 100px; padding: 10px 15px; 
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); 
        color: white; border: none; border-radius: 6px; 
        font-weight: bold; font-size: 0.85em; cursor: pointer; margin-left: 5px;
      `;
      btnCancelar.onclick = function() {
        // L√≥gica de Cancelar: Restaurar valores originales (opcional) o simplemente salir
        inicioInput.readOnly = true;
        finInput.readOnly = true;
        btnEditar.innerHTML = '‚úèÔ∏è Editar Tiempo';
        btnEditar.style.background = 'linear-gradient(135deg, #6c757d 0%, #495054 100%)';
        if(btnControl) btnControl.disabled = false;
        if(btnEliminar) btnEliminar.disabled = false;
        btnCancelar.remove();
        delete estadoTiempoMuerto[`${vIndex}-${nIndex}`];
        mostrarNotificacion(`‚ùå Edici√≥n cancelada`, 'warning');
      };
      // Insertar despu√©s del bot√≥n Editar
      contenedorBotones.insertBefore(btnCancelar, btnEditar.nextSibling);
    } else {
      btnCancelar.style.display = 'block';
    }

    estadoTiempoMuerto[`${vIndex}-${nIndex}`] = 'editando';
    mostrarNotificacion(`üìù Escribe las horas y haz clic en "Guardar Edici√≥n"`, 'info');
  }

  // ‚úÖ ELIMINAR TIEMPO MUERTO
  function eliminarTiempoMuerto(vIndex, nIndex) {
    const inicioInput = document.getElementById(`tm-inicio-${vIndex}-${nIndex}`);
    const finInput = document.getElementById(`tm-fin-${vIndex}-${nIndex}`);
    const btnControl = document.getElementById(`btn-tm-control-${vIndex}-${nIndex}`);
    const btnEditar = document.getElementById(`btn-tm-editar-${vIndex}-${nIndex}`);
    const btnEliminar = document.getElementById(`btn-tm-eliminar-${vIndex}-${nIndex}`);

    if (estadoTiempoMuerto[`${vIndex}-${nIndex}`] === 'editando') {
      alert('‚ö†Ô∏è Primero guarda o cancela la edici√≥n antes de eliminar.');
      return;
    }

    if (!inicioInput.value && !finInput.value) {
      alert('‚ÑπÔ∏è No hay tiempo muerto registrado para eliminar.');
      return;
    }

    if (!confirm(`üóëÔ∏è ¬øEst√°s seguro de eliminar el tiempo muerto para la justificaci√≥n #${nIndex + 1} del Veh√≠culo ${vIndex + 1}?`)) return;

    inicioInput.value = '';
    finInput.value = '';
    document.getElementById(`muerto-inicio-${vIndex}-${nIndex}`).innerHTML = '';
    document.getElementById(`muerto-fin-${vIndex}-${nIndex}`).innerHTML = '';

    btnControl.innerHTML = '‚ñ∂Ô∏è Iniciar';
    btnControl.style.background = '';
    btnControl.style.color = '';
    btnControl.disabled = false;
    // ‚úÖ Guardar cambios
  btnEditar.innerHTML = '‚úèÔ∏è Editar Tiempo';
  btnEditar.style.background = 'linear-gradient(135deg, #6c757d 0%, #495054 100%)';
  btnEditar.style.color = 'white';
  inicioInput.readOnly = true;
  finInput.readOnly = true;
  btnControl.disabled = false;
  btnEliminar.disabled = false;

  // ‚úÖ Ocultar bot√≥n cancelar (NUEVO)
  const btnCancelar = document.getElementById(`btn-tm-cancelar-${vIndex}-${nIndex}`);
  if (btnCancelar) btnCancelar.style.display = 'none';

  estadoTiempoMuerto[`${vIndex}-${nIndex}`] = 'editado';
  guardarProgreso();
  mostrarNotificacion(`‚úÖ Edici√≥n guardada`, 'success');
  return;
  }

  // ‚úÖ CANCELAR EDICI√ìN TIEMPO MUERTO (NUEVA - igual que cargue/descargue)
  function cancelarEdicionTiempoMuerto(vIndex, nIndex) {
    const inicioInput = document.getElementById(`tm-inicio-${vIndex}-${nIndex}`);
    const finInput = document.getElementById(`tm-fin-${vIndex}-${nIndex}`);
    const btnEditar = document.getElementById(`btn-tm-editar-${vIndex}-${nIndex}`);
    const btnControl = document.getElementById(`btn-tm-control-${vIndex}-${nIndex}`);
    const btnEliminar = document.getElementById(`btn-tm-eliminar-${vIndex}-${nIndex}`);
    const btnCancelar = document.getElementById(`btn-tm-cancelar-${vIndex}-${nIndex}`);
    
    // ‚úÖ Bloquear campos nuevamente
    inicioInput.readOnly = true;
    finInput.readOnly = true;
    
    // ‚úÖ Restaurar bot√≥n editar
    btnEditar.innerHTML = '‚úèÔ∏è Editar Tiempo';
    btnEditar.style.background = 'linear-gradient(135deg, #6c757d 0%, #495054 100%)';
    btnEditar.style.color = 'white';
    btnEditar.disabled = false;
    
    // ‚úÖ Restaurar otros botones
    btnControl.disabled = false;
    btnEliminar.disabled = false;
    
    // ‚úÖ Ocultar bot√≥n cancelar
    btnCancelar.style.display = 'none';
    
    // ‚úÖ Limpiar estado
    delete estadoTiempoMuerto[`${vIndex}-${nIndex}`];
    
    guardarProgreso();
    console.log(`‚ùå Edici√≥n cancelada para Justificaci√≥n ${nIndex + 1} del Veh√≠culo ${vIndex + 1}`);
    mostrarNotificacion(`‚ùå Edici√≥n cancelada`, 'warning');
  }

  function abrirInspeccionVehiculo(vIndex) {
      const overlay = document.getElementById(`overlay-inspeccion-${vIndex}`);
      if (overlay) {
          overlay.style.display = 'flex';
          document.body.style.overflow = 'hidden';
          
          // ‚úÖ Resaltar campos vac√≠os
          setTimeout(() => {
              const campos = [
                  `interior_camion_${vIndex}`,
                  `estado_carpa_${vIndex}`,
                  `olores_extranos_${vIndex}`,
                  `objetos_extranos_${vIndex}`,
                  `evidencias_plagas_${vIndex}`,
                  `estado_suelo_${vIndex}`,
                  `aprobado_${vIndex}`
              ];
              
              campos.forEach(id => {
                  const campo = document.getElementById(id);
                  if (campo && !campo.value) {
                      campo.style.borderColor = '#dc3545';
                      campo.style.boxShadow = '0 0 0 2px rgba(220, 53, 69, 0.25)';
                  }
              });
          }, 100);
      }
  }
  // ‚úÖ CERRAR OVERLAY DE INSPECCI√ìN
  function cerrarInspeccionVehiculo(vIndex) {
      const overlay = document.getElementById(`overlay-inspeccion-${vIndex}`);
      if (overlay) {
          // ‚úÖ Quitar resaltado de campos
          const campos = [
              `interior_camion_${vIndex}`,
              `estado_carpa_${vIndex}`,
              `olores_extranos_${vIndex}`,
              `objetos_extranos_${vIndex}`,
              `evidencias_plagas_${vIndex}`,
              `estado_suelo_${vIndex}`,
              `aprobado_${vIndex}`
          ];
          
          campos.forEach(id => {
              const campo = document.getElementById(id);
              if (campo) {
                  campo.style.borderColor = '';
                  campo.style.boxShadow = '';
              }
          });
          
          overlay.style.display = 'none';
          document.body.style.overflow = 'auto';
      }
  }

  // ‚úÖ VALIDAR INSPECCI√ìN Y CAMBIAR COLOR DEL BOT√ìN
  function validarInspeccion(vIndex) {
    const campos = [
      `interior_camion_${vIndex}`,
      `estado_carpa_${vIndex}`,
      `olores_extranos_${vIndex}`,
      `objetos_extranos_${vIndex}`,
      `evidencias_plagas_${vIndex}`,
      `estado_suelo_${vIndex}`,
      `aprobado_${vIndex}`
    ];
    
    let todosCompletos = true;
    campos.forEach(id => {
      const campo = document.getElementById(id);
      if (!campo || !campo.value) {
        todosCompletos = false;
      }
    });
    
    // ‚úÖ CAMBIAR COLOR DEL BOT√ìN
    const btnAceptar = document.getElementById(`btn-aceptar-${vIndex}`);
    if (todosCompletos) {
      btnAceptar.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
      btnAceptar.style.cursor = 'pointer';
      btnAceptar.disabled = false;
    } else {
      btnAceptar.style.background = 'linear-gradient(135deg, #001855 0%, #003380 100%)';
      btnAceptar.style.cursor = 'not-allowed';
      btnAceptar.disabled = true;
    }
  }

  // ‚úÖ VALIDAR AL ABRIR EL OVERLAY
  function abrirInspeccionVehiculo(vIndex) {
    const overlay = document.getElementById(`overlay-inspeccion-${vIndex}`);
    if (overlay) {
      overlay.style.display = 'flex';
      document.body.style.overflow = 'hidden';
      
      // ‚úÖ Validar inmediatamente al abrir
      setTimeout(() => {
        validarInspeccion(vIndex);
      }, 100);
    }
  }

  // ‚úÖ CERRAR OVERLAY DE INSPECCI√ìN
  function cerrarInspeccionVehiculo(vIndex) {
    const overlay = document.getElementById(`overlay-inspeccion-${vIndex}`);
    if (overlay) {
      overlay.style.display = 'none';
      // Restaurar scroll del body
      document.body.style.overflow = 'auto';
    }
  }

  // ‚úÖ CERRAR OVERLAY AL HACER CLIC FUERA DEL CONTENIDO
  document.addEventListener('click', function(event) {
    if (event.target.classList.contains('overlay-inspeccion') || event.target.id.startsWith('overlay-inspeccion-')) {
      const overlay = event.target;
      overlay.style.display = 'none';
      document.body.style.overflow = 'auto';
    }
  });

          // ============================================
          // GESTI√ìN DE PARADAS DE OPERACI√ìN
          // ============================================

          function agregarCampoParada(tipo, datos = {}) {
    const contenedor = document.getElementById('operacion-contenedor');
    const index = contenedor.children.length;
    
    const div = document.createElement('div');
    div.className = 'parada-group';
    div.dataset.index = index;
    
    const botonEliminar = document.createElement('button');
    botonEliminar.type = 'button';
    botonEliminar.className = 'btn-eliminar';
    botonEliminar.textContent = 'Eliminar';
    botonEliminar.onclick = function() {
      div.remove();
      const paradas = contenedor.getElementsByClassName('parada-group');
      for (let i = 0; i < paradas.length; i++) {
        const span = paradas[i].querySelector('.numero-parada');
        if (span) span.textContent = i + 1;
      }
      guardarProgreso();
    };
    
    const dInicio = `operacion-inicio-${index}`;
    const dFin = `operacion-fin-${index}`;
    
    div.innerHTML = `
      <p style="font-weight:bold; margin-top:0; color:#555;">üõë Parada #<span class="numero-parada">${index + 1}</span> (Operaci√≥n)</p>
      
      ${generarTimeRowConBotonesParada(index, '', datos.inicio || '', datos.fin || '')}
      
      <label style="margin-top:5px;">Motivo:</label>
      <select name="parada_motivo_operacion_${index}">
        <option value="">Seleccione</option>
        <option value="pausas_activas" ${datos.motivo === 'pausas_activas' ? 'selected' : ''}>Pausas Activas y/o Charla</option>
        <option value="liberacion_calidad" ${datos.motivo === 'liberacion_calidad' ? 'selected' : ''}>Liberacion De Calidad</option>
        <option value="desayuno_almuerzo_cena" ${datos.motivo === 'desayuno_almuerzo_cena' ? 'selected' : ''}>Desayuno/Almuerzo/Cena</option>
        <option value="aseo" ${datos.motivo === 'aseo' ? 'selected' : ''}>Aseo</option>
        <option value="faltante_insumos" ${datos.motivo === 'faltante_insumos' ? 'selected' : ''}>Faltante (Canastillas, vinipel, estibas, etc)</option>
        <option value="danos_equipo" ${datos.motivo === 'danos_equipo' ? 'selected' : ''}>Da√±os (Electricos, montacargas, etc)</option>
        <option value="otro" ${datos.motivo === 'otro' ? 'selected' : ''}>Otro</option>
      </select>
      <input type="text" name="parada_otro_motivo_operacion_${index}" placeholder="Especifique" class="otro-input" value="${datos.otro_motivo || ''}">
    `;
    
    div.appendChild(botonEliminar);
    contenedor.appendChild(div);
    
    // ‚úÖ Configurar eventos despu√©s de a√±adir al DOM
    const motivoSelect = div.querySelector(`select[name="parada_motigo_operacion_${index}"]`);
    if (motivoSelect) {
      motivoSelect.addEventListener('change', () => manejarOtroCampo(motivoSelect));
      // ‚úÖ Mostrar campo "otro" si ya est√° seleccionado
      if (motivoSelect.value === 'otro') {
        const otroInput = div.querySelector('.otro-input');
        if (otroInput) otroInput.style.display = 'block';
      }
    }
  }

          // ============================================
          // MANEJO DE FOTOS
          // ============================================

  // ‚úÖ FUNCI√ìN CORREGIDA PARA SUBIR FOTO (USANDO API KEY GLOBAL)
  function setupFotoPreview(inputId, previewId, nombrePersonalizado) {
    const input = document.getElementById(inputId);
    const preview = document.getElementById(previewId);
    if (!input || !preview) return;
    
    const file = input.files[0];
    if (!file || !file.type.match('image.*') || file.size > 5 * 1024 * 1024) {
      input.value = '';
      preview.innerHTML = '';
      if (file && !file.type.match('image.*')) alert('Solo im√°genes (JPG/PNG).');
      if (file && file.size > 5 * 1024 * 1024) alert('M√°x. 5 MB.');
      return;
    }
    
    const reader = new FileReader();
    reader.onload = e => preview.innerHTML = `<img src="${e.target.result}" alt="Vista previa">`;
    reader.readAsDataURL(file);
    
    const formData = new FormData();
    formData.append('image', file);
    formData.append('key', window.imgbbApiKey); // ‚úÖ USAR API KEY GLOBAL
    formData.append('name', nombrePersonalizado);
    
    fetch('https://api.imgbb.com/1/upload', { 
      method: 'POST', 
      body: formData 
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const vIdx = nombrePersonalizado.split('.').pop().replace('vehiculo_', '');
          const urlInput = document.getElementById(`foto_url_${vIdx}`);
          if (urlInput) urlInput.value = data.data.url;
          alert(`‚úÖ Foto subida: ${nombrePersonalizado}`);
          guardarProgreso();
        } else {
          throw new Error(data.error.message || 'Error al subir la foto');
        }
      })
      .catch(error => {
        console.error('‚ùå Error al subir foto:', error);
        alert("‚ùå No se pudo subir la foto. Se guardar√° localmente.");
      });
  }

          // ============================================
  // FILTRAR COORDINADORES POR LUGAR
  // ============================================
  function filtrarCoordinadores() {
    const lugar = document.getElementById('lugar').value;
    const coordinadorSelect = document.getElementById('coordinador');
    const opciones = coordinadorSelect.querySelectorAll('option');
    
    // Mostrar/Ocultar opciones seg√∫n el lugar
    opciones.forEach(opcion => {
      const dataLugar = opcion.getAttribute('data-lugar');
      
      if (dataLugar) {
        if (lugar === '') {
          opcion.style.display = 'none'; // Ocultar todas si no hay lugar seleccionado
        } else if (dataLugar === lugar || lugar === '') {
          opcion.style.display = 'block';
        } else {
          opcion.style.display = 'none';
        }
      } else if (opcion.value === 'otro' || opcion.value === '') {
        opcion.style.display = 'block'; // Siempre mostrar "Seleccione" y "Otro"
      }
    });
    
    // Resetear selecci√≥n si el coordinador actual no corresponde al lugar
    const coordinadorSeleccionado = coordinadorSelect.value;
    const opcionSeleccionada = Array.from(opciones).find(opt => 
      opt.value === coordinadorSeleccionado && opt.style.display !== 'none'
    );
    
    if (!opcionSeleccionada) {
      coordinadorSelect.value = ''; // Limpiar si no es v√°lido
    }
    
    manejarOtroCoordinador(); // Actualizar campo "otro"
    guardarProgreso();
  }

  // Modificar actualizarCampos para incluir filtrado
  function actualizarCampos() {
    const lugar = document.getElementById("lugar").value;
    const turno = document.getElementById("turno");
    const liderPepsico = document.getElementById("lider_pepsico");
    const fechaInput = document.getElementById("fecha");
    const coordSelect = document.getElementById("coordinador");
    
    if (lugar === "Funza") {
      if (!coordSelect.value || coordSelect.value === '') {
        coordSelect.value = "Julian Espitia";
        manejarOtroCoordinador();
      }
      const h = new Date().getHours();
      if (!turno.value) {
        turno.value = (h >= 6 && h < 14) ? "Manana" : (h >= 14 && h < 22) ? "Tarde" : "Noche";
      }
      if (!liderPepsico.value) {
        liderPepsico.value = "Alejandro Monroy";
        manejarOtroLiderPepsico();
      }
    } else if (lugar === "SantoDomingo") {
      // No establecer valores por defecto para Santo Domingo
      if (!turno.value) {
        const h = new Date().getHours();
        turno.value = (h >= 6 && h < 14) ? "Manana" : (h >= 14 && h < 22) ? "Tarde" : "Noche";
      }
    }
    
    if (!fechaInput.value) {
      fechaInput.value = new Date().toISOString().split('T')[0];
    }
    
    actualizarTotalCajas();
    guardarProgreso();
    actualizarMuellesPorLugar();
  }

          // ============================================
          // M√ÅSCARA DE TIEMPO
          // ============================================

          function applyTimeMask(input, displayId) {
              let value = input.value.replace(/[^0-9]/g, '');
              
              if (value.length === 1 && value > '2') value = '0' + value;
              if (value.length === 2 && value > '23') value = '23';
              if (value.length === 3 && value[2] > '5') value = value.substring(0,2) + '5';
              
              if (value.length >= 4) {
                  value = value.substring(0,4).padStart(4,'0');
                  let m = value.substring(2,4);
                  if (m > '59') m = '59';
                  value = value.substring(0,2) + m;
              }
              
              let formatted = value.length >= 2 ? value.substring(0,2) + ':' + (value.length > 2 ? value.substring(2,4) : '00') : '';
              input.value = formatted;
              
              const parent = input.closest('.time-row');
              if(parent) {
                  const inputs = parent.querySelectorAll('input');
                  if(inputs.length === 2) {
                      const hInicio = inputs[0].value;
                      const hFin = inputs[1].value;
                      if(hInicio.length === 5 && hFin.length === 5) {
                          if(horaAMinutos(hFin) < horaAMinutos(hInicio)) {
                              alert("‚ùå Error de Seguridad: La Hora Final no puede ser menor que la Hora Inicio.");
                              input.value = "";
                              const display = document.getElementById(displayId);
                              if(display) display.innerHTML = "";
                              return;
                          }
                      }
                  }
              }
              
              convertirHoraMilitar(input, displayId);
              guardarProgreso();
          }

          function convertirHoraMilitar(input, displayId) {
              const value = input.value;
              const display = document.getElementById(displayId);
              
              if (!display) return;
              
              if (value.length === 5 && value.includes(':')) {
                  const [h, m] = value.split(':').map(Number);
                  if (h >= 0 && h <= 23 && m >= 0 && m <= 59) {
                      const ampm = h >= 12 ? 'P.M.' : 'A.M.';
                      const h12 = (h % 12) || 12;
                      display.style.color = '#155724';
                      display.innerHTML = `Hora Normal: ${String(h12).padStart(2,'0')}:${String(m).padStart(2,'0')} ${ampm}`;
                      return;
                  }
              }
              
              display.style.color = value.length > 0 && value.length < 5 ? '#dc3545' : '#155724';
              display.innerHTML = value.length > 0 && value.length < 5 ? '‚ùå Formato incompleto. HH:MM' : '';
          }

          // ============================================
          // ACTUALIZACI√ìN DE TOTALES
          // ============================================

          function actualizarTotalCajas() {
              const camposCajas = document.querySelectorAll('.cajas-input-js');
              const totalCajasInput = document.getElementById('cajas_totales');
              let total = 0;
              
              camposCajas.forEach(input => {
                  const valor = parseInt(input.value, 10);
                  if (!isNaN(valor)) total += valor;
              });
              
              if(totalCajasInput) totalCajasInput.value = total;
          }
          // ============================================
  // ‚úÖ SISTEMA DE PICKING POR RADIOFRECUENCIA
  // ============================================

  // Estructura para almacenar productos escaneados por veh√≠culo
  let productosEscaneadosPorVehiculo = {};

  // Cargar base de datos de productos desde JSON
  async function cargarBaseDatosProductos() {
    try {
      console.log('‚è≥ Cargando base de datos de productos...');
      
      const response = await fetch('productos.json');
      const data = await response.json();
      
      window.baseDatosProductos = data;
      console.log('‚úÖ Base de datos de productos cargada:', Object.keys(data).length, 'productos');
    } catch (error) {
      console.warn('‚ö†Ô∏è No se pudo cargar productos.json, usando base de datos fallback');
      window.baseDatosProductos = {
        "300033638": { nombre: "DORITOS MQUES 4X1 BX10X38G+GTX2GACHKSCHO", referencia: "300033638" },
        "300034010": { nombre: "CHOKIS CHISPAS 40GX1X80 ENF", referencia: "300034010" },
        "300054027": { nombre: "MMOTO NK PASAS CH 30GX12X12 SP DISPX12", referencia: "300054027" },
        "300054040": { nombre: "CHOKIS CHISPAS 57GX9X7 DISPX7 TROQ", referencia: "300054040" },
        "300054062": { nombre: "MARGARITA REC CLAS ALITAS BBQ 250GX9X1", referencia: "300054062" },
        "300037949": { nombre: "CHEESE TRIS QUESO 50GX72X1 CP", referencia: "300037949" },
        "300065646": { nombre: "MARGARITA POLLO 105GX18X1 PROMO H2225", referencia: "300065646" }
      };
      console.log('‚úÖ Base de datos fallback cargada');
    }
  }

  // Inicializar almacenamiento de productos para un veh√≠culo
  function inicializarProductosEscaneados(vIndex) {
    if (!productosEscaneadosPorVehiculo[vIndex]) {
      productosEscaneadosPorVehiculo[vIndex] = {
        totalCajas: 0,
        productos: {} // { codigo: { nombre, referencia, cantidad } }
      };
    }
  }



  // Mostrar feedback visual al escanear
  // Mostrar resumen de productos escaneados
  function mostrarResumenProductos(vIndex) {
    const container = document.getElementById(`resumen-productos-${vIndex}`);
    if (!container) return;
    
    inicializarProductosEscaneados(vIndex);
    const productos = productosEscaneadosPorVehiculo[vIndex].productos;
    const totalCajas = productosEscaneadosPorVehiculo[vIndex].totalCajas;
    
    if (totalCajas === 0) {
      container.innerHTML = `
        <div style="background: #f8f9fa; border-radius: 8px; padding: 20px; text-align: center; border: 1px dashed #dee2e6;">
          <p style="color: #6c757d; margin: 0; font-size: 1.1em;">üì¶ No hay productos en el picking a√∫n</p>
          <small style="color: #6c757d;">Comienza a agregar productos usando el campo de arriba</small>
        </div>
      `;
      return;
    }
    
    let html = `
      <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; border: 2px solid #001855;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
          <h5 style="margin: 0; color: #001855;">üìä Resumen de Picking</h5>
          <div style="background: #001855; color: white; padding: 6px 16px; border-radius: 20px; font-weight: bold; font-size: 1.1em;">
            ${totalCajas} cajas
          </div>
        </div>
        
        <div style="max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 5px;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background: #001855; color: white;">
                <th style="padding: 10px 8px; text-align: left; font-size: 0.85em;">Referencia</th>
                <th style="padding: 10px 8px; text-align: left; font-size: 0.85em;">Producto</th>
                <th style="padding: 10px 8px; text-align: center; font-size: 0.85em;">Cajas</th>
                <th style="padding: 10px 8px; text-align: center; font-size: 0.85em;">Borrar</th>
                <th style="padding: 10px 8px; text-align: center; font-size: 0.85em;">Acciones</th>
              </tr>
            </thead>
            <tbody>
    `;
    
    // Ordenar productos por cantidad descendente
    const productosOrdenados = Object.entries(productos).sort((a, b) => b[1].cantidad - a[1].cantidad);
    
    productosOrdenados.forEach(([codigo, prod]) => {
      html += `
        <tr style="border-bottom: 1px solid #e9ecef;">
          <td style="padding: 8px; font-family: 'Courier New', monospace; font-size: 0.85em; color: #495057;">${prod.referencia}</td>
          <td style="padding: 8px; font-size: 0.9em;">${prod.nombre}</td>
          <td style="padding: 8px; text-align: center; font-weight: bold; color: #C76E00;">${prod.cantidad}</td>
          <td style="padding: 8px; text-align: center;">
            <!-- ‚úÖ Input para cantidad a borrar -->
            <input type="number" id="borrar-cantidad-${vIndex}-${codigo}" 
                  min="1" max="${prod.cantidad}" value="1"
                  style="width: 60px; padding: 4px; text-align: center; border: 2px solid #001855; border-radius: 4px; font-weight: bold;"
                  onblur="validarCantidadBorrar(${vIndex}, '${codigo}')">
          </td>
          <td style="padding: 8px; text-align: center;">
            <!-- ‚úÖ Bot√≥n para borrar cantidad espec√≠fica -->
            <button type="button" onclick="borrarCantidadPicking(${vIndex}, '${codigo}', parseInt(document.getElementById('borrar-cantidad-${vIndex}-${codigo}').value))"
                    style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; border: none; padding: 6px 12px; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 0.85em; white-space: nowrap;"
                    title="Borrar cantidad especificada">
              üóëÔ∏è Borrar
            </button>
            
            <!-- ‚úÖ Bot√≥n para borrar todo -->
            <button type="button" onclick="borrarCantidadPicking(${vIndex}, '${codigo}', ${prod.cantidad})"
                    style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; border: none; padding: 4px 8px; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 0.75em; margin-top: 4px; display: block; width: 100%;"
                    title="Borrar todo">
              Todo
            </button>
          </td>
        </tr>
      `;
    });
    
    html += `
            </tbody>
          </table>
        </div>
        
        <button type="button" onclick="limpiarEscaneoVehiculo(${vIndex})" 
                style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 5px; font-weight: bold; margin-top: 12px; width: 100%; cursor: pointer;">
          üóëÔ∏è Limpiar Todo el Picking
        </button>
      </div>
    `;
    
    container.innerHTML = html;
  }

  // ‚úÖ HACER VISIBLES LOS CAMPOS DE MOTIVO ANTES DE VALIDAR
  // ‚úÖ HACER VISIBLES LOS CAMPOS DE MOTIVO ANTES DE VALIDAR
  function mostrarCamposMotivo() {
    const registros = document.querySelectorAll('.registro-vehiculo');
    registros.forEach((reg, index) => {
      const containerMotivoTipo = document.getElementById(`motivo-tipo-operacion-container-${index}`);
      const lineaMotivoTipo = document.getElementById(`motivo-tipo-linea-${index}`);
      const motivoSolo = document.getElementById(`motivo-solo-${index}`);
      
      if (containerMotivoTipo && lineaMotivoTipo && motivoSolo) {
        const lugar = document.getElementById('lugar').value;
        if (lugar === 'SantoDomingo') {
          lineaMotivoTipo.style.display = 'flex';
          motivoSolo.style.display = 'none';
        } else {
          lineaMotivoTipo.style.display = 'none';
          motivoSolo.style.display = 'block';
        }
      }
    });
  }

  // ‚úÖ FUNCI√ìN CORREGIDA: Validar cantidad a borrar
  function validarCantidadBorrar(vIndex, codigo) {
    const input = document.getElementById(`borrar-cantidad-${vIndex}-${codigo}`);
    if (!input) return;
    
    const valorRaw = input.value.trim();
    
    // Permitir campo vac√≠o temporalmente
    if (valorRaw === '') {
      return;
    }
    
    const valor = parseInt(valorRaw);
    const max = parseInt(input.max) || 1;
    
    // Validar solo si hay un valor num√©rico
    if (!isNaN(valor)) {
      if (valor < 1) {
        input.value = 1;
      } else if (valor > max) {
        input.value = max;
      }
    } else {
      // Si no es un n√∫mero v√°lido, restaurar al √∫ltimo valor v√°lido
      input.value = 1;
    }
  }

  // Eliminar producto espec√≠fico del picking

  function eliminarProductoPicking(vIndex, codigo) {
    // ‚úÖ Verificar que exista el veh√≠culo y el producto
    if (!productosEscaneadosPorVehiculo[vIndex] || !productosEscaneadosPorVehiculo[vIndex].productos[codigo]) {
      console.warn('Producto no encontrado para eliminar');
      return;
    }
    
    const producto = productosEscaneadosPorVehiculo[vIndex].productos[codigo];
    
    // ‚úÖ PEDIR CONFIRMACI√ìN AL USUARIO (VERIFICACI√ìN)
    const confirmar = confirm(`‚ö†Ô∏è ¬øEst√°s seguro de eliminar TODAS las ${producto.cantidad} cajas de:\n\n${producto.nombre}?\n\nEsta acci√≥n no se puede deshacer.`);
    
    if (!confirmar) {
      console.log('Eliminaci√≥n cancelada por el usuario');
      return;
    }
    
    // ‚úÖ Eliminar producto
    const cantidadEliminada = producto.cantidad;
    delete productosEscaneadosPorVehiculo[vIndex].productos[codigo];
    
    // ‚úÖ Actualizar total de cajas
    productosEscaneadosPorVehiculo[vIndex].totalCajas -= cantidadEliminada;
    
    // ‚úÖ Actualizar campo de cajas movidas
    const cajasInput = document.querySelector(`input[name="vehiculo_${vIndex}_cajas"]`);
    if (cajasInput) {
      cajasInput.value = productosEscaneadosPorVehiculo[vIndex].totalCajas;
    }
    
    // ‚úÖ Actualizar total general
    actualizarTotalCajas();
    
    // ‚úÖ Guardar progreso
    guardarProgreso();
    
    // ‚úÖ Mostrar feedback
    mostrarFeedbackPicking(`‚úÖ ${producto.nombre.substring(0, 30)}${producto.nombre.length > 30 ? '...' : ''} eliminado`, vIndex, 'success');
    
    // ‚úÖ Actualizar resumen
    mostrarResumenProductos(vIndex);
    
    console.log(`üì¶ Producto eliminado V${vIndex}: ${codigo}`);
  }

  // ‚úÖ FUNCI√ìN FALTANTE: Limpiar todo el picking de un veh√≠culo

  function limpiarEscaneoVehiculo(vIndex) {
    // ‚úÖ PEDIR CONFIRMACI√ìN AL USUARIO (VERIFICACI√ìN)
    const confirmar = confirm(`‚ö†Ô∏è ¬øEst√°s seguro de LIMPIAR TODO el picking del veh√≠culo ${vIndex + 1}?\n\nSe eliminar√°n TODOS los productos escaneados.\n\nEsta acci√≥n no se puede deshacer.`);
    
    if (!confirmar) {
      console.log('Limpieza de picking cancelada por el usuario');
      return;
    }
    
    // ‚úÖ Limpiar productos escaneados
    productosEscaneadosPorVehiculo[vIndex] = {
      productos: {},
      totalCajas: 0
    };
    
    // ‚úÖ Limpiar campo de cajas
    const cajasInput = document.querySelector(`input[name="vehiculo_${vIndex}_cajas"]`);
    if (cajasInput) {
      cajasInput.value = '';
    }
    
    // ‚úÖ Actualizar total general
    actualizarTotalCajas();
    
    // ‚úÖ Guardar progreso
    guardarProgreso();
    
    // ‚úÖ Mostrar feedback
    mostrarFeedbackPicking('‚úÖ Picking limpiado completamente', vIndex, 'success');
    
    // ‚úÖ Actualizar resumen
    mostrarResumenProductos(vIndex);
    
    console.log(`üßπ Picking limpiado para veh√≠culo V${vIndex}`);
  }

  // Guardar productos escaneados en localStorage
  function guardarProductosEscaneados() {
    localStorage.setItem('productos_escaneados_rf', JSON.stringify(productosEscaneadosPorVehiculo));
  }

  // Cargar productos escaneados desde localStorage
  function cargarProductosEscaneados() {
    const saved = localStorage.getItem('productos_escaneados_rf');
    if (saved) {
      try {
        productosEscaneadosPorVehiculo = JSON.parse(saved);
        console.log('‚úÖ Productos escaneados cargados desde localStorage');
        
        // Actualizar res√∫menes de todos los veh√≠culos existentes
        Object.keys(productosEscaneadosPorVehiculo).forEach(vIndex => {
          mostrarResumenProductos(parseInt(vIndex));
        });
      } catch (e) {
        console.error('‚ùå Error al cargar productos escaneados:', e);
        productosEscaneadosPorVehiculo = {};
      }
    }
  }

  function borrarCantidadPicking(vIndex, codigo, cantidadABorrar) {
    // ‚úÖ Verificar que exista el veh√≠culo y el producto
    if (!productosEscaneadosPorVehiculo[vIndex] || !productosEscaneadosPorVehiculo[vIndex].productos[codigo]) {
      console.warn('Producto no encontrado para borrar');
      return;
    }
    
    const producto = productosEscaneadosPorVehiculo[vIndex].productos[codigo];
    const cantidadActual = producto.cantidad;
    
    // ‚úÖ Obtener valor del input (con fallback a 1 si es inv√°lido)
    if (isNaN(cantidadABorrar) || cantidadABorrar === null || cantidadABorrar === undefined || cantidadABorrar === '') {
      cantidadABorrar = 1;
    }
    
    // ‚úÖ Verificar que no se borre m√°s de lo que hay
    if (cantidadABorrar > cantidadActual) {
      alert(`‚ö†Ô∏è No puedes borrar ${cantidadABorrar} unidades. Solo hay ${cantidadActual} disponibles.`);
      return;
    }
    
    // ‚úÖ Verificar que la cantidad sea mayor a 0
    if (cantidadABorrar <= 0) {
      alert(`‚ö†Ô∏è La cantidad a borrar debe ser mayor a 0.`);
      return;
    }
    
    // ‚úÖ PEDIR CONFIRMACI√ìN AL USUARIO (VERIFICACI√ìN)
    const productoNombre = producto.nombre.substring(0, 40) + (producto.nombre.length > 40 ? '...' : '');
    const mensaje = cantidadABorrar === cantidadActual 
      ? `‚ö†Ô∏è ¬øEst√°s seguro de eliminar TODAS las ${cantidadActual} cajas de:\n\n${productoNombre}?\n\nEsta acci√≥n no se puede deshacer.`
      : `‚ö†Ô∏è ¬øEst√°s seguro de eliminar ${cantidadABorrar} caja${cantidadABorrar > 1 ? 's' : ''} de:\n\n${productoNombre}?\n\nQuedar√°n ${cantidadActual - cantidadABorrar} caja${(cantidadActual - cantidadABorrar) > 1 ? 's' : ''}.`;
    
    const confirmar = confirm(mensaje);
    
    if (!confirmar) {
      console.log('Acci√≥n de borrado cancelada por el usuario');
      return;
    }
    
    // ‚úÖ Calcular nueva cantidad
    const nuevaCantidad = cantidadActual - cantidadABorrar;
    
    // ‚úÖ Actualizar cantidad del producto
    if (nuevaCantidad > 0) {
      productosEscaneadosPorVehiculo[vIndex].productos[codigo].cantidad = nuevaCantidad;
    } else {
      // ‚úÖ Si queda 0, eliminar el producto completamente
      delete productosEscaneadosPorVehiculo[vIndex].productos[codigo];
    }
    
    // ‚úÖ Actualizar total de cajas
    productosEscaneadosPorVehiculo[vIndex].totalCajas -= cantidadABorrar;
    
    // ‚úÖ Actualizar campo de cajas movidas
    const cajasInput = document.querySelector(`input[name="vehiculo_${vIndex}_cajas"]`);
    if (cajasInput) {
      cajasInput.value = productosEscaneadosPorVehiculo[vIndex].totalCajas;
    }
    
    // ‚úÖ Actualizar total general
    actualizarTotalCajas();
    
    // ‚úÖ Guardar progreso
    guardarProgreso();
    
    // ‚úÖ Mostrar feedback
    const accion = cantidadABorrar === cantidadActual ? 'eliminado completamente' : `reducido en ${cantidadABorrar} unidades`;
    mostrarFeedbackPicking(`‚úÖ ${producto.nombre.substring(0, 30)}${producto.nombre.length > 30 ? '...' : ''} ${accion}`, vIndex, 'success');
    
    // ‚úÖ Actualizar resumen
    mostrarResumenProductos(vIndex);
    
    console.log(`üì¶ Producto actualizado V${vIndex}: ${codigo} - Nueva cantidad: ${nuevaCantidad}`);
    
    // ‚úÖ Enfocar el campo EAN para continuar escaneando
    setTimeout(() => {
      const codigoInput = document.getElementById(`codigo-picking-${vIndex}`);
      if (codigoInput) {
        codigoInput.focus();
      }
    }, 50);
  }

  // ============================================
  // ‚úÖ NUEVO: Sistema de Picking con Bot√≥n
  // ============================================

  // Agregar producto al picking con bot√≥n
  function agregarProductoPicking(vIndex) {
    const codigoInput = document.getElementById(`codigo-picking-${vIndex}`);
    let codigo = codigoInput.value.trim().toUpperCase();
    
    // ‚úÖ ELIMINAR TODOS LOS SALTOS DE L√çNEA (no solo espacios)
    codigo = codigo.replace(/[\r\n]+/g, '').trim();
    
    if (!codigo || codigo.length < 5) {
      mostrarFeedbackPicking('‚ö†Ô∏è Por favor ingresa un c√≥digo v√°lido', vIndex, 'warning');
      // ‚úÖ Mantener foco incluso en advertencia
      setTimeout(() => codigoInput.focus(), 50);
      return;
    }
    
    // Buscar producto en base de datos
    const producto = window.baseDatosProductos[codigo] || 
                    window.baseDatosProductos[codigo.replace(/\s/g, '')] ||
                    window.baseDatosProductos[codigo.substring(0, 8)] ||
                    window.baseDatosProductos[codigo.substring(0, 10)];
    
    if (producto) {
      // Inicializar si no existe
      inicializarProductosEscaneados(vIndex);
      
      // Agregar o incrementar producto
      if (!productosEscaneadosPorVehiculo[vIndex].productos[codigo]) {
        productosEscaneadosPorVehiculo[vIndex].productos[codigo] = {
          nombre: producto.nombre || codigo,
          referencia: producto.referencia || codigo,
          cantidad: 0
        };
      }
      
      // Incrementar cantidad
      productosEscaneadosPorVehiculo[vIndex].productos[codigo].cantidad++;
      productosEscaneadosPorVehiculo[vIndex].totalCajas++;
      
      // Actualizar campo de cajas movidas
      const cajasInput = document.querySelector(`input[name="vehiculo_${vIndex}_cajas"]`);
      if (cajasInput) {
        cajasInput.value = productosEscaneadosPorVehiculo[vIndex].totalCajas;
      }
      
      // Actualizar total general
      actualizarTotalCajas();
      
      // Guardar progreso
      guardarProgreso();
      
      // Mostrar feedback exitoso
      mostrarFeedbackPicking(`‚úÖ ${producto.nombre.substring(0, 40)}${producto.nombre.length > 40 ? '...' : ''}`, vIndex, 'success');
      
      // ‚úÖ Limpiar y enfocar con delay para asegurar el foco
      codigoInput.value = '';
      setTimeout(() => {
        codigoInput.focus();
        codigoInput.select(); // ‚úÖ Seleccionar todo el texto (por si hay algo)
      }, 50);
      
      // Actualizar resumen
      mostrarResumenProductos(vIndex);
      
      console.log(`üì¶ Producto agregado V${vIndex}: ${producto.nombre} - Total cajas: ${productosEscaneadosPorVehiculo[vIndex].totalCajas}`);
    } else {
      // Producto no encontrado - Borrar campo autom√°ticamente
      mostrarFeedbackPicking(`‚ùå C√≥digo no encontrado: ${codigo}`, vIndex, 'error');
      codigoInput.value = '';
      // ‚úÖ Enfocar con delay incluso en error
      setTimeout(() => {
        codigoInput.focus();
        codigoInput.select();
      }, 50);
    }
  }

  // ‚úÖ VALIDACI√ìN H√çBRIDA: n√∫meros (m√°x 9) o alfanum√©rico (m√°x 20)
  function validarCodigoPicking(input) {
    const valorOriginal = input.value.trim().toUpperCase();
    
    // ‚úÖ Permitir letras, n√∫meros y guiones bajos (para c√≥digos como CORRUGADO)
    let valorLimpio = valorOriginal.replace(/[^A-Z0-9_]/g, '');
    
    // ‚úÖ Detectar si es puramente num√©rico
    const esNumerico = /^\d+$/.test(valorLimpio);
    
    // ‚úÖ Aplicar l√≠mites seg√∫n el tipo
    if (esNumerico && valorLimpio.length > 9) {
      valorLimpio = valorLimpio.substring(0, 9);
    } else if (valorLimpio.length > 20) {
      valorLimpio = valorLimpio.substring(0, 20);
    }
    
    input.value = valorLimpio;
  }

  // Mostrar feedback de picking
  function mostrarFeedbackPicking(mensaje, vIndex, tipo = 'info') {
    const container = document.getElementById(`feedback-picking-${vIndex}`);
    if (!container) return;
    
    let colorBg, colorText;
    switch(tipo) {
      case 'success':
        colorBg = '#d4edda';
        colorText = '#155724';
        break;
      case 'error':
        colorBg = '#f8d7da';
        colorText = '#721c24';
        break;
      case 'warning':
        colorBg = '#fff3cd';
        colorText = '#856404';
        break;
      default:
        colorBg = '#d1ecf1';
        colorText = '#0c5460';
    }
    
    container.innerHTML = `
      <div style="background: ${colorBg}; color: ${colorText}; padding: 8px 12px; border-radius: 5px; font-size: 0.9em; border-left: 4px solid ${colorText};">
        ${mensaje}
      </div>
    `;
    
    // Eliminar feedback despu√©s de 3 segundos
    setTimeout(() => {
      if (container) container.innerHTML = '';
    }, 3000);
  }

          function convertirATextoMayusculas() {
              const textInputs = document.querySelectorAll('input[type="text"], textarea');
              textInputs.forEach(input => {
                  if (input.value.trim() !== '') input.value = input.value.toUpperCase();
              });
          }

          // ============================================
          // GUARDADO DE PROGRESO
          // ============================================

  function guardarProgreso() {
      const form = document.forms['formulario-pepsico'];
      if (!form) return;
      
      const formData = new FormData(form);
      const data = {};
      
      formData.forEach((value, key) => {
          if (!(value instanceof File) && key !== 'form-name') data[key] = value;
      });
      
      const vehiculos = document.querySelectorAll('.registro-vehiculo');
      vehiculos.forEach((_, vIndex) => {
          // ‚úÖ CAPTURAR FOTO PRINCIPAL DEL VEH√çCULO
          const fotoUrlInput = document.getElementById(`foto_url_${vIndex}`);
          if (fotoUrlInput) {
              data[`vehiculo_${vIndex}_foto_url`] = fotoUrlInput.value || '';
          }
          
          // ‚úÖ ============================================
          // ‚úÖ CAPTURAR LAS 3 FOTOS (INICIO, DURANTE, FIN)
          // ‚úÖ ============================================
          const fotoInicio = document.getElementById(`url-inicio-${vIndex}`)?.value || '';
          const fotoDurante = document.getElementById(`url-durante-${vIndex}`)?.value || '';
          const fotoFin = document.getElementById(`url-fin-${vIndex}`)?.value || '';
          
          // ‚úÖ GUARDAR EN data (NO en vehiculosData)
          data[`vehiculo_${vIndex}_foto_inicio_url`] = fotoInicio;
          data[`vehiculo_${vIndex}_foto_durante_url`] = fotoDurante;
          data[`vehiculo_${vIndex}_foto_fin_url`] = fotoFin;
          // ‚úÖ ============================================
          
          // ‚úÖ CAPTURAR JUSTIFICACIONES POR VEH√çCULO
          const justificacionesContenedor = document.getElementById(`justificaciones-contenedor-${vIndex}`);
          if (justificacionesContenedor) {
              const justificaciones = justificacionesContenedor.querySelectorAll('.justificacion-group');
              const justificacionesData = [];
              
              justificaciones.forEach((justificacion, jIndex) => {
                  const motivo = justificacion.querySelector(`select[name="vehiculo_${vIndex}_justificacion_${jIndex}"]`)?.value || '';
                  const otro_motivo = justificacion.querySelector(`input[name="vehiculo_${vIndex}_otro_justificacion_${jIndex}"]`)?.value || '';
                  const tiempo_inicio = justificacion.querySelector(`input[name="vehiculo_${vIndex}_tiempo_muerto_inicio_${jIndex}"]`)?.value || '';
                  const tiempo_fin = justificacion.querySelector(`input[name="vehiculo_${vIndex}_tiempo_muerto_final_${jIndex}"]`)?.value || '';
                  
                  justificacionesData.push({
                      justificacion: motivo,
                      otro_justificacion: otro_motivo,
                      tiempo_muerto_inicio: tiempo_inicio,
                      tiempo_muerto_final: tiempo_fin
                  });
              });
              
              data[`_justificaciones_${vIndex}`] = justificacionesData;
          }
          
          // ‚úÖ CAPTURAR NOVEDADES POR VEH√çCULO
          const novedadesContenedor = document.getElementById(`novedades-contenedor-${vIndex}`);
          if (novedadesContenedor) {
              const novedades = novedadesContenedor.querySelectorAll('.novedad-group');
              const novedadesData = [];
              
              novedades.forEach((novedad, nIndex) => {
                  const tipo = novedad.querySelector(`select[name="vehiculo_${vIndex}_tipo_novedad_${nIndex}"]`)?.value || '';
                  const descripcion = novedad.querySelector(`textarea[name="vehiculo_${vIndex}_descripcion_novedad_${nIndex}"]`)?.value || '';
                  const foto_url = novedad.querySelector(`input[name="vehiculo_${vIndex}_foto_novedad_${nIndex}_url"]`)?.value || '';
                  
                  novedadesData.push({
                      tipo: tipo,
                      descripcion: descripcion,
                      foto_url: foto_url
                  });
              });
              
              data[`_novedades_${vIndex}`] = novedadesData;
          }
      }); // ‚Üê ‚úÖ AQU√ç S√ç CIERRA EL forEach DE VEH√çCULOS
      
      // ‚úÖ GUARDAR PARADAS DE OPERACI√ìN
      const paradasData = [];
      const paradasContainer = document.getElementById('operacion-contenedor');
      const paradas = paradasContainer.querySelectorAll('.parada-group');
      
      paradas.forEach((parada, index) => {
          const inicio = parada.querySelector(`input[name="parada_inicio_operacion_${index}"]`)?.value || '';
          const fin = parada.querySelector(`input[name="parada_fin_operacion_${index}"]`)?.value || '';
          const motivo = parada.querySelector(`select[name="parada_motivo_operacion_${index}"]`)?.value || '';
          const otro_motivo = parada.querySelector(`input[name="parada_otro_motivo_operacion_${index}"]`)?.value || '';
          
          paradasData.push({
              inicio: inicio,
              fin: fin,
              motivo: motivo,
              otro_motivo: otro_motivo
          });
      });
      
      data._numVehiculos = vehiculosData.length;
      data._paradasDetalle = paradasData;
      data._productosEscaneados = productosEscaneadosPorVehiculo;
      
      console.log('üíæ Guardando progreso:', data);
      localStorage.setItem('pepsico_data', JSON.stringify(data));
  }


          // ============================================
          // LIMPIEZA TOTAL
          // ============================================
          function limpiarTodo() {
            if (confirm("‚ö†Ô∏è ¬øEst√°s seguro de que quieres borrar TODOS los datos?\n\nEsto incluye:\n- Datos del formulario principal\n- Registros de veh√≠culos\n- Inspecciones de veh√≠culos (detalles.html)\n- Paradas de operaci√≥n")) {
              
              // 1. Eliminar datos principales
              localStorage.removeItem('pepsico_data');

              
              // 3. Eliminar otros datos residuales del formulario
              const clavesResiduales = [
                'fecha', 'lugar', 'lider', 'coordinador', 'coordinador_otro',
                'lider_pepsico', 'lider_pepsico_otro', 'turno', 'total_personas',
                'cajas_totales', 'nombres_personal', 'vehiculosData', 'paradasData'
              ];
              
              clavesResiduales.forEach(clave => localStorage.removeItem(clave));
              
              // 4. Recargar la p√°gina para limpiar completamente el estado
              location.reload();
              
              // 5. Confirmaci√≥n visual (opcional)
              setTimeout(() => {
                alert('‚úÖ Todos los datos han sido eliminados correctamente.\nLos detalles de inspecci√≥n tambi√©n fueron borrados.');
              }, 100);
            }
          }
          
          // ============================================
          // VALIDACI√ìN DE PLACAS
          // ============================================

          function validarPlacas() {
              const regexPlaca = /^([A-Z]{3}[0-9]{3}|[0-9]{3}[A-Z]{3}|[A-Z]{1}[0-9]{5})$/;
              const contenedor = document.getElementById('vehiculos-contenedor');
              const registros = contenedor.querySelectorAll('.registro-vehiculo');
              
              for (let i = 0; i < registros.length; i++) {
                  const placaInput = registros[i].querySelector(`input[name="vehiculo_${i}_placa"]`);
                  if (placaInput) {
                      const valor = placaInput.value.toUpperCase().trim();
                      if (!regexPlaca.test(valor)) {
                          alert(`‚ùå Placa del Veh√≠culo #${i+1} no v√°lida.
  Debe cumplir:
  - 3 letras y 3 n√∫meros (ABC123)
  - 3 n√∫meros y 3 letras (123ABC)
  - 1 letra y 5 n√∫meros (A12345)`);
                          return false;
                      }
                  }
              }
              return true;
          }

  // ============================================
  // ENV√çO DEL FORMULARIO (CORREGIDO)
  // ============================================
  function enviarFormulario(event) {
    event.preventDefault();

      console.log('üìß EmailJS cargado:', typeof emailjs !== 'undefined');
      console.log('üìß EmailJS inicializado:', emailjs);
    
    // ‚úÖ PASO 1: Hacer visibles los campos de motivo ANTES de validar
    mostrarCamposMotivo();
    
    // ‚úÖ PASO 2: Sincronizar datos del DOM a vehiculosData
    sincronizarVehiculosDesdeDOM();
    
    // ‚úÖ PASO 3: Debug - Verificar qu√© valores se capturaron
    console.log('üîç Debug motivos antes de validar:');
    vehiculosData.forEach((v, i) => {
      console.log(`Veh√≠culo ${i + 1}:`, {
        motivo: v.motivo,
        motivo_trim: v.motivo?.trim(),
        motivo_empty: !v.motivo || v.motivo.trim() === ''
      });
    });
    
    // ‚úÖ PASO 4: Validar motivo de cada veh√≠culo
    for (let i = 0; i < vehiculosData.length; i++) {
      const vehiculo = vehiculosData[i];
      
      if (!vehiculo.motivo || vehiculo.motivo.trim() === '') {
        alert(`‚ùå Error: El Veh√≠culo #${i + 1} no tiene motivo seleccionado.\n\nPor favor, seleccione: Cargue, Descargue u Otro.`);
        
        const motivoSelect = document.getElementById(`motivo-cargue-descargue-${i}`);
        if (motivoSelect) {
          const container = motivoSelect.closest('.registro-vehiculo');
          if (container) {
            container.scrollIntoView({ behavior: 'smooth', block: 'center' });
            motivoSelect.focus();
            motivoSelect.style.borderColor = '#dc3545';
            motivoSelect.style.boxShadow = '0 0 0 2px rgba(220, 53, 69, 0.25)';
          }
        }
        return;
      }
    }
    
    // ‚úÖ PASO 5: Validar inspecci√≥n de veh√≠culos
    let inspeccionCompleta = true;
    let vehiculoConInspeccionPendiente = -1;
    
    for (let i = 0; i < vehiculosData.length; i++) {
      const vehiculo = vehiculosData[i];
      
      if (!vehiculo.interior_camion || 
          !vehiculo.estado_carpa || 
          !vehiculo.olores_extranos || 
          !vehiculo.objetos_extranos || 
          !vehiculo.evidencias_plagas || 
          !vehiculo.estado_suelo || 
          !vehiculo.aprobado) {
        
        inspeccionCompleta = false;
        vehiculoConInspeccionPendiente = i;
        break;
      }
    }
    
    if (!inspeccionCompleta) {
      alert(`‚ùå Error: La inspecci√≥n del Veh√≠culo #${vehiculoConInspeccionPendiente + 1} est√° incompleta.\n\nPor favor, complete todos los campos de inspecci√≥n antes de enviar.`);
      abrirInspeccionVehiculo(vehiculoConInspeccionPendiente);
      return;
    }
    
    console.log('üìä Veh√≠culos con nombres del personal:');
    vehiculosData.forEach((vehiculo, index) => {
      console.log(`Veh√≠culo ${index}:`, {
        placa: vehiculo.placa,
        personas: vehiculo.personas,
        nombres: vehiculo.nombres_personal,
        motivo: vehiculo.motivo,
        justificaciones: vehiculo.justificaciones
      });
    });
    
    // ‚úÖ PASO 6: Validar campos obligatorios del formulario principal
    const camposObligatorios = [
      { id: 'lugar', nombre: 'Lugar de operaci√≥n' },
      { id: 'lider_pepsico', nombre: 'L√≠der De Pepsico' },
      { id: 'fecha', nombre: 'Fecha' },
      { id: 'turno', nombre: 'Turno' },
      { id: 'total_personas', nombre: 'Total Personas En El Turno' },
      { id: 'cajas_totales', nombre: 'Total Cajas Movidas' }
    ];
    
    for (const campo of camposObligatorios) {
      const el = document.getElementById(campo.id);
      if (el && !el.value.trim()) {
        alert(`‚ùå Por favor, complete el campo: "${campo.nombre}".`);
        return;
      }
    }
    
    // ‚úÖ PASO 7: Validar nombres por veh√≠culo
    for (let i = 0; i < vehiculosData.length; i++) {
      const vehiculo = vehiculosData[i];
      const totalPersonasVeh = parseInt(vehiculo.personas) || 0;
      if (totalPersonasVeh > 0) {
        const nombresContainer = document.querySelector(`#nombres-personal-${i}`);
        if (nombresContainer) {
          const inputsNombres = nombresContainer.querySelectorAll('input[type="text"]');
          for (let j = 0; j < inputsNombres.length; j++) {
            if (!inputsNombres[j].value.trim()) {
              alert(`‚ùå Por favor, ingrese el nombre del trabajador ${j + 1} del Veh√≠culo #${i + 1}.`);
              inputsNombres[j].focus();
              return;
            }
          }
        }
      }
    }
    
    // ‚úÖ PASO 8: Validar placas y solapamientos
    if (!validarPlacas()) return;
    if (!validarSolapamientoVehiculos() || !validarSolapamientoParadas()) return;
    
    // ‚úÖ PASO 9: Sincronizar productos escaneados con vehiculosData
    sincronizarVehiculosDesdeDOM();
    for (let i = 0; i < vehiculosData.length; i++) {
      if (productosEscaneadosPorVehiculo[i]) {
        const productosArray = Object.entries(productosEscaneadosPorVehiculo[i].productos).map(([codigo, prod]) => ({
          codigo: codigo,
          referencia: prod.referencia,
          nombre: prod.nombre,
          cantidad: prod.cantidad
        }));
        
        vehiculosData[i].productos_escaneados = productosArray;
        vehiculosData[i].total_cajas_escaneadas = productosEscaneadosPorVehiculo[i].totalCajas;
      }
    }
    
    // ‚úÖ PASO 10: Preparar datos para enviar (CORREGIDO)
    const formData = {
      fecha: document.getElementById('fecha').value,
      lugar: document.getElementById('lugar').value,
      lider_asignado: document.getElementById('lider').value.toUpperCase(),
      coordinador: document.getElementById('coordinador').value,
      coordinador_otro: document.getElementById('coordinador_otro').value,
      lider_pepsico: document.getElementById('lider_pepsico').value,
      lider_pepsico_otro: document.getElementById('lider_pepsico_otro').value,
      turno: document.getElementById('turno').value,
      total_personas: document.getElementById('total_personas').value,
      cajas_totales: document.getElementById('cajas_totales').value,
      respo_diligen: document.getElementById('responsable').value,
      datos_vehiculos: vehiculosData.map((v, i) => {
        // ‚úÖ Verificar que tipo_operacion tenga valor
        if (v.tipo_operacion === undefined) {
          console.warn(`‚ö†Ô∏è Veh√≠culo ${i}: tipo_operacion es undefined, corrigiendo a ""`);
          v.tipo_operacion = '';
        }
        // ‚úÖ Incluir novedades
        v.novedades = v.novedades || [];
        // ‚úÖ Incluir justificaciones (AGREGAR ESTA L√çNEA)
        v.justificaciones = v.justificaciones || [];
        // ‚úÖ Incluir tipo_carga
        v.tipo_carga = v.tipo_carga || '';
        return v;
      }),
      datos_paradas_operacion: Array.from(
        document.querySelectorAll('#operacion-contenedor .parada-group')
      ).map(grupo => {
        return {
          inicio: grupo.querySelector(`input[name^="parada_inicio_operacion_"]`)?.value || '',
          fin: grupo.querySelector(`input[name^="parada_fin_operacion_"]`)?.value || '',
          motivo: grupo.querySelector(`select[name^="parada_motivo_operacion_"]`)?.value || '',
          otro_motivo: grupo.querySelector(`input[name^="parada_otro_motivo_operacion_"]`)?.value || ''
        };
      })
    };
    
    console.log('üìù Datos que se enviar√°n a MySQL:');
    console.log('Veh√≠culos:', JSON.stringify(vehiculosData, null, 2));
    
    // ‚úÖ PASO 11: URL CORREGIDA (SIN ESPACIOS)
    const RAILWAY_API_URL = 'https://pepsico-funza-production-b0f5.up.railway.app/api/registro';
    
    // ‚úÖ PASO 12: Mostrar mensaje de carga
    const submitBtn = document.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = 'Enviando...';
    
    // ‚úÖ PASO 13: Enviar a Railway (MySQL)
    fetch(RAILWAY_API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(formData)
    })
    .then(response => {
      if (!response.ok) {
        throw new Error(`Error HTTP: ${response.status}`);
      }
      return response.json();
    })
    .then(result => {
    if (result.success) {
      // ‚úÖ Eliminar datos de localStorage
      localStorage.removeItem('pepsico_data');
      
      // ‚úÖ ENVIAR CORREO CON EMAILJS (ESPERAR A QUE TERMINE)
      enviarCorreoEmailJS(formData)
        .then(() => {
          console.log('‚úÖ Correo enviado, redirigiendo...');
          // ‚úÖ Redirigir SOLO despu√©s de que el correo se env√≠e
          setTimeout(() => {
            window.location.href = 'aceptacion.html';
          }, 1000); // ‚úÖ Peque√±a pausa para asegurar que se env√≠e
        })
        .catch((emailError) => {
          console.error('‚ùå Error al enviar correo:', emailError);
          // ‚úÖ AUNQUE FALL√â EL CORREO, REDIRIGIR (los datos ya se guardaron)
          alert('‚ö†Ô∏è El registro se guard√≥ correctamente, pero hubo un error al enviar el correo.');
          setTimeout(() => {
            window.location.href = 'aceptacion.html';
          }, 1000);
        });
    } else {
      throw new Error(result.error || 'Error desconocido');
    }
  })
    .catch(error => {
      console.error('Error:', error);
      alert('‚ùå Error al guardar: ' + error.message + '\n\nPor favor, int√©ntalo de nuevo.');
      submitBtn.disabled = false;
      submitBtn.textContent = originalText;
    });
  }

  // ‚úÖ ENVIAR CORREO CON EMAILJS (CORREGIDO - PRODUCTOS POR VEH√çCULO)
  function enviarCorreoEmailJS(data) {
    return new Promise((resolve, reject) => {
      try {
        // ‚úÖ VERIFICAR QUE EMAILJS EST√â INICIALIZADO
        if (typeof emailjs === 'undefined') {
          throw new Error('EmailJS no est√° cargado. Verifica el script.');
        }

        // ‚úÖ FORMATEAR VEH√çCULOS COMO TABLA HTML
        let vehiculosHTML = '<table style="width:100%; border-collapse:collapse; margin-top:10px;">';
        vehiculosHTML += '<thead><tr style="background:#001855; color:white;">';
        vehiculosHTML += '<th style="padding:10px; border:1px solid #ddd;">#</th>';
        vehiculosHTML += '<th style="padding:10px; border:1px solid #ddd;">Motivo</th>';
        vehiculosHTML += '<th style="padding:10px; border:1px solid #ddd;">Muelle</th>';
        vehiculosHTML += '<th style="padding:10px; border:1px solid #ddd;">Placa</th>';
        vehiculosHTML += '<th style="padding:10px; border:1px solid #ddd;">Destino</th>';
        vehiculosHTML += '<th style="padding:10px; border:1px solid #ddd;">Cajas</th>';
        vehiculosHTML += '<th style="padding:10px; border:1px solid #ddd;">Tipo Veh√≠culo</th>';
        vehiculosHTML += '</tr></thead><tbody>';
        
        if (data.datos_vehiculos && data.datos_vehiculos.length > 0) {
          data.datos_vehiculos.forEach((v, index) => {
            const muelle = v.muelle === 'otro' ? (v.otro_muelle_num || 'N/A') : (v.muelle || 'N/A');
            const destino = v.destino || v.origen || 'N/A';
            const cajas = v.cajas || v.total_cajas_escaneadas || '0';
            const tipoVehiculo = v.tipo_vehi || 'N/A';
            const motivo = v.motivo ? v.motivo.charAt(0).toUpperCase() + v.motivo.slice(1) : 'N/A';
            
            vehiculosHTML += '<tr style="background:' + (index % 2 === 0 ? '#f8f9fa' : 'white') + ';">';
            vehiculosHTML += '<td style="padding:8px; border:1px solid #ddd; text-align:center;">' + (index + 1) + '</td>';
            vehiculosHTML += '<td style="padding:8px; border:1px solid #ddd;">' + motivo + '</td>';
            vehiculosHTML += '<td style="padding:8px; border:1px solid #ddd; text-align:center;">' + muelle + '</td>';
            vehiculosHTML += '<td style="padding:8px; border:1px solid #ddd; text-align:center;">' + (v.placa || 'N/A') + '</td>';
            vehiculosHTML += '<td style="padding:8px; border:1px solid #ddd;">' + destino + '</td>';
            vehiculosHTML += '<td style="padding:8px; border:1px solid #ddd; text-align:center;">' + cajas + '</td>';
            vehiculosHTML += '<td style="padding:8px; border:1px solid #ddd;">' + tipoVehiculo + '</td>';
            vehiculosHTML += '</tr>';
          });
        } else {
          vehiculosHTML += '<tr><td colspan="7" style="padding:15px; text-align:center; color:#6c757d;">No hay veh√≠culos registrados</td></tr>';
        }
        vehiculosHTML += '</tbody></table>';

        // ‚úÖ FORMATEAR PRODUCTOS COMO TABLA HTML (CON VEH√çCULO IDENTIFICADO)
        let productosHTML = '<table style="width:100%; border-collapse:collapse; margin-top:10px;">';
        productosHTML += '<thead><tr style="background:#001855; color:white;">';
        productosHTML += '<th style="padding:10px; border:1px solid #ddd;">#</th>';
        productosHTML += '<th style="padding:10px; border:1px solid #ddd;">Veh√≠culo</th>';
        productosHTML += '<th style="padding:10px; border:1px solid #ddd;">Placa</th>';
        productosHTML += '<th style="padding:10px; border:1px solid #ddd;">C√≥digo</th>';
        productosHTML += '<th style="padding:10px; border:1px solid #ddd;">Nombre Producto</th>';
        productosHTML += '<th style="padding:10px; border:1px solid #ddd;">Cantidad Cajas</th>';
        productosHTML += '</tr></thead><tbody>';
        
        let productoIndex = 0;
        if (data.datos_vehiculos && data.datos_vehiculos.length > 0) {
          data.datos_vehiculos.forEach((v, vIndex) => {
            // ‚úÖ VERIFICAR SI EL VEH√çCULO TIENE PRODUCTOS ESCANEADOS
            if (v.productos_escaneados && v.productos_escaneados.length > 0) {
              v.productos_escaneados.forEach((prod, pIndex) => {
                productoIndex++;
                const bg = productoIndex % 2 === 0 ? '#f8f9fa' : 'white';
                productosHTML += '<tr style="background:' + bg + ';">';
                productosHTML += '<td style="padding:8px; border:1px solid #ddd; text-align:center;">' + productoIndex + '</td>';
                productosHTML += '<td style="padding:8px; border:1px solid #ddd; text-align:center; font-weight:bold; color:#001855;">' + (vIndex + 1) + '</td>';
                productosHTML += '<td style="padding:8px; border:1px solid #ddd; text-align:center; font-family:monospace;">' + (v.placa || 'N/A') + '</td>';
                productosHTML += '<td style="padding:8px; border:1px solid #ddd; font-family:monospace;">' + (prod.codigo || prod.referencia || 'N/A') + '</td>';
                productosHTML += '<td style="padding:8px; border:1px solid #ddd;">' + (prod.nombre || 'N/A') + '</td>';
                productosHTML += '<td style="padding:8px; border:1px solid #ddd; text-align:center; font-weight:bold; color:#C76E00;">' + (prod.cantidad || '0') + '</td>';
                productosHTML += '</tr>';
              });
            } else {
              // ‚úÖ MOSTRAR FILA CUANDO NO HAY PRODUCTOS PARA ESE VEH√çCULO
              productoIndex++;
              const bg = productoIndex % 2 === 0 ? '#f8f9fa' : 'white';
              productosHTML += '<tr style="background:' + bg + ';">';
              productosHTML += '<td style="padding:8px; border:1px solid #ddd; text-align:center;">' + productoIndex + '</td>';
              productosHTML += '<td style="padding:8px; border:1px solid #ddd; text-align:center; font-weight:bold; color:#001855;">' + (vIndex + 1) + '</td>';
              productosHTML += '<td style="padding:8px; border:1px solid #ddd; text-align:center; font-family:monospace;">' + (v.placa || 'N/A') + '</td>';
              productosHTML += '<td style="padding:8px; border:1px solid #ddd; font-family:monospace; color:#6c757d;" colspan="3">Sin productos escaneados</td>';
              productosHTML += '</tr>';
            }
          });
        }
        if (productoIndex === 0) {
          productosHTML += '<tr><td colspan="6" style="padding:15px; text-align:center; color:#6c757d;">No hay productos escaneados</td></tr>';
        }
        productosHTML += '</tbody></table>';

        // ‚úÖ FUNCI√ìN PARA FORMATEAR TIPO DE NOVEDAD (QUITAR GUIONES Y CAPITALIZAR)
        function formatearTipoNovedad(tipo) {
          if (!tipo) return 'N/A';
          return tipo
            .replace(/_/g, ' ')
            .split(' ')
            .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
            .join(' ');
        }

        // ‚úÖ FORMATEAR NOVEDADES COMO TABLA HTML (CON VEH√çCULO IDENTIFICADO)
        let novedadesHTML = '<table style="width:100%; border-collapse:collapse; margin-top:10px;">';
        novedadesHTML += '<thead><tr style="background:#001855; color:white;">';
        novedadesHTML += '<th style="padding:10px; border:1px solid #ddd;">#</th>';
        novedadesHTML += '<th style="padding:10px; border:1px solid #ddd;">Veh√≠culo</th>';
        novedadesHTML += '<th style="padding:10px; border:1px solid #ddd;">Placa</th>';
        novedadesHTML += '<th style="padding:10px; border:1px solid #ddd;">Tipo Novedad</th>';
        novedadesHTML += '<th style="padding:10px; border:1px solid #ddd;">Descripci√≥n</th>';
        novedadesHTML += '</tr></thead><tbody>';
        
        let novedadIndex = 0;
        if (data.datos_vehiculos && data.datos_vehiculos.length > 0) {
          data.datos_vehiculos.forEach((v, vIndex) => {
            if (v.novedades && v.novedades.length > 0) {
              v.novedades.forEach((nov, nIndex) => {
                novedadIndex++;
                const bg = novedadIndex % 2 === 0 ? '#f8f9fa' : 'white';
                const tipoFormateado = formatearTipoNovedad(nov.tipo);
                novedadesHTML += '<tr style="background:' + bg + ';">';
                novedadesHTML += '<td style="padding:8px; border:1px solid #ddd; text-align:center;">' + novedadIndex + '</td>';
                novedadesHTML += '<td style="padding:8px; border:1px solid #ddd; text-align:center; font-weight:bold; color:#001855;">' + (vIndex + 1) + '</td>';
                novedadesHTML += '<td style="padding:8px; border:1px solid #ddd; text-align:center; font-family:monospace;">' + (v.placa || 'N/A') + '</td>';
                novedadesHTML += '<td style="padding:8px; border:1px solid #ddd; font-weight:bold; color:#C76E00;">' + tipoFormateado + '</td>';
                novedadesHTML += '<td style="padding:8px; border:1px solid #ddd;">' + (nov.descripcion || 'Sin descripci√≥n') + '</td>';
                novedadesHTML += '</tr>';
              });
            }
          });
        }
        if (novedadIndex === 0) {
          novedadesHTML += '<tr><td colspan="5" style="padding:15px; text-align:center; color:#6c757d;">No hay novedades registradas</td></tr>';
        }
        novedadesHTML += '</tbody></table>';

        // ‚úÖ PAR√ÅMETROS PARA LA PLANTILLA DE EMAILJS
        const templateParams = {
          // ‚úÖ INFORMACI√ìN DE REGISTRO (SOLO ESTOS 3 CAMPOS)
          fecha: data.fecha || 'N/A',
          coordinador: data.coordinador || data.coordinador_otro || 'N/A',
          turno: data.turno || 'N/A',
          
          // ‚úÖ TABLAS HTML CON LOS DATOS
          vehiculos_tabla: vehiculosHTML,
          productos_tabla: productosHTML,
          novedades_tabla: novedadesHTML
        };

        console.log('üìß Enviando correo con EmailJS...', templateParams);

        // ‚úÖ ENVIAR CORREO (EMAILJS V3+)
        emailjs.send('service_7fe29nl', 'template_xey3tlm', templateParams)
          .then(function(response) {
            console.log('‚úÖ Correo enviado exitosamente!', response.status, response.text);
            resolve(response);
          })
          .catch(function(error) {
            console.error('‚ùå Error al enviar correo:', error);
            reject(error);
          });

      } catch (error) {
        console.error('‚ùå Error en enviarCorreoEmailJS:', error);
        reject(error);
      }
    });
  }
          

          // ============================================
          // GENERACI√ìN DE CAMPOS DE NOMBRES TOTALES
          // ============================================

          function generarCamposNombres() {
              const totalInput = document.getElementById('total_personas');
              if (!totalInput) return;
              
              const total = parseInt(totalInput.value) || 0;
              const container = document.getElementById('nombres-contenedor');
              if (!container) return;
              
              container.innerHTML = '';
              guardarProgreso();
          }

          // ============================================
          // INICIALIZACI√ìN AL CARGAR LA P√ÅGINA
          // ============================================
  document.addEventListener('DOMContentLoaded', async function() {
    const form = document.querySelector('form');
    const savedData = localStorage.getItem('pepsico_data');

    if (savedData) {
      const data = JSON.parse(savedData);
      const nVehiculos = data._numVehiculos || 1;

      // ‚úÖ PASO 1: Establecer lugar primero
      const lugarGuardado = data.lugar || 'Funza';
      document.getElementById('lugar').value = lugarGuardado;

      // ‚úÖ PASO 2: Limpiar contenedor ANTES de crear veh√≠culos
      document.getElementById('vehiculos-contenedor').innerHTML = '';
      vehiculosData = [];

      // ‚úÖ PASO 3: Crear veh√≠culos
      for (let i = 0; i < nVehiculos; i++) {
        const vObj = {
          inicio: data[`vehiculo_${i}_inicio`] || '',
          fin: data[`vehiculo_${i}_fin`] || '',
          motivo: data[`vehiculo_${i}_motivo`] || '',
          otro_motivo: data[`vehiculo_${i}_otro_motivo`] || '',
          tipo_carga: data[`vehiculo_${i}_tipo_carga`] || '',
          muelle: data[`vehiculo_${i}_muelle`] || '',
          otro_muelle_num: data[`vehiculo_${i}_otro_muelle_num`] || '',
          placa: data[`vehiculo_${i}_placa`] || '',
          tipo_vehi: data[`vehiculo_${i}_tipo_vehi`] || '',
          otro_tipo: data[`vehiculo_${i}_otro_tipo`] || '',
          destino: data[`vehiculo_${i}_destino`] || '',
          otro_destino: data[`vehiculo_${i}_otro_destino`] || '',
          origen: data[`vehiculo_${i}_origen`] || '',
          otro_origen: data[`vehiculo_${i}_otro_origen`] || '',
          personas: data[`vehiculo_${i}_personas`] || '',
          nombres_personal: [],
          cajas: data[`vehiculo_${i}_cajas`] || '',
          justificacion: data[`vehiculo_${i}_justificacion`] || '',
          otro_justificacion: data[`vehiculo_${i}_otro_justificacion`] || '',
          tiempo_muerto_inicio: data[`vehiculo_${i}_tiempo_muerto_inicio`] || '',
          tiempo_muerto_final: data[`vehiculo_${i}_tiempo_muerto_final`] || '',
          foto_url: data[`vehiculo_${i}_foto_url`] || '',
          interior_camion: data[`vehiculo_${i}_interior_camion`] || '',
          estado_carpa: data[`vehiculo_${i}_estado_carpa`] || '',
          olores_extranos: data[`vehiculo_${i}_olores_extranos`] || '',
          objetos_extranos: data[`vehiculo_${i}_objetos_extranos`] || '',
          evidencias_plagas: data[`vehiculo_${i}_evidencias_plagas`] || '',
          estado_suelo: data[`vehiculo_${i}_estado_suelo`] || '',
          aprobado: data[`vehiculo_${i}_aprobado`] || '',
          tipo_operacion: data[`vehiculo_${i}_tipo_operacion`] || ''
        };

        // ‚úÖ Cargar nombres del personal desde localStorage
        for (let j = 1; ; j++) {
          const nombreKey = `vehiculo_${i}_nombre_persona_${j}`;
          if (data[nombreKey] !== undefined) {
            vObj.nombres_personal.push(data[nombreKey]);
          } else {
            break;
          }
        }
        vehiculosData.push(vObj);
        crearVehiculoHTML(document.getElementById('vehiculos-contenedor'), i, vObj);

        // ‚úÖ RESTAURAR FOTO PRINCIPAL DEL VEH√çCULO
        if (vObj.foto_url) {
          const previewFoto = document.getElementById(`preview_foto_${i}`);
          if (previewFoto) {
            previewFoto.innerHTML = `<img src="${vObj.foto_url}" style="max-width: 100%; border-radius: 8px; border: 2px solid #001855; margin-top: 10px;">`;
          }
        }

        // ‚úÖ RESTAURAR LAS 3 FOTOS (INICIO, DURANTE, FIN)
        if (data[`vehiculo_${i}_foto_inicio_url`] || data[`vehiculo_${i}_foto_durante_url`] || data[`vehiculo_${i}_foto_fin_url`]) {
          restaurarFotosVehiculo(i, {
            foto_inicio_url: data[`vehiculo_${i}_foto_inicio_url`] || '',
            foto_durante_url: data[`vehiculo_${i}_foto_durante_url`] || '',
            foto_fin_url: data[`vehiculo_${i}_foto_fin_url`] || ''
          });
        }

        // ‚úÖ Restaurar valor de tipo de operaci√≥n
        if (vObj.tipo_operacion) {
          const tipoOperacionSelect = document.getElementById(`tipo-operacion-${i}`);
          if (tipoOperacionSelect) {
            tipoOperacionSelect.value = vObj.tipo_operacion;
          }
        }

        // ‚úÖ RESTAURAR JUSTIFICACIONES POR VEH√çCULO
        const justificacionesContenedor = document.getElementById(`justificaciones-contenedor-${i}`);
        if (justificacionesContenedor && data[`_justificaciones_${i}`]) {
          justificacionesContenedor.innerHTML = '';

          // ‚úÖ LOG DE DEPURACI√ìN
          console.log(`üì• Restaurando justificaciones Veh√≠culo ${i}:`, data[`_justificaciones_${i}`]);

          data[`_justificaciones_${i}`].forEach((justificacion, jIndex) => {
            const div = document.createElement('div');
            div.className = 'justificacion-group';
            div.dataset.index = jIndex;

            const botonEliminar = document.createElement('button');
            botonEliminar.type = 'button';
            botonEliminar.className = 'btn-eliminar';
            botonEliminar.textContent = 'Eliminar';
            botonEliminar.onclick = function() {
              div.remove();
              guardarProgreso();
            };

            const dInicio = `muerto-inicio-${i}-${jIndex}`;
            const dFin = `muerto-final-${i}-${jIndex}`;

            // ‚úÖ USAR EXACTAMENTE LOS MISMOS NOMBRES QUE EN guardarProgreso()
            const motivoValor = justificacion.justificacion || '';
            const otroMotivoValor = justificacion.otro_justificacion || '';
            const tiempoInicioValor = justificacion.tiempo_muerto_inicio || '';
            const tiempoFinValor = justificacion.tiempo_muerto_final || '';

            div.innerHTML = `
              <div class="time-row">
                <div>
                  <label class="time-label">Tiempo Muerto Inicio:</label>
                  <input type="tel" name="vehiculo_${i}_tiempo_muerto_inicio_${jIndex}" class="time-input-masked"
                      placeholder="HH:MM" maxlength="5" value="${tiempoInicioValor}"
                      onblur="applyTimeMask(this, '${dInicio}')">
                  <span id="${dInicio}" class="time-display"></span>
                </div>
                <div>
                  <label class="time-label">Tiempo Muerto Final:</label>
                  <input type="tel" name="vehiculo_${i}_tiempo_muerto_final_${jIndex}" class="time-input-masked"
                      placeholder="HH:MM" maxlength="5" value="${tiempoFinValor}"
                      onblur="applyTimeMask(this, '${dFin}')">
                  <span id="${dFin}" class="time-display"></span>
                </div>
              </div>
              <label>Motivo:</label>
              <select name="vehiculo_${i}_justificacion_${jIndex}" id="justificacion-select-${i}-${jIndex}">
                <option value="">Seleccione motivo</option>
                <option value="faltante_producto" ${motivoValor === 'faltante_producto' ? 'selected' : ''}>Faltante de producto</option>
                <option value="liberacion_calidad" ${motivoValor === 'liberacion_calidad' ? 'selected' : ''}>Liberacion de calidad</option>
                <option value="Da√±os" ${motivoValor === 'Da√±os' ? 'selected' : ''}>Da√±os (electricos, muelle, montacargas, etc.)</option>
                <option value="otro" ${motivoValor === 'otro' ? 'selected' : ''}>Otro</option>
              </select>
              <input type="text" name="vehiculo_${i}_otro_justificacion_${jIndex}" placeholder="Especifique la incidencia" class="otro-input" 
                    value="${otroMotivoValor}" 
                    style="${motivoValor === 'otro' ? 'display: block;' : 'display: none;'}">
            `;

            div.appendChild(botonEliminar);
            justificacionesContenedor.appendChild(div);

            // ‚úÖ Configurar eventos DESPU√âS de a√±adir al DOM
            const motivoSelect = div.querySelector(`#justificacion-select-${i}-${jIndex}`);
            const otroInput = div.querySelector(`input[name="vehiculo_${i}_otro_justificacion_${jIndex}"]`);

            if (motivoSelect && otroInput) {
              motivoSelect.addEventListener('change', function() {
                if (this.value === 'otro') {
                  otroInput.style.display = 'block';
                  otroInput.required = true;
                } else {
                  otroInput.style.display = 'none';
                  otroInput.required = false;
                  otroInput.value = '';
                }
                guardarProgreso();
              });
            }
          });
        }

        // ‚úÖ RESTAURAR NOVEDADES POR VEH√çCULO
        const novedadesContenedor = document.getElementById(`novedades-contenedor-${i}`);
        if (novedadesContenedor && data[`_novedades_${i}`]) {
          novedadesContenedor.innerHTML = '';

          // ‚úÖ LOG DE DEPURACI√ìN
          console.log(`üì• Restaurando novedades Veh√≠culo ${i}:`, data[`_novedades_${i}`]);

          data[`_novedades_${i}`].forEach((novedad, nIndex) => {
            const div = document.createElement('div');
            div.className = 'novedad-group';
            div.dataset.index = nIndex;

            const botonEliminar = document.createElement('button');
            botonEliminar.type = 'button';
            botonEliminar.className = 'btn-eliminar';
            botonEliminar.textContent = 'Eliminar';
            botonEliminar.onclick = function() {
              div.remove();
              guardarProgreso();
            };

            // ‚úÖ USAR EXACTAMENTE LOS MISMOS NOMBRES QUE EN guardarProgreso()
            const tipoValor = novedad.tipo || '';
            const descripcionValor = novedad.descripcion || '';
            const fotoUrlValor = novedad.foto_url || '';

            div.innerHTML = `
              <label>Tipo de Novedad:</label>
              <select name="vehiculo_${i}_tipo_novedad_${nIndex}">
                <option value="">Seleccione tipo</option>
                <option value="cajas_rotas" ${tipoValor === 'cajas_rotas' ? 'selected' : ''}>Cajas rotas</option>
                <option value="faltante_producto" ${tipoValor === 'faltante_producto' ? 'selected' : ''}>Faltante de producto</option>
                <option value="sobrante_producto" ${tipoValor === 'sobrante_producto' ? 'selected' : ''}>Sobrante de producto</option>
                <option value="estibas_malas" ${tipoValor === 'estibas_malas' ? 'selected' : ''}>Estibas malas</option>
                <option value="otro" ${tipoValor === 'otro' ? 'selected' : ''}>Otro</option>
              </select>

              <label>Descripci√≥n:</label>
              <textarea name="vehiculo_${i}_descripcion_novedad_${nIndex}" placeholder="Describa la novedad">${descripcionValor}</textarea>

              <label>Foto de la Novedad:</label>
              <div class="preview-foto" style="margin-top: 10px;">
                ${fotoUrlValor ? `<img src="${fotoUrlValor}" style="max-width: 100%; border-radius: 5px; border: 2px solid #001855;">` : ''}
              </div>
              <input type="hidden" name="vehiculo_${i}_foto_novedad_${nIndex}_url" value="${fotoUrlValor}">
            `;

            div.appendChild(botonEliminar);
            novedadesContenedor.appendChild(div);
          });
        }
      }

      // ‚úÖ PASO 4: Poblar muelles DESPU√âS de crear los veh√≠culos
      actualizarMuellesPorLugar();

      // ‚úÖ PASO 5: Restaurar valores de muelle
      for (let i = 0; i < nVehiculos; i++) {
        const muelleSelect = document.getElementById(`muelle-select-${i}`);
        if (muelleSelect && vehiculosData[i].muelle) {
          muelleSelect.value = vehiculosData[i].muelle;
          manejarOtroMuelle(i);
        }
      }

      // ‚úÖ RESTAURAR PARADAS DE OPERACI√ìN
      const operacionContenedor = document.getElementById('operacion-contenedor');
      if (operacionContenedor) {
        operacionContenedor.innerHTML = '';

        if (data._paradasDetalle && data._paradasDetalle.length > 0) {
          data._paradasDetalle.forEach((parada, index) => {
            agregarCampoParada('operacion', {
              inicio: parada.inicio,
              fin: parada.fin,
              motivo: parada.motivo,
              otro_motivo: parada.otro_motivo
            });
          });
        }
      }

      // ‚úÖ RESTAURAR OTROS CAMPOS DEL FORMULARIO
      for (const key in data) {
        if (key.startsWith('_') || key.startsWith('vehiculo_') || key.startsWith('parada_')) continue;
        const el = form.elements[key];
        if (el) {
          el.value = data[key];
          if (el.id === 'coordinador') manejarOtroCoordinador();
        }
      }

      actualizarTotalCajas();

      // ‚úÖ Cargar productos escaneados desde localStorage
      if (data._productosEscaneados) {
        productosEscaneadosPorVehiculo = data._productosEscaneados;
        Object.keys(productosEscaneadosPorVehiculo).forEach(vIndex => {
          mostrarResumenProductos(parseInt(vIndex));
        });
      }

      await cargarBaseDatosProductos();
      generarCamposNombres();
    } else {
      agregarRegistroVehiculo();
      agregarCampoParada('operacion');
      actualizarCampos();
      actualizarMuellesPorLugar();
      await cargarBaseDatosProductos();
      cargarProductosEscaneados();
    }

    form.addEventListener('submit', enviarFormulario);
    form.addEventListener('input', guardarProgreso);
    form.addEventListener('change', guardarProgreso);

    document.getElementById('lider_pepsico').addEventListener('change', function() {
      this.dataset.manualChange = 'true';
    });
  });
      </script>

      <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
      <script>
        // ‚úÖ INICIALIZAR EMAILJS (ejecutar cuando cargue la p√°gina)
        (function() {
          // ‚ö†Ô∏è REEMPLAZA CON TU PUBLIC KEY DE EMAILJS
          emailjs.init("phGvKdtm9DCeZFCcE");
        })();
      </script>
      
  </body>
